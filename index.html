<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>D-SERVE ‡πÅ‡∏à‡πâ‡∏á‡∏¢‡∏≠‡∏î‡∏ô‡∏≠‡∏Å‡∏£‡∏≠‡∏ö</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- QR Scanner (removed) -->
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Prompt', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 12px;
      padding-bottom: 20px;
    }
    
    .container { max-width: 400px; margin: 0 auto; }
    
    /* Header */
    .header {
      text-align: center;
      padding: 6px 0 10px;
      color: #fff;
    }
    .header h1 { font-size: 1rem; font-weight: 600; }
    
    /* Profile */
    .profile-box {
      background: rgba(255,255,255,0.12);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 10px;
      border: 1px solid rgba(255,255,255,0.15);
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
    }

    .profile-img {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid rgba(255,255,255,0.3);
      flex-shrink: 0;
    }

    .profile-info { flex: 1; min-width: 0; }

    .profile-row1 {
      font-size: 0.8rem;
      color: #fff;
      font-weight: 700;
      letter-spacing: 0.3px;
    }

    .profile-row2 {
      font-size: 0.7rem;
      color: rgba(255,255,255,0.75);
      margin-top: 2px;
    }

    .profile-row3Phone {
      font-size: 0.65rem;
      color: rgba(255,255,255,0.6);
      margin-top: 2px;
    }

    .profile-row4 {
      font-size: 0.6rem;
      color: rgba(255,255,255,0.5);
      margin-top: 2px;
    }

    .profile-bank {
      flex-shrink: 0;
      text-align: right;
      min-width: 100px;
      background: rgba(255,255,255,0.06);
      border-radius: 8px;
      padding: 8px 10px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .profile-bank-label {
      color: rgba(255,255,255,0.5);
      font-size: 0.55rem;
      margin-bottom: 3px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .profile-bank-value {
      color: #4ecdc4;
      font-weight: 700;
      font-size: 0.75rem;
      line-height: 1.3;
    }
    .profile-gear-btn {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.15);
      color: rgba(255,255,255,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 0.7rem;
    }
    .profile-gear-btn:active {
      background: rgba(255,255,255,0.2);
    }
    .scb-logo-mini {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      background: #4E2A84;
      border-radius: 4px;
      padding: 2px 6px;
    }
    .scb-logo-mini span {
      color: #fff;
      font-size: 0.55rem;
      font-weight: 800;
      letter-spacing: 0.5px;
    }
    .scb-logo-mini .scb-leaf {
      color: #FFB81C;
      font-size: 0.6rem;
    }

    /* Status Options (Card Status Modal) */
    .status-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }
    .status-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background: rgba(255,255,255,0.08);
      border-radius: 8px;
      color: #fff;
      font-size: 0.85rem;
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.15);
      transition: all 0.2s;
    }
    .status-option:has(input:checked) {
      background: rgba(78,205,196,0.2);
      border-color: #4ecdc4;
    }
    .status-option input[type="radio"] {
      width: 16px;
      height: 16px;
      accent-color: #4ecdc4;
    }
    .status-modal-card {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      margin-bottom: 4px;
    }
    .status-modal-card img {
      width: 60px;
      height: 40px;
      border-radius: 6px;
      object-fit: cover;
    }
    .status-modal-card-info {
      flex: 1;
      font-size: 0.8rem;
      color: #fff;
    }

    /* Section */
    .section-box {
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 8px;
      margin-bottom: 8px;
    }
    
    .section-title {
      font-size: 0.65rem;
      color: rgba(255,255,255,0.7);
      margin-bottom: 6px;
    }
    
    /* Bank Grid - 4 per row */
    .bank-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 5px;
    }
    
    .bank-btn {
      padding: 8px 4px;
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 6px;
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-size: 0.7rem;
      font-weight: 600;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .bank-btn:hover { background: rgba(255,255,255,0.2); }
    .bank-btn.selected { background: rgba(0,208,132,0.3); border-color: #00d084; }
    .bank-btn.bank-btn-gray { opacity: 0.35; text-decoration: line-through; }
    .bank-btn.bank-btn-gray:hover { opacity: 0.6; }
    .bank-btn.bank-btn-gray.selected { opacity: 1; background: rgba(0,208,132,0.3); border-color: #00d084; text-decoration: none; }
    
    /* Card Grid - 3 per row ‚≠ê COMPACT */
    .card-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }
    
    .card-btn {
      position: relative;
      aspect-ratio: 1.5; /* ‚≠ê ‡πÅ‡∏ö‡∏ô‡∏•‡∏á‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ */
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      background-color: rgba(255,255,255,0.1);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      cursor: pointer;
      transition: all 0.2s;
      overflow: hidden;
    }
    
    .card-btn:hover { 
      border-color: rgba(255,255,255,0.5);
      transform: scale(1.02);
    }
    
    .card-btn.selected { 
      border-color: #00d084; 
      box-shadow: 0 0 0 1px rgba(0,208,132,0.5);
    }
    
    /* Overlay - ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡∏≤‡∏á‡∏£‡∏π‡∏õ ‚≠ê COMPACT */
    .card-btn .card-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      background: rgba(0,0,0,0.45);
      padding: 2px;
    }
    
    .card-btn .card-name {
      font-size: 0.55rem;
      color: #fff;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 95%;
      text-shadow: 0 1px 2px rgba(0,0,0,0.9);
    }
    
    .card-btn .card-last4 {
      font-size: 0.8rem;
      color: #fff;
      font-weight: 700;
      letter-spacing: 1px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.9);
      margin-top: 1px;
    }

    .card-btn .card-owner {
      font-size: 0.45rem;
      color: rgba(255,255,255,0.75);
      font-weight: 400;
      text-shadow: 0 1px 2px rgba(0,0,0,0.9);
      margin-top: 1px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 95%;
    }

    /* ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ */
    .card-btn.no-image {
      background: linear-gradient(135deg, #3a3a5c 0%, #2a2a4c 100%);
    }
    
    .card-btn.no-image .card-overlay {
      background: transparent;
    }
    
    /* ‚≠ê ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ö‡∏±‡∏ï‡∏£ */
    .card-btn .card-bg-img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 6px;
    }
    
    /* ‚≠ê Checkmark overlay ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */
    .card-btn .check-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 208, 132, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 0.2s;
      border-radius: 6px;
      z-index: 10;
    }
    
    .card-btn .check-overlay::after {
      content: '‚úì';
      font-size: 1.8rem;
      color: #fff;
      font-weight: bold;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .card-btn.selected .check-overlay {
      opacity: 1;
    }
    
    /* ‚≠ê ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ï‡∏£ - COMPACT */
    .add-card-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      border: 2px dashed rgba(255,255,255,0.4);
      border-radius: 8px;
      background: rgba(255,255,255,0.05);
      color: rgba(255,255,255,0.8);
      font-size: 0.65rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 50px;
    }
    .add-card-btn:hover {
      background: rgba(0,208,132,0.2);
      border-color: #00d084;
      color: #fff;
    }
    .add-card-btn.span-2 { grid-column: span 2; }
    .add-card-btn.span-3 { grid-column: span 3; }
    
    /* ‚≠ê Badge ‡πÉ‡∏´‡∏°‡πà ‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö - COMPACT */
    .card-btn .new-badge {
      position: absolute;
      top: 2px;
      left: 2px;
      background: #00d084;
      color: #fff;
      font-size: 0.45rem;
      font-weight: 700;
      padding: 1px 3px;
      border-radius: 3px;
      z-index: 15;
    }
    .card-btn .delete-btn {
      position: absolute;
      top: 1px;
      right: 1px;
      width: 16px;
      height: 16px;
      background: rgba(255,0,0,0.8);
      color: #fff;
      border: none;
      border-radius: 50%;
      font-size: 0.6rem;
      cursor: pointer;
      z-index: 15;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .card-btn .delete-btn:hover { background: #ff0000; }
    
    /* ‚≠ê Modal ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ï‡∏£ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 16px;
    }
    .modal-overlay.hidden { display: none; }
    
    .modal-box {
      background: linear-gradient(135deg, #4a4a6a 0%, #3a3a5c 100%);
      border-radius: 16px;
      width: 100%;
      max-width: 360px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.4);
    }
    
    .modal-header {
      padding: 12px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-size: 0.9rem;
      font-weight: 600;
      color: #fff;
      text-align: center;
    }
    
    .modal-body { padding: 12px; }
    
    .modal-label {
      font-size: 0.7rem;
      color: rgba(255,255,255,0.7);
      margin-bottom: 6px;
    }
    
    .modal-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    
    /* ‚≠ê ‡∏ö‡∏ô‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å ‡πÉ‡∏´‡πâ input ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà */
    @media (max-width: 360px) {
      .modal-row {
        flex-direction: column;
        align-items: stretch;
      }
      .modal-row .modal-label { margin-bottom: 4px; }
      .modal-input-sm { width: 100%; }
    }
    
    .modal-select {
      flex: 1;
      padding: 8px 10px;
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-size: 0.8rem;
      font-family: 'Prompt', sans-serif;
    }
    .modal-select option { background: #3a3a5c; color: #fff; }
    
    .modal-input {
      flex: 1;
      padding: 8px 10px;
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-size: 0.85rem;
      font-family: 'Prompt', sans-serif;
    }
    .modal-input::placeholder { color: rgba(255,255,255,0.4); }
    .modal-input:focus { outline: none; border-color: #00d084; }
    
    .modal-input-sm { width: 80px; flex: none; text-align: center; letter-spacing: 2px; }
    
    /* Modal Card Type Grid */
    .modal-card-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      margin-bottom: 10px;
      max-height: 180px;
      overflow-y: auto;
    }
    
    .modal-card-btn {
      position: relative;
      aspect-ratio: 1.586;
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      background-size: cover;
      background-position: center;
      cursor: pointer;
      overflow: hidden;
      transition: all 0.2s;
    }
    .modal-card-btn.no-image {
      background: linear-gradient(135deg, #3a3a5c 0%, #2a2a4c 100%);
    }
    .modal-card-btn:hover { border-color: rgba(255,255,255,0.5); }
    .modal-card-btn.selected { border-color: #00d084; box-shadow: 0 0 0 2px rgba(0,208,132,0.5); }
    .modal-card-btn.disabled { opacity: 0.3; pointer-events: none; }
    
    .modal-card-btn .card-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 4px;
    }
    .modal-card-btn .card-name {
      font-size: 0.55rem;
      color: #fff;
      font-weight: 600;
      text-align: center;
      text-shadow: 0 1px 2px rgba(0,0,0,0.8);
    }
    .modal-card-btn .check-mark {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.5rem;
      color: #00d084;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
      display: none;
    }
    .modal-card-btn.selected .check-mark { display: block; }
    .modal-card-btn.selected .card-overlay { background: rgba(0,208,132,0.5); }
    
    /* Modal Suggest Buttons */
    .modal-suggest {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .modal-suggest-btn {
      padding: 4px 8px;
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 6px;
      background: rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.8);
      font-size: 0.6rem;
      cursor: pointer;
      transition: all 0.2s;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex: 0 1 auto;
    }
    .modal-suggest-btn:hover { background: rgba(0,208,132,0.3); border-color: #00d084; }
    
    /* ‚≠ê ‡∏ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡∏ß ‡πÉ‡∏´‡πâ‡∏¢‡πà‡∏≠ */
    @media (max-width: 400px) {
      .modal-suggest-btn {
        max-width: 45%;
      }
    }
    
    /* Modal Footer */
    .modal-footer {
      display: flex;
      gap: 10px;
      padding: 12px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    .modal-btn {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Prompt', sans-serif;
    }
    .modal-btn-cancel {
      background: rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.8);
    }
    .modal-btn-confirm {
      background: #00d084;
      color: #fff;
    }
    .modal-btn-confirm:disabled {
      background: rgba(255,255,255,0.2);
      color: rgba(255,255,255,0.4);
      cursor: not-allowed;
    }
    
    /* Amount Section */
    .amount-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .toggle-same {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.7rem;
      color: rgba(255,255,255,0.9);
      cursor: pointer;
    }
    
    .toggle-same input {
      width: 16px;
      height: 16px;
      accent-color: #00d084;
    }
    
    /* Quick Amount - Bigger */
    .quick-btns {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    
    .quick-btn {
      flex: 1;
      padding: 12px 8px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 10px;
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .quick-btn:hover { background: rgba(0,208,132,0.3); border-color: #00d084; }
    
    /* Global Amount (Toggle ON) */
    .global-amount-box {
      background: rgba(0,208,132,0.2);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 10px;
    }
    
    .global-amount-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .global-amount-row label {
      font-size: 0.8rem;
      color: #fff;
      white-space: nowrap;
    }
    
    .amount-input {
      flex: 1;
      padding: 12px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 8px;
      background: rgba(255,255,255,0.15);
      color: #fff;
      font-size: 1.1rem;
      text-align: right;
      font-family: 'Prompt', sans-serif;
    }
    
    .amount-input:focus { outline: none; border-color: #00d084; }
    .amount-input::placeholder { color: rgba(255,255,255,0.4); }
    
    .currency { color: rgba(255,255,255,0.8); font-size: 0.9rem; }
    
    /* Selected Cards Display (Toggle ON) */
    .selected-cards-display {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
    }
    
    .selected-card-tag {
      background: rgba(0,208,132,0.2);
      border: 1px solid rgba(0,208,132,0.4);
      border-radius: 8px;
      padding: 8px;
      text-align: center;
    }
    
    .selected-card-tag .name {
      font-size: 0.75rem;
      color: #fff;
      font-weight: 600;
    }
    
    .selected-card-tag .owner {
      font-size: 0.65rem;
      color: rgba(255,255,255,0.7);
    }
    
    /* Amount Grid (Toggle OFF) - 2 per row */
    .amount-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
    }
    
    .amount-grid.has-odd-last > .amount-card:last-child:nth-child(odd) {
      grid-column: 1 / -1;
    }
    
    .amount-card {
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      padding: 8px;
      min-width: 0;
    }
    
    .amount-card .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 6px;
    }
    
    .amount-card .card-info {
      min-width: 0;
      flex: 1;
    }
    
    .amount-card .card-info .name {
      font-size: 0.75rem;
      color: #fff;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .amount-card .card-info .owner {
      font-size: 0.6rem;
      color: rgba(255,255,255,0.6);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .remove-btn {
      background: rgba(255,100,100,0.3);
      border: none;
      color: #ff6b6b;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 0.8rem;
      line-height: 1;
      flex-shrink: 0;
      margin-left: 4px;
    }
    
    .amount-card .amount-row {
      position: relative;
    }
    
    .amount-card .amount-input {
      width: 100%;
      padding: 10px 35px 10px 10px;
      font-size: 0.95rem;
      text-align: right;
    }
    
    .amount-card .currency {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.75rem;
      color: rgba(255,255,255,0.6);
      pointer-events: none;
    }
    
    /* Date */
    .date-row {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
    }
    
    .date-btn {
      flex: 1;
      padding: 10px;
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      background: transparent;
      color: #fff;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .date-btn.selected { background: rgba(0,208,132,0.3); border-color: #00d084; }
    
    /* Shop */
    .shop-suggestions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    
    .shop-btn {
      padding: 8px 14px;
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 16px;
      background: transparent;
      color: #fff;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .shop-btn:hover, .shop-btn.selected { background: rgba(0,208,132,0.3); border-color: #00d084; }
    
    .shop-input {
      width: 100%;
      padding: 10px;
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-size: 0.85rem;
      font-family: 'Prompt', sans-serif;
    }
    
    .shop-input::placeholder { color: rgba(255,255,255,0.4); }
    .shop-input:focus { outline: none; border-color: #00d084; }
    
    /* Submit */
    .submit-btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 12px;
      background: linear-gradient(135deg, #00d084, #00b894);
      color: #fff;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Prompt', sans-serif;
      transition: all 0.2s;
    }
    
    .submit-btn:hover { transform: translateY(-1px); }
    .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .load-cards-btn {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(135deg, #00d084, #00b894);
      color: #fff;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Prompt', sans-serif;
    }
    
    /* Loading */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .loading-overlay.hidden { display: none; }
    
    .loading-content { text-align: center; color: #fff; }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255,255,255,0.3);
      border-top-color: #00d084;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 12px;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes toastIn { from { opacity:0; transform:scale(0.8); } to { opacity:1; transform:scale(1); } }
    @keyframes toastOut { from { opacity:1; transform:scale(1); } to { opacity:0; transform:scale(0.8); } }
    
    /* Error */
    .error-box {
      background: rgba(255,100,100,0.2);
      border: 1px solid rgba(255,100,100,0.4);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    
    .error-box .icon { font-size: 2rem; margin-bottom: 10px; }
    .error-box .title { font-size: 1rem; color: #fff; font-weight: 600; margin-bottom: 5px; }
    .error-box .message { font-size: 0.8rem; color: rgba(255,255,255,0.8); }
    
    /* Success */
    .success-box {
      background: rgba(0,208,132,0.2);
      border: 1px solid rgba(0,208,132,0.4);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    
    .success-box .icon { font-size: 2.5rem; margin-bottom: 10px; }
    .success-box .title { font-size: 1.1rem; color: #fff; font-weight: 600; margin-bottom: 10px; }
    
    .success-summary {
      text-align: left;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      padding: 12px;
      margin: 10px 0;
    }
    
    .success-summary .item {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      font-size: 0.8rem;
      color: rgba(255,255,255,0.9);
    }
    
    .success-summary .total {
      border-top: 1px solid rgba(255,255,255,0.2);
      margin-top: 8px;
      padding-top: 8px;
      font-weight: 600;
    }
    
    .btn-group {
      display: flex;
      gap: 8px;
      margin-top: 15px;
    }
    
    .btn-secondary {
      flex: 1;
      padding: 12px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 10px;
      background: transparent;
      color: #fff;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Prompt', sans-serif;
    }
    
    /* Speed indicator */
    .speed-badge {
      display: inline-block;
      padding: 2px 8px;
      background: rgba(0,208,132,0.3);
      border-radius: 10px;
      font-size: 0.6rem;
      color: #00d084;
      margin-left: 8px;
    }
    
    /* Profile row3 - card count + toggle */
    .profile-row3 {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 6px;
      font-size: 0.65rem;
    }
    .profile-row3 #cardCount {
      color: rgba(255,255,255,0.7);
    }
    .toggle-unavail {
      display: flex;
      align-items: center;
      gap: 4px;
      color: rgba(255,255,255,0.8);
      cursor: pointer;
      font-size: 0.65rem;
    }
    .toggle-unavail input {
      width: 14px;
      height: 14px;
      accent-color: #ff6b6b;
    }

    /* ‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà ‚Äî ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏™‡∏µ‡πÅ‡∏î‡∏á */
    .card-btn.unavailable .card-name { color: #ff6b6b; }
    .card-btn.unavailable .card-last4 { color: #ff6b6b; }
    .card-btn.unavailable .card-owner { color: #ff6b6b; }
    .card-btn.unavailable .card-overlay { background: rgba(80,0,0,0.55); }

    /* Badge "üö®‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà" */
    .card-btn .unavail-badge {
      position: absolute;
      top: 2px;
      left: 2px;
      background: #d32f2f;
      color: #fff;
      font-size: 0.4rem;
      font-weight: 700;
      padding: 1px 3px;
      border-radius: 3px;
      z-index: 15;
      white-space: nowrap;
    }

    /* ===== Tab Bar ===== */
    .tab-bar {
      display: flex;
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      padding: 3px;
      margin-bottom: 10px;
      gap: 3px;
    }
    .tab-btn {
      flex: 1;
      padding: 8px 4px;
      border: none;
      border-radius: 8px;
      background: transparent;
      color: rgba(255,255,255,0.6);
      font-size: 0.7rem;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Prompt', sans-serif;
      transition: all 0.2s;
    }
    .tab-btn.active {
      background: rgba(255,255,255,0.2);
      color: #fff;
    }
    .tab-content.hidden { display: none !important; }

    /* ===== Tab placeholder ===== */
    .tab-placeholder {
      text-align: center;
      color: rgba(255,255,255,0.5);
      font-size: 0.85rem;
      padding: 40px 20px;
    }

    /* ===== Tab 1: Card Status ===== */
    .status-toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 0.7rem;
      color: rgba(255,255,255,0.7);
    }
    .status-toggle-row label {
      display: flex;
      align-items: center;
      gap: 4px;
      color: rgba(255,255,255,0.8);
      cursor: pointer;
    }
    .status-toggle-row input[type="checkbox"] {
      width: 14px; height: 14px;
      accent-color: #ff6b6b;
    }
    .status-card-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .status-card-item {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .status-card-item:hover {
      background: rgba(255,255,255,0.15);
      border-color: rgba(255,255,255,0.2);
    }
    .status-card-img {
      width: 48px; height: 30px;
      border-radius: 4px;
      object-fit: cover;
      flex-shrink: 0;
      background: rgba(0,0,0,0.2);
    }
    .status-card-info { flex: 1; min-width: 0; }
    .status-card-name {
      font-size: 0.75rem;
      color: #fff;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .status-card-sub {
      font-size: 0.6rem;
      color: rgba(255,255,255,0.6);
      margin-top: 1px;
    }
    .status-badge {
      font-size: 0.55rem;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 8px;
      white-space: nowrap;
    }
    .status-badge.available {
      background: rgba(16,185,129,0.25);
      color: #34d399;
    }
    .status-badge.unavailable {
      background: rgba(239,68,68,0.25);
      color: #f87171;
    }
    /* Card Status unavailable item */
    .status-card-item.unavail .status-card-name { color: #f87171; }
    .status-card-item.unavail .status-card-sub { color: rgba(248,113,113,0.7); }

    /* Card Detail Panel */
    .card-detail-panel {
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 12px;
      margin-top: 8px;
      border: 1px solid rgba(255,255,255,0.15);
    }
    .card-detail-panel .detail-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .card-detail-panel .detail-img {
      width: 80px; height: 50px;
      border-radius: 6px;
      object-fit: cover;
      background: rgba(0,0,0,0.2);
    }
    .card-detail-panel .detail-title {
      font-size: 0.85rem;
      color: #fff;
      font-weight: 600;
    }
    .card-detail-panel .detail-sub {
      font-size: 0.7rem;
      color: rgba(255,255,255,0.6);
      margin-top: 2px;
    }
    .card-detail-panel .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-top: 1px solid rgba(255,255,255,0.08);
      font-size: 0.7rem;
    }
    .card-detail-panel .detail-label { color: rgba(255,255,255,0.5); }
    .card-detail-panel .detail-value { color: #fff; font-weight: 500; }
    .card-detail-panel .detail-actions {
      margin-top: 10px;
      display: flex;
      gap: 8px;
    }
    .card-detail-panel .detail-btn {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 8px;
      font-size: 0.7rem;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Prompt', sans-serif;
    }
    .card-detail-panel .detail-btn-primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
    }
    .card-detail-panel .detail-btn-close {
      background: rgba(255,255,255,0.15);
      color: rgba(255,255,255,0.8);
    }
    .card-detail-panel .pending-note {
      margin-top: 8px;
      background: rgba(245,158,11,0.2);
      color: #fbbf24;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 0.65rem;
      text-align: center;
    }

    /* ===== Tab 2: Return Card ===== */
    .return-card-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 10px;
    }
    .return-card-item {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 8px 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .return-card-item.selected {
      border-color: #00d084;
      background: rgba(0,208,132,0.15);
    }
    .return-card-item input[type="checkbox"] {
      width: 16px; height: 16px;
      accent-color: #00d084;
      flex-shrink: 0;
    }
    .return-card-item .rc-info { flex: 1; min-width: 0; }
    .return-card-item .rc-type {
      font-size: 0.75rem;
      color: #fff;
      font-weight: 600;
    }
    .return-card-item .rc-name {
      font-size: 0.6rem;
      color: rgba(255,255,255,0.6);
    }
    .return-select-all {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 12px;
      background: rgba(0,208,132,0.2);
      color: #00d084;
      border: none;
      border-radius: 12px;
      font-size: 0.65rem;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 8px;
      font-family: 'Prompt', sans-serif;
    }
    /* Delivery options */
    .delivery-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .delivery-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 10px;
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .delivery-item.selected {
      border-color: #00d084;
      background: rgba(0,208,132,0.1);
    }
    .delivery-item input[type="radio"] {
      width: 16px; height: 16px;
      accent-color: #00d084;
      margin-top: 2px;
      flex-shrink: 0;
    }
    .delivery-info { flex: 1; }
    .delivery-title {
      font-size: 0.75rem;
      color: #fff;
      font-weight: 600;
    }
    .delivery-desc {
      font-size: 0.6rem;
      color: rgba(255,255,255,0.5);
      margin-top: 2px;
    }
    .delivery-badge-free {
      display: inline-block;
      background: rgba(16,185,129,0.3);
      color: #34d399;
      font-size: 0.5rem;
      padding: 1px 6px;
      border-radius: 8px;
      margin-left: 4px;
    }
    .delivery-badge-paid {
      display: inline-block;
      background: rgba(245,158,11,0.3);
      color: #fbbf24;
      font-size: 0.5rem;
      padding: 1px 6px;
      border-radius: 8px;
      margin-left: 4px;
    }
    /* Pickup section */
    .pickup-box {
      background: rgba(245,158,11,0.15);
      border: 1px solid rgba(245,158,11,0.3);
      border-radius: 8px;
      padding: 10px;
      margin-top: 8px;
    }
    .pickup-label {
      font-size: 0.7rem;
      color: #fbbf24;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .pickup-date-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-bottom: 8px;
    }
    .pickup-date-item {
      text-align: center;
      padding: 6px 2px;
      background: rgba(255,255,255,0.1);
      border: 2px solid transparent;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .pickup-date-item.selected {
      border-color: #fbbf24;
      background: rgba(245,158,11,0.2);
    }
    .pickup-date-item .pd-day {
      font-size: 0.55rem;
      color: rgba(255,255,255,0.5);
    }
    .pickup-date-item .pd-num {
      font-size: 0.75rem;
      color: #fff;
      font-weight: 600;
    }
    .pickup-time-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .pickup-time-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 10px;
      background: rgba(255,255,255,0.1);
      border: 2px solid transparent;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.7rem;
      color: #fff;
    }
    .pickup-time-item.selected {
      border-color: #fbbf24;
      background: rgba(245,158,11,0.2);
    }
    .pickup-time-item input[type="radio"] {
      width: 14px; height: 14px;
      accent-color: #fbbf24;
    }
    /* Address form (return) */
    .return-form-group {
      margin-bottom: 8px;
    }
    .return-form-group label {
      display: block;
      font-size: 0.65rem;
      color: rgba(255,255,255,0.6);
      margin-bottom: 3px;
    }
    .return-form-group input,
    .return-form-group textarea {
      width: 100%;
      padding: 8px 10px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 6px;
      color: #fff;
      font-size: 0.75rem;
      font-family: 'Prompt', sans-serif;
    }
    .return-form-group textarea {
      resize: vertical;
      min-height: 50px;
    }
    .return-form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .return-addr-choice {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
    }
    .return-addr-choice button {
      flex: 1;
      padding: 8px;
      border: 2px solid rgba(255,255,255,0.15);
      border-radius: 8px;
      background: rgba(255,255,255,0.05);
      color: rgba(255,255,255,0.6);
      font-size: 0.65rem;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Prompt', sans-serif;
      transition: all 0.2s;
    }
    .return-addr-choice button.selected {
      border-color: #00d084;
      background: rgba(0,208,132,0.15);
      color: #00d084;
    }
    .last-addr-preview {
      background: rgba(0,208,132,0.1);
      border: 1px solid rgba(0,208,132,0.2);
      border-radius: 6px;
      padding: 8px;
      font-size: 0.65rem;
      color: rgba(255,255,255,0.7);
      margin-bottom: 8px;
      line-height: 1.5;
    }
    .return-submit-btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #10B981, #059669);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 0.85rem;
      font-weight: 700;
      cursor: pointer;
      font-family: 'Prompt', sans-serif;
      margin-top: 8px;
    }
    .return-submit-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .return-success-box {
      text-align: center;
      padding: 30px 16px;
    }
    .return-success-box .icon { font-size: 3rem; margin-bottom: 10px; }
    .return-success-box .title {
      font-size: 1rem;
      color: #34d399;
      font-weight: 700;
      margin-bottom: 6px;
    }
    .return-success-box .desc {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.6);
      line-height: 1.6;
    }

    /* ===== Tab 4: Admin Panel ===== */
    .admin-section {
      margin-bottom: 10px;
    }
    .admin-section-title {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.8);
      font-weight: 600;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .admin-section-title .count-badge {
      background: #ef4444;
      color: #fff;
      font-size: 0.55rem;
      padding: 1px 6px;
      border-radius: 8px;
    }
    .admin-req-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .admin-req-item {
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 10px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .admin-req-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .admin-req-cust {
      font-size: 0.75rem;
      color: #fff;
      font-weight: 600;
    }
    .admin-req-type {
      font-size: 0.55rem;
      padding: 2px 6px;
      border-radius: 6px;
      font-weight: 600;
    }
    .admin-req-type.card-req {
      background: rgba(99,102,241,0.3);
      color: #a5b4fc;
    }
    .admin-req-type.return-req {
      background: rgba(16,185,129,0.3);
      color: #6ee7b7;
    }
    .admin-req-detail {
      font-size: 0.65rem;
      color: rgba(255,255,255,0.6);
      margin-bottom: 8px;
      line-height: 1.5;
    }
    .admin-req-actions {
      display: flex;
      gap: 6px;
    }
    .admin-req-actions button {
      flex: 1;
      padding: 6px;
      border: none;
      border-radius: 6px;
      font-size: 0.65rem;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Prompt', sans-serif;
    }
    .admin-btn-approve {
      background: rgba(16,185,129,0.3);
      color: #34d399;
    }
    .admin-btn-reject {
      background: rgba(239,68,68,0.3);
      color: #f87171;
    }
    /* Admin user search */
    .admin-search-box {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
    }
    .admin-search-box input {
      flex: 1;
      padding: 8px 10px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 6px;
      color: #fff;
      font-size: 0.75rem;
      font-family: 'Prompt', sans-serif;
    }
    .admin-search-box button {
      padding: 8px 14px;
      background: rgba(99,102,241,0.3);
      color: #a5b4fc;
      border: none;
      border-radius: 6px;
      font-size: 0.7rem;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Prompt', sans-serif;
    }
    .admin-user-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
    }
    .admin-user-item {
      background: rgba(255,255,255,0.08);
      border-radius: 10px;
      padding: 8px;
      cursor: pointer;
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      transition: all 0.2s;
    }
    .admin-user-item:active {
      background: rgba(255,255,255,0.15);
    }
    .admin-user-avatar {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background: linear-gradient(135deg, #4ecdc4, #44a08d);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      font-weight: 700;
      color: #fff;
      flex-shrink: 0;
      overflow: hidden;
    }
    .admin-user-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }
    .admin-user-detail {
      flex: 1;
      min-width: 0;
    }
    .admin-user-name {
      font-size: 0.65rem;
      color: #fff;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .admin-user-sub {
      font-size: 0.5rem;
      color: rgba(255,255,255,0.5);
      margin-top: 1px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .admin-user-bank-row {
      font-size: 0.5rem;
      color: rgba(255,255,255,0.4);
      margin-top: 2px;
      line-height: 1.3;
    }
    .admin-user-bank-row .bank-tag {
      display: inline-block;
      padding: 1px 4px;
      border-radius: 3px;
      margin: 1px 1px 1px 0;
      font-size: 0.45rem;
      font-weight: 600;
    }
    .admin-user-bank-row .bank-tag.has-cards {
      background: rgba(78,205,196,0.15);
      color: #4ecdc4;
    }
    .admin-user-bank-row .bank-tag.no-cards {
      background: rgba(255,255,255,0.05);
      color: rgba(255,255,255,0.3);
      text-decoration: line-through;
    }
    .admin-user-avail-badge {
      position: absolute;
      top: 4px;
      right: 6px;
      font-size: 0.55rem;
      font-weight: 700;
      color: #00d084;
    }
    .admin-filter-row {
      display: flex;
      gap: 4px;
      margin-bottom: 8px;
    }
    .admin-filter-btn {
      padding: 4px 10px;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 12px;
      background: transparent;
      color: rgba(255,255,255,0.5);
      font-size: 0.6rem;
      cursor: pointer;
      font-family: 'Prompt', sans-serif;
    }
    .admin-filter-btn.active {
      background: rgba(255,255,255,0.15);
      color: #fff;
      border-color: rgba(255,255,255,0.3);
    }

    /* Admin Sub-tabs */
    .admin-subtab-bar {
      display: flex;
      gap: 4px;
      margin-bottom: 8px;
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
      padding: 3px;
    }
    .admin-subtab-btn {
      flex: 1;
      padding: 6px 4px;
      border: none;
      border-radius: 8px;
      background: transparent;
      color: rgba(255,255,255,0.5);
      font-size: 0.65rem;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Prompt', sans-serif;
      transition: all 0.2s;
    }
    .admin-subtab-btn.active {
      background: rgba(255,255,255,0.15);
      color: #fff;
    }
    .admin-subtab-btn .count-badge {
      background: #ef4444;
      color: #fff;
      font-size: 0.5rem;
      padding: 1px 5px;
      border-radius: 8px;
      margin-left: 2px;
    }
    .admin-subtab-content.hidden { display: none !important; }

    .scan-result-card {
      background: rgba(255,255,255,0.08);
      border-radius: 10px;
      padding: 14px;
      margin: 10px 0;
      border: 1px solid rgba(255,255,255,0.12);
    }
    .scan-result-card .card-name { font-size: 0.85rem; color: #fff; font-weight: 600; }
    .scan-result-card .card-detail { font-size: 0.7rem; color: rgba(255,255,255,0.6); margin-top: 4px; }
    .scan-action-btns { display: flex; gap: 8px; margin-top: 12px; }
    .scan-action-btns button {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Prompt', sans-serif;
    }
    .btn-receive { background: rgba(0,208,132,0.3); color: #00d084; }
    .btn-return { background: rgba(239,68,68,0.3); color: #f87171; }

    /* Admin: Card image management - no-image badge */
    .card-btn .no-image-badge {
      position: absolute;
      top: 4px;
      left: 4px;
      background: #ef4444;
      color: #fff;
      font-size: 0.5rem;
      padding: 1px 5px;
      border-radius: 6px;
      font-weight: 600;
      z-index: 5;
    }

    /* Card image upload input (hidden) */
    #adminImageUpload { display: none; }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>üí≥ D-SERVE Card Management <span class="speed-badge">‚ö° Supabase</span></h1>
    </div>
    
    <!-- Error Screen -->
    <div id="errorScreen" class="section-box hidden">
      <div class="error-box">
        <div class="icon">‚ùå</div>
        <div class="title">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</div>
        <div class="message" id="errorMessage">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</div>
      </div>
    </div>
    
    <!-- Success Screen -->
    <div id="successScreen" class="section-box hidden">
      <div class="success-box">
        <div class="icon">‚úÖ</div>
        <div class="title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>
        <div class="success-summary" id="successSummary"></div>
        <div class="btn-group">
          <button class="btn-secondary" onclick="resetForm()">üîÑ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</button>
          <button class="btn-secondary" onclick="closeLiff()">‚úï ‡∏õ‡∏¥‡∏î</button>
        </div>
      </div>
    </div>
    
    <!-- Main Content -->
    <div id="mainContent">
      <!-- Profile -->
      <div id="profileSection" class="profile-box hidden">
        <div class="profile-gear-btn" onclick="openProfileEditModal()">&#9881;</div>
        <img id="profileImg" class="profile-img" src="" onerror="this.src='https://via.placeholder.com/56/666/fff?text=üë§'">
        <div class="profile-info">
          <div class="profile-row1" id="profileRow1">-</div>
          <div class="profile-row2" id="profileRow2">-</div>
          <div class="profile-row3Phone" id="profileRow3Phone"></div>
          <div class="profile-row4" id="profileRow3"><span id="cardCount"></span></div>
        </div>
        <div class="profile-bank" id="profileBankSection">
          <div class="profile-bank-label">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</div>
          <div class="profile-bank-value" id="profileBankValue">-</div>
        </div>
      </div>
      
      <!-- Tab Bar -->
      <div id="tabBar" class="tab-bar hidden">
        <button class="tab-btn" data-tab="status" onclick="switchTab('status')">üí≥ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
        <button class="tab-btn" data-tab="return" onclick="switchTab('return')">üì¶ ‡∏Ñ‡∏∑‡∏ô‡∏ö‡∏±‡∏ï‡∏£</button>
        <button class="tab-btn active" data-tab="extra" onclick="switchTab('extra')">üí∞ ‡∏ô‡∏≠‡∏Å‡∏£‡∏≠‡∏ö</button>
        <button class="tab-btn" data-tab="admin" onclick="switchTab('admin')" id="adminTab" style="display:none;">‚öôÔ∏è Admin</button>
      </div>

      <!-- ===== Tab: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏±‡∏ï‡∏£ ===== -->
      <div id="tabStatus" class="tab-content hidden">
        <div class="section-box">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
            <span id="statusCardCount" style="font-size:0.65rem;color:rgba(255,255,255,0.7);"></span>
            <label class="toggle-unavail" style="display:flex;">
              <input type="checkbox" id="statusShowAll" onchange="loadCardStatus()" style="width:14px;height:14px;accent-color:#ff6b6b;">
              <span>‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà</span>
            </label>
          </div>
          <div id="statusCardGrid" class="card-grid"></div>
        </div>
      </div>

      <!-- ===== Tab: ‡πÅ‡∏à‡πâ‡∏á‡∏Ñ‡∏∑‡∏ô‡∏ö‡∏±‡∏ï‡∏£ ===== -->
      <div id="tabReturn" class="tab-content hidden">
        <!-- Return: Main Form -->
        <div id="returnFormSection">
          <!-- Bank Selection (if many cards) -->
          <div id="returnBankSection" class="section-box hidden" style="margin-bottom:8px;">
            <div class="section-title">üè¶ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</div>
            <div class="bank-grid" id="returnBankGrid"></div>
          </div>

          <!-- Card Selection (card grid with multi-select) -->
          <div class="section-box" style="margin-bottom:8px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
              <div class="section-title" style="margin:0;">üí≥ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô</div>
              <button type="button" class="return-select-all" onclick="returnToggleSelectAll()" style="font-size:0.65rem;">
                ‚òëÔ∏è <span id="returnSelectAllText">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
              </button>
            </div>
            <div id="returnCardGrid" class="card-grid"></div>
          </div>

          <!-- Delivery Method -->
          <div class="section-box" style="margin-bottom:8px;">
            <div class="section-title">üöö ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ï‡∏£</div>
            <div class="delivery-list">
              <label class="delivery-item selected" onclick="returnSelectDelivery(this, 1)">
                <input type="radio" name="returnDelivery" value="‡∏™‡πà‡∏á ‡∏õ‡∏ì / Kerry ‡∏£‡∏≠‡∏ö 1 ‡πÅ‡∏•‡∏∞ 16" checked>
                <div class="delivery-info">
                  <div class="delivery-title">üìÆ ‡∏™‡πà‡∏á ‡∏õ‡∏ì / Kerry <span class="delivery-badge-free">‡∏ü‡∏£‡∏µ</span></div>
                  <div class="delivery-desc">‡∏£‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1 ‡πÅ‡∏•‡∏∞ 16 ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                </div>
              </label>
              <label class="delivery-item" onclick="returnSelectDelivery(this, 2)">
                <input type="radio" name="returnDelivery" value="‡∏™‡πà‡∏á Grab ‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô">
                <div class="delivery-info">
                  <div class="delivery-title">üèçÔ∏è Grab ‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô <span class="delivery-badge-paid">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á</span></div>
                  <div class="delivery-desc">‡∏™‡πà‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 1-2 ‡∏ä‡∏°. (‡∏Å‡∏ó‡∏°./‡∏õ‡∏£‡∏¥‡∏°‡∏ì‡∏ë‡∏•)</div>
                </div>
              </label>
              <label class="delivery-item" onclick="returnSelectDelivery(this, 3)">
                <input type="radio" name="returnDelivery" value="‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Grab ‡∏°‡∏≤‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏á">
                <div class="delivery-info">
                  <div class="delivery-title">üõµ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Grab ‡∏°‡∏≤‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏á <span class="delivery-badge-free">‡∏ü‡∏£‡∏µ</span></div>
                  <div class="delivery-desc">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Grab ‡∏°‡∏≤‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô</div>
                </div>
              </label>
              <label class="delivery-item" onclick="returnSelectDelivery(this, 4)">
                <input type="radio" name="returnDelivery" value="‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó 39">
                <div class="delivery-info">
                  <div class="delivery-title">üè¢ ‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó 39 <span class="delivery-badge-free">‡∏ü‡∏£‡∏µ</span></div>
                  <div class="delivery-desc">‡∏ô‡∏±‡∏î‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏ü‡∏ü‡∏¥‡∏®</div>
                </div>
              </label>
            </div>

            <!-- Pickup DateTime (option 4) -->
            <div id="returnPickupBox" class="pickup-box hidden">
              <div class="pickup-label">üìÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏£‡∏±‡∏ö</div>
              <div id="returnDateGrid" class="pickup-date-grid"></div>
              <div class="pickup-label">‚è∞ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤</div>
              <div class="pickup-time-list">
                <label class="pickup-time-item" onclick="returnSelectTime(this, '09.00-12.00')">
                  <input type="radio" name="returnPickupTime" value="09.00-12.00">
                  <span>09.00-12.00</span>
                </label>
                <label class="pickup-time-item" onclick="returnSelectTime(this, '13.00-18.00')">
                  <input type="radio" name="returnPickupTime" value="13.00-18.00">
                  <span>13.00-18.00</span>
                </label>
                <label class="pickup-time-item" onclick="returnSelectTime(this, '19.00-24.00')">
                  <input type="radio" name="returnPickupTime" value="19.00-24.00">
                  <span>19.00-24.00 (‡∏ß‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á)</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Recipient Info -->
          <div class="section-box" style="margin-bottom:8px;">
            <div class="section-title">üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</div>
            <div class="return-form-group">
              <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö *</label>
              <input type="text" id="returnRecipientName" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•">
            </div>
            <div class="return-form-group">
              <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå *</label>
              <input type="tel" id="returnPhone" placeholder="0XX-XXX-XXXX">
            </div>

            <!-- Address section (for delivery 1,2) -->
            <div id="returnAddressSection">
              <div id="returnAddrChoice" class="return-addr-choice hidden">
                <button class="selected" onclick="returnSetAddrChoice('last')">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏î‡∏¥‡∏°</button>
                <button onclick="returnSetAddrChoice('new')">‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà</button>
              </div>
              <div id="returnLastAddrPreview" class="last-addr-preview hidden"></div>
              <div id="returnNewAddrForm">
                <div class="return-form-group">
                  <label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ‡∏ã‡∏≠‡∏¢ ‡∏ñ‡∏ô‡∏ô) *</label>
                  <textarea id="returnAddress" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà"></textarea>
                </div>
                <div class="return-form-row">
                  <div class="return-form-group">
                    <label>‡πÅ‡∏Ç‡∏ß‡∏á/‡∏ï‡∏≥‡∏ö‡∏• *</label>
                    <input type="text" id="returnSubDistrict" placeholder="‡πÅ‡∏Ç‡∏ß‡∏á/‡∏ï‡∏≥‡∏ö‡∏•">
                  </div>
                  <div class="return-form-group">
                    <label>‡πÄ‡∏Ç‡∏ï/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ *</label>
                    <input type="text" id="returnDistrict" placeholder="‡πÄ‡∏Ç‡∏ï/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠">
                  </div>
                </div>
                <div class="return-form-row">
                  <div class="return-form-group">
                    <label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î *</label>
                    <input type="text" id="returnProvince" placeholder="‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î">
                  </div>
                  <div class="return-form-group">
                    <label>‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå *</label>
                    <input type="text" id="returnPostalCode" placeholder="10XXX" maxlength="5">
                  </div>
                </div>
              </div>
            </div>
          </div>

          <button type="button" class="return-submit-btn" onclick="submitReturnForm()" id="returnSubmitBtn">
            ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏Ñ‡∏∑‡∏ô
          </button>
        </div>

        <!-- Return: Success -->
        <div id="returnSuccessSection" class="hidden">
          <div class="return-success-box">
            <div class="icon">üéâ</div>
            <div class="title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>
            <div class="desc">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏Ñ‡∏∑‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß<br>‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
          </div>
        </div>
      </div>

      <!-- ===== Tab: ‡πÅ‡∏à‡πâ‡∏á‡∏¢‡∏≠‡∏î‡∏ô‡∏≠‡∏Å‡∏£‡∏≠‡∏ö (‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°) ===== -->
      <div id="tabExtra" class="tab-content">

      <!-- Bank Selection (>8 cards) -->
      <div id="bankSection" class="section-box hidden">
        <div class="section-title">üè¶ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ (‡∏Å‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£)</div>
        <div class="bank-grid" id="bankGrid"></div>
      </div>
      
      <!-- Card Selection -->
      <div id="cardSection" class="section-box hidden">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
          <div class="section-title" style="margin:0;">üí≥ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ï‡∏£</div>
          <label class="toggle-unavail" id="unavailToggleLabel" style="display:none;">
            <input type="checkbox" id="showUnavailToggle" onchange="toggleShowUnavailable()">
            <span>‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà</span>
          </label>
        </div>
        <div class="card-grid" id="cardGrid"></div>
      </div>
      
      <!-- Amount Entry -->
      <div id="amountSection" class="section-box hidden">
        <div class="amount-header">
          <div class="section-title" style="margin:0;">üí∞ ‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î</div>
          <label class="toggle-same" id="toggleLabel">
            <input type="checkbox" id="sameToggle" checked onchange="toggleSameAmount()">
            <span>‡∏¢‡∏≠‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô</span>
          </label>
        </div>
        
        <!-- Quick Amount -->
        <div class="quick-btns" id="quickBtns">
          <button class="quick-btn" onclick="applyQuickAmount(5000)">‡∏ø5,000</button>
          <button class="quick-btn" onclick="applyQuickAmount(10000)">‡∏ø10,000</button>
          <button class="quick-btn" onclick="applyQuickAmount(15000)">‡∏ø15,000</button>
        </div>
        
        <!-- Toggle ON: Single input + card tags -->
        <div id="sameAmountView">
          <div class="global-amount-box">
            <div class="global-amount-row">
              <label>‡∏¢‡∏≠‡∏î‡∏ó‡∏∏‡∏Å‡πÉ‡∏ö:</label>
              <input type="tel" id="globalAmount" class="amount-input" placeholder="0" inputmode="decimal" oninput="formatAmount(this)">
              <span class="currency">‡∏ö‡∏≤‡∏ó</span>
            </div>
          </div>
          <div class="selected-cards-display" id="selectedCardsDisplay"></div>
        </div>
        
        <!-- Toggle OFF: Individual inputs -->
        <div id="separateAmountView" class="hidden">
          <div class="amount-grid has-odd-last" id="amountGrid"></div>
        </div>
      </div>
      
      <!-- Date & Shop -->
      <div id="extraSection" class="section-box hidden">
        <div class="section-title">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏î</div>
        <div class="date-row">
          <button class="date-btn selected" data-type="today" onclick="selectDate(this,'today')">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
          <button class="date-btn" data-type="yesterday" onclick="selectDate(this,'yesterday')">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô</button>
          <button class="date-btn" data-type="custom" onclick="selectDate(this,'custom')">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏á</button>
        </div>
        <input type="date" id="dateInput" class="shop-input hidden" style="margin-bottom:10px;">
        
        <div class="section-title">üè™ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</div>
        <div class="shop-suggestions" id="shopSuggestions"></div>
        <input type="text" id="shopInput" class="shop-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤...">
      </div>
      
      <!-- Submit -->
      <button id="submitBtn" class="submit-btn hidden" onclick="submitForm()">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>

      </div><!-- /tabExtra -->

      <!-- ===== Tab: Admin Panel ===== -->
      <div id="tabAdmin" class="tab-content hidden">
        <!-- Admin Sub-tabs -->
        <div class="admin-subtab-bar">
          <button class="admin-subtab-btn active" onclick="switchAdminSubTab('requests', this)">üìã ‡∏Ñ‡∏≥‡∏Ç‡∏≠ <span class="count-badge" id="adminPendingCount">0</span></button>
          <button class="admin-subtab-btn" onclick="switchAdminSubTab('users', this)">üë• ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
          <button class="admin-subtab-btn" onclick="switchAdminSubTab('images', this)">üñº ‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£</button>
        </div>

        <!-- Sub-tab 1: ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ -->
        <div id="adminSubRequests" class="admin-subtab-content">
          <div class="admin-filter-row">
            <button class="admin-filter-btn active" onclick="filterAdminRequests('all', this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button class="admin-filter-btn" onclick="filterAdminRequests('pending', this)">‡∏£‡∏≠</button>
            <button class="admin-filter-btn" onclick="filterAdminRequests('approved', this)">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
            <button class="admin-filter-btn" onclick="filterAdminRequests('rejected', this)">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
          </div>
          <div id="adminReqList" class="admin-req-list"></div>
        </div>

        <!-- Sub-tab 2: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ -->
        <div id="adminSubUsers" class="admin-subtab-content hidden">
          <div class="admin-search-box">
            <input type="text" id="adminUserSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ cust_id / ‡∏ä‡∏∑‡πà‡∏≠ / ‡πÄ‡∏ö‡∏≠‡∏£‡πå" onkeypress="if(event.key==='Enter')searchAdminUsers()">
            <button onclick="searchAdminUsers()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
          </div>
          <div id="adminUserList"></div>
        </div>

        <!-- Sub-tab 3: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£ -->
        <div id="adminSubImages" class="admin-subtab-content hidden">
          <div id="adminCardTypeGrid" class="card-grid"></div>
        </div>
      </div>

      <!-- Admin: User Cards Modal -->
      <div id="adminUserCardsModal" class="modal-overlay hidden">
        <div class="modal-box" style="max-height:85vh;overflow-y:auto;">
          <div class="modal-header" id="adminUserCardsTitle">‡∏ö‡∏±‡∏ï‡∏£‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</div>
          <div class="modal-body">
            <label class="toggle-unavail" style="display:flex;margin-bottom:8px;">
              <input type="checkbox" id="adminUserShowAll" onchange="renderAdminUserCards()" style="width:14px;height:14px;accent-color:#ff6b6b;">
              <span>‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà</span>
            </label>
            <div id="adminUserCardGrid" class="card-grid"></div>
          </div>
          <div class="modal-footer">
            <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('adminUserCardsModal').classList.add('hidden')">‡∏õ‡∏¥‡∏î</button>
          </div>
        </div>
      </div>

    </div>
  </div>



  <!-- Toast Popup -->
  <div id="toastContainer" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:99999;pointer-events:none;"></div>

  <!-- Processing Overlay -->
  <div id="processingOverlay" class="modal-overlay hidden" style="z-index:99998;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;">
    <div style="text-align:center;color:#fff;">
      <div class="loading-spinner" style="margin:0 auto 12px;"></div>
      <div id="processingText" style="font-size:0.85rem;color:rgba(255,255,255,0.9);">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...</div>
    </div>
  </div>

  <!-- Hidden file input for card image upload -->
  <input type="file" id="adminImageUpload" accept="image/*">

  <!-- Loading -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div id="loadingText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </div>
  </div>
  
  <!-- ‚≠ê Modal ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ï‡∏£ -->
  <div id="addCardModal" class="modal-overlay hidden">
    <div class="modal-box">
      <div class="modal-header">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà</div>
      <div class="modal-body">
        <!-- Bank Selector (‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢ bank) -->
        <div id="modalBankRow" class="modal-row hidden">
          <span class="modal-label" style="margin:0;white-space:nowrap;">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£:</span>
          <select id="modalBankSelect" class="modal-select" onchange="onModalBankChange()"></select>
        </div>
        
        <!-- Card Types Grid -->
        <div class="modal-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£:</div>
        <div id="modalCardGrid" class="modal-card-grid"></div>
        
        <!-- Last4 + Name Row -->
        <div class="modal-row">
          <span class="modal-label" style="margin:0;white-space:nowrap;">4 ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢:</span>
          <input type="tel" id="modalLast4" class="modal-input modal-input-sm" maxlength="4" placeholder="0000" oninput="validateModalForm()">
          <span class="modal-label" style="margin:0;white-space:nowrap;">‡∏ä‡∏∑‡πà‡∏≠:</span>
          <input type="text" id="modalName" class="modal-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏ô‡∏ö‡∏±‡∏ï‡∏£" oninput="validateModalForm()">
        </div>
        
        <!-- Name Suggestions -->
        <div id="modalNameSuggest" class="modal-suggest"></div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-cancel" onclick="closeAddCardModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button id="modalConfirmBtn" class="modal-btn modal-btn-confirm" onclick="confirmAddCard()" disabled>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ï‡∏£</button>
      </div>
    </div>
  </div>

  <!-- ‚≠ê Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏±‡∏ï‡∏£ (3 ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) -->
  <div id="cardStatusModal" class="modal-overlay hidden">
    <div class="modal-box">
      <div class="modal-header">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏±‡∏ï‡∏£</div>
      <div class="modal-body">
        <div id="statusModalCardInfo"></div>
        <div class="status-options">
          <label class="status-option"><input type="radio" name="cardStatusOption" value="with_team"> ‡∏ö‡∏±‡∏ï‡∏£‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô</label>
          <label class="status-option"><input type="radio" name="cardStatusOption" value="with_customer"> ‡∏ö‡∏±‡∏ï‡∏£‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß</label>
          <label class="status-option"><input type="radio" name="cardStatusOption" value="expired"> ‡∏ö‡∏±‡∏ï‡∏£‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-cancel" onclick="closeCardStatusModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="modal-btn modal-btn-confirm" onclick="submitCardStatusChange()">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠</button>
      </div>
    </div>
  </div>

  <!-- ‚≠ê Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ -->
  <div id="profileEditModal" class="modal-overlay hidden">
    <div class="modal-box">
      <div class="modal-header">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</div>
      <div class="modal-body">
        <div class="modal-row" style="flex-direction:column;gap:10px;">
          <div>
            <span class="modal-label">üì± ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</span>
            <input type="tel" id="profilePhoneInput" class="modal-input" maxlength="12" placeholder="0XX-XXX-XXXX">
          </div>
          <div style="border-top:1px solid rgba(255,255,255,0.1);padding-top:10px;">
            <span class="modal-label">üè¶ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô:</span>
            <div style="margin-top:4px;display:flex;align-items:center;gap:6px;">
              <div class="scb-logo-mini"><span>SCB</span><span class="scb-leaf">üçÉ</span></div>
              <span style="font-size:0.7rem;color:rgba(255,255,255,0.5);">‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå</span>
            </div>
          </div>
          <div>
            <span class="modal-label">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</span>
            <input type="tel" id="bankAccountInput" class="modal-input" maxlength="15" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ">
          </div>
        </div>
        <div style="margin-top:10px;font-size:11px;color:#999;line-height:1.4;">
          * ‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏™‡∏á‡∏ß‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ä‡πâ‡πÅ‡∏Ñ‡πà‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-cancel" onclick="closeProfileEditModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="modal-btn modal-btn-confirm" onclick="saveProfileEdit()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </div>
  </div>

  <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ‚ö†Ô∏è CONFIG - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ!
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const CONFIG = {
      // LINE LIFF
      LIFF_ID: '2008957662-eSzXKJNi',
      
      // Supabase (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• - ‡πÄ‡∏£‡πá‡∏ß!)
      SUPABASE_URL: 'https://momguihyvsjuexpficdf.supabase.co',
      SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1vbWd1aWh5dnNqdWV4cGZpY2RmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxODQ0ODUsImV4cCI6MjA4NDc2MDQ4NX0.nkdyabWT39acE9ib_BEsTXcKsDpal_myX9PbLvHUnlk',
      
      // Apps Script (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å - ‡πÑ‡∏õ Sheets ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
      APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbyghkPL3lSsZpm_DKZz78f2MseanH8HUQ92CfaVb6r3MvCs1TgUcXhdm9sX-JiI7t_Z/exec',
      
      // Threshold
      CARD_THRESHOLD: 8,
      
      // ‚≠ê Allowed Banks (‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏Ñ‡πà‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
      ALLOWED_BANKS: ['KCC', 'KFV', 'LOTUS', 'THE1', 'KBANK', 'SCB', 'TTB', 'UOB', 'BBL', 'AEON', 'AMEX', 'GSB', 'ICBC'],

      // Admin
      ADMIN_UID: 'Ua7d9f66661485ad713432e99d8d99e11'
    };
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // Supabase Client
    let sb;

    // State
    let lineProfile = null;
    let customerInfo = null;
    let currentTab = 'extra'; // default tab
    let allCards = [];
    let selectedBanks = [];
    let selectedCards = [];
    let recentAmounts = [5000, 10000, 15000]; // ‚≠ê Default values
    let recentShops = []; // ‚≠ê ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    let cardTypes = []; // ‚≠ê ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ï‡∏£)
    let allUnavailableCards = []; // ‚≠ê ‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà available=false
    let showUnavailable = false;   // ‚≠ê toggle state

    // ============ TAB NAVIGATION ============
    function switchTab(tab) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

      // Show selected tab
      const tabId = 'tab' + tab.charAt(0).toUpperCase() + tab.slice(1);
      const tabEl = document.getElementById(tabId);
      if (tabEl) tabEl.classList.remove('hidden');
      const btnEl = document.querySelector(`.tab-btn[data-tab="${tab}"]`);
      if (btnEl) btnEl.classList.add('active');

      currentTab = tab;

      // Lazy load tab data
      if (tab === 'status') loadCardStatus();
      if (tab === 'return') loadReturnTab();
      if (tab === 'admin') loadAdminData();
    }

    // ============ TAB 1: CARD STATUS ============
    function loadCardStatus() {
      const showAll = document.getElementById('statusShowAll').checked;
      const availCards = allCards || [];
      const unavailCards = allUnavailableCards || [];
      const displayCards = showAll ? [...availCards, ...unavailCards] : availCards;

      document.getElementById('statusCardCount').textContent =
        `üí≥ ‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà ${availCards.length} / ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${availCards.length + unavailCards.length}`;

      let html = displayCards.map(card => {
        const isUnavail = !card.available;
        // ‚≠ê Fallback: ‡∏ñ‡πâ‡∏≤ card ‡πÑ‡∏°‡πà‡∏°‡∏µ image_url ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å cardTypes
        let imgUrl = card.image_url;
        if (!imgUrl || !imgUrl.startsWith('http')) {
          const ct = cardTypes.find(t => t.card_name === card.card_type);
          if (ct && ct.image_url && ct.image_url.startsWith('http')) imgUrl = ct.image_url;
        }
        const hasImage = imgUrl && imgUrl.startsWith('http');
        const imgHtml = hasImage
          ? `<img src="${imgUrl}" class="card-bg-img" onerror="this.style.display='none'">`
          : '';
        const noImageClass = hasImage ? '' : 'no-image';
        const unavailBadge = isUnavail ? '<span class="unavail-badge">üö®‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà</span>' : '';
        const unavailClass = isUnavail ? 'unavailable' : '';

        return `<div class="card-btn ${noImageClass} ${unavailClass}"
              onclick="showCardDetail('${card.card_id}')">
          ${imgHtml}
          ${unavailBadge}
          <div class="card-overlay">
            <div class="card-name">${truncate(card.card_type, 12)}</div>
            <div class="card-last4">${card.last4}</div>
            <div class="card-owner">${truncate(card.full_name, 12)}</div>
          </div>
        </div>`;
      }).join('');

      // ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ï‡∏£ (‡∏ï‡πâ‡∏≠‡∏á Admin ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)
      const remainder = displayCards.length % 3;
      const spanClass = remainder === 0 ? 'span-3' : remainder === 1 ? 'span-2' : '';
      html += `<div class="add-card-btn ${spanClass}" onclick="openAddCardRequestModal()">
        <span>‚ûï</span>
        <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ï‡∏£</span>
      </div>`;

      document.getElementById('statusCardGrid').innerHTML = html || '<div class="tab-placeholder">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ï‡∏£</div>';
    }

    function openAddCardRequestModal() {
      window._addCardMode = 'request';
      openAddCardModal();
    }

    async function confirmAddCardRequest() {
      const last4 = document.getElementById('modalLast4').value.trim();
      const name = document.getElementById('modalName').value.trim();

      if (!modalSelectedType || last4.length !== 4 || !name) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'warning');
        return;
      }

      // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ö‡∏±‡∏ï‡∏£‡∏ã‡πâ‡∏≥
      const allCardsList = [...(allCards || []), ...(allUnavailableCards || [])];
      const dup = allCardsList.find(c => c.card_type === modalSelectedType && c.last4 === last4);
      if (dup) {
        showToast(`‡∏ö‡∏±‡∏ï‡∏£ ${modalSelectedType} ${last4} ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö`, 'warning');
        return;
      }

      const typeInfo = cardTypes.find(t => t.card_name === modalSelectedType) || {};

      try {
        showProcessing('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ï‡∏£...');
        const body = {
          action: 'submitAddCardRequest',
          custId: customerInfo.cust_id,
          bank: typeInfo.bank || (document.getElementById('modalBankSelect')?.value) || '',
          cardType: modalSelectedType,
          last4: last4,
          fullName: name,
          lineUserId: lineProfile.userId,
          displayName: lineProfile.displayName
        };

        const res = await fetch(CONFIG.APPS_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(body)
        });
        const result = await res.json();
        hideProcessing();

        if (result.success) {
          showToast('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ï‡∏£‡πÅ‡∏•‡πâ‡∏ß\n‡∏£‡∏≠ Admin ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'success');
          closeAddCardModal();
          window._addCardMode = null;
        } else {
          showToast('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (result.error || 'Unknown error'), 'error');
        }
      } catch (e) {
        hideProcessing();
        console.error('Error submitting add card request:', e);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'error');
      }
    }

    function showCardDetail(cardId) {
      const allCardsList = [...(allCards || []), ...(allUnavailableCards || [])];
      const card = allCardsList.find(c => c.card_id === cardId);
      if (!card) return;

      window._statusCardId = cardId;

      const hasImg = card.image_url && card.image_url.startsWith('http');
      const imgHtml = hasImg
        ? `<img src="${card.image_url}" onerror="this.style.display='none'">`
        : '';
      const statusText = card.available ? '‚úÖ ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô' : '‚ùå ‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô';

      document.getElementById('statusModalCardInfo').innerHTML = `
        <div class="status-modal-card">
          ${imgHtml ? `<div>${imgHtml}</div>` : ''}
          <div class="status-modal-card-info">
            <div style="font-weight:600;">${card.card_type}</div>
            <div style="font-size:0.7rem;opacity:0.8;">${card.last4} | ${card.full_name || '-'} | ${card.bank || '-'}</div>
            <div style="font-size:0.7rem;margin-top:2px;">${statusText}</div>
          </div>
        </div>`;

      // Pre-select radio matching current status
      const radios = document.querySelectorAll('input[name="cardStatusOption"]');
      radios.forEach(r => r.checked = false);
      if (card.available) {
        document.querySelector('input[name="cardStatusOption"][value="with_team"]').checked = true;
      } else {
        document.querySelector('input[name="cardStatusOption"][value="with_customer"]').checked = true;
      }

      document.getElementById('cardStatusModal').classList.remove('hidden');
    }

    function closeCardStatusModal() {
      document.getElementById('cardStatusModal').classList.add('hidden');
      window._statusCardId = null;
    }

    async function submitCardStatusChange() {
      const cardId = window._statusCardId;
      if (!cardId) return;

      const selected = document.querySelector('input[name="cardStatusOption"]:checked');
      if (!selected) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', 'warning'); return; }

      const allCardsList = [...(allCards || []), ...(allUnavailableCards || [])];
      const card = allCardsList.find(c => c.card_id === cardId);
      if (!card) return;

      const option = selected.value;
      var newAvailable, newStatus;
      if (option === 'with_team') {
        newAvailable = true;
        newStatus = '';
      } else if (option === 'with_customer') {
        newAvailable = false;
        newStatus = '';
      } else {
        // expired
        newAvailable = false;
        newStatus = '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏';
      }

      try {
        showProcessing('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠...');
        const body = {
          action: 'submitCardRequest',
          custId: customerInfo.cust_id,
          cardId: cardId,
          requestType: 'change_status',
          currentAvailable: card.available,
          newAvailable: newAvailable,
          newStatus: newStatus,
          lineUserId: lineProfile.userId,
          displayName: lineProfile.displayName
        };

        const res = await fetch(CONFIG.APPS_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(body)
        });
        const result = await res.json();
        hideProcessing();

        if (result.success) {
          closeCardStatusModal();
          showToast('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠ Admin ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'success');
        } else {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (result.error || result.message), 'error');
        }
      } catch (e) {
        hideProcessing();
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message, 'error');
      }
    }

    // ============ TAB 2: RETURN CARD ============
    let returnDeliveryOption = 1;
    let returnAddrChoice = 'new';
    let returnLastAddress = null;
    let returnPickupDate = null;
    let returnPickupTime = null;

    var returnSelectedCardIds = new Set();
    var returnSelectedBanks = new Set();

    function loadReturnTab() {
      const availCards = allCards || [];
      returnSelectedCardIds = new Set();
      returnSelectedBanks = new Set();

      // Show bank selection if many cards
      const bankSection = document.getElementById('returnBankSection');
      if (availCards.length > CONFIG.CARD_THRESHOLD) {
        bankSection.classList.remove('hidden');
        const banks = [...new Set(availCards.map(c => c.bank).filter(Boolean))];
        document.getElementById('returnBankGrid').innerHTML = banks.map(bank =>
          `<button class="bank-btn" data-bank="${bank}" onclick="toggleReturnBank('${bank}')">${bank}</button>`
        ).join('');
        // Show all cards initially (no bank pre-selected)
        renderReturnCards(availCards);
      } else {
        bankSection.classList.add('hidden');
        renderReturnCards(availCards);
      }

      // Prefill name & phone
      if (customerInfo) {
        document.getElementById('returnRecipientName').value = customerInfo.full_name || customerInfo.name_on_card || '';
        document.getElementById('returnPhone').value = customerInfo.phone || '';
      }

      // Load last address from Supabase
      loadReturnLastAddress();

      // Render pickup dates
      renderReturnDateGrid();

      // Reset state
      returnDeliveryOption = 1;
      returnAddrChoice = 'new';
      returnPickupDate = null;
      returnPickupTime = null;
      document.getElementById('returnPickupBox').classList.add('hidden');
      updateReturnAddressVisibility();

      // Reset delivery option visual selection
      document.querySelectorAll('#tabReturn .delivery-item').forEach((item, i) => {
        item.classList.toggle('selected', i === 0);
        const radio = item.querySelector('input[type="radio"]');
        if (radio) radio.checked = (i === 0);
      });
      // Reset pickup date/time selections
      document.querySelectorAll('.pickup-date-item').forEach(el => el.classList.remove('selected'));
      document.querySelectorAll('.pickup-time-item').forEach(el => {
        el.classList.remove('selected');
        const radio = el.querySelector('input[type="radio"]');
        if (radio) radio.checked = false;
      });
    }

    function toggleReturnBank(bank) {
      if (returnSelectedBanks.has(bank)) {
        returnSelectedBanks.delete(bank);
      } else {
        returnSelectedBanks.add(bank);
      }
      // Update visual
      document.querySelectorAll('#returnBankGrid .bank-btn').forEach(b => {
        b.classList.toggle('selected', returnSelectedBanks.has(b.dataset.bank));
      });
      // Show cards from ALL selected banks (keep existing card selections)
      const bankCards = returnSelectedBanks.size > 0
        ? (allCards || []).filter(c => returnSelectedBanks.has(c.bank))
        : (allCards || []);
      renderReturnCards(bankCards);
    }

    function renderReturnCards(cards) {
      const html = cards.map(card => {
        const isSelected = returnSelectedCardIds.has(card.card_id);
        const hasImage = card.image_url && card.image_url.startsWith('http');
        const imgHtml = hasImage ? `<img src="${card.image_url}" class="card-bg-img" onerror="this.style.display='none'">` : '';
        const noImageClass = hasImage ? '' : 'no-image';

        return `<div class="card-btn ${noImageClass} ${isSelected ? 'selected' : ''}"
              data-card-id="${card.card_id}"
              onclick="toggleReturnCard('${card.card_id}')">
          ${imgHtml}
          <div class="check-overlay"></div>
          <div class="card-overlay">
            <div class="card-name">${truncate(card.card_type, 12)}</div>
            <div class="card-last4">${card.last4}</div>
            <div class="card-owner">${truncate(card.full_name, 12)}</div>
          </div>
        </div>`;
      }).join('');

      document.getElementById('returnCardGrid').innerHTML = html || '<div class="tab-placeholder">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô</div>';
      updateReturnSelectAllText();
    }

    function toggleReturnCard(cardId) {
      if (returnSelectedCardIds.has(cardId)) {
        returnSelectedCardIds.delete(cardId);
      } else {
        returnSelectedCardIds.add(cardId);
      }
      // Update visual
      const btn = document.querySelector(`#returnCardGrid .card-btn[data-card-id="${cardId}"]`);
      if (btn) btn.classList.toggle('selected', returnSelectedCardIds.has(cardId));
      updateReturnSelectAllText();
    }

    function updateReturnSelectAllText() {
      const visibleCards = document.querySelectorAll('#returnCardGrid .card-btn');
      const allSelected = visibleCards.length > 0 && Array.from(visibleCards).every(b => b.classList.contains('selected'));
      document.getElementById('returnSelectAllText').textContent = allSelected ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
    }

    async function loadReturnLastAddress() {
      try {
        const { data } = await sb
          .from('return_requests')
          .select('*')
          .eq('cust_id', customerInfo.cust_id)
          .order('requested_at', { ascending: false })
          .limit(1);

        if (data && data.length > 0 && data[0].address) {
          returnLastAddress = data[0];
          // Show address choice buttons
          document.getElementById('returnAddrChoice').classList.remove('hidden');
          document.getElementById('returnLastAddrPreview').classList.remove('hidden');
          document.getElementById('returnLastAddrPreview').textContent =
            `üìç ${data[0].address} ${data[0].sub_district || ''} ${data[0].district || ''} ${data[0].province || ''} ${data[0].postal_code || ''}`;
          // Prefill name from last request
          if (data[0].recipient_name) {
            document.getElementById('returnRecipientName').value = data[0].recipient_name;
          }
          if (data[0].phone) {
            document.getElementById('returnPhone').value = data[0].phone;
          }
          returnSetAddrChoice('last');
        }
      } catch (e) {
        console.error('loadReturnLastAddress error:', e);
      }
    }

    function returnSelectDelivery(el, option) {
      document.querySelectorAll('#tabReturn .delivery-item').forEach(i => i.classList.remove('selected'));
      el.classList.add('selected');
      el.querySelector('input').checked = true;
      returnDeliveryOption = option;
      document.getElementById('returnPickupBox').classList.toggle('hidden', option !== 4);
      updateReturnAddressVisibility();
    }

    function updateReturnAddressVisibility() {
      const needAddr = (returnDeliveryOption === 1 || returnDeliveryOption === 2);
      document.getElementById('returnAddressSection').style.display = needAddr ? '' : 'none';
    }

    function returnSetAddrChoice(choice) {
      returnAddrChoice = choice;
      document.querySelectorAll('#returnAddrChoice button').forEach(b => b.classList.remove('selected'));
      if (choice === 'last') {
        document.querySelectorAll('#returnAddrChoice button')[0].classList.add('selected');
        document.getElementById('returnNewAddrForm').style.display = 'none';
        document.getElementById('returnLastAddrPreview').style.display = '';
      } else {
        document.querySelectorAll('#returnAddrChoice button')[1].classList.add('selected');
        document.getElementById('returnNewAddrForm').style.display = '';
        document.getElementById('returnLastAddrPreview').style.display = 'none';
      }
    }

    function returnToggleSelectAll() {
      const cardBtns = document.querySelectorAll('#returnCardGrid .card-btn');
      const allSelected = cardBtns.length > 0 && Array.from(cardBtns).every(b => b.classList.contains('selected'));

      cardBtns.forEach(btn => {
        const cardId = btn.dataset.cardId;
        if (allSelected) {
          returnSelectedCardIds.delete(cardId);
          btn.classList.remove('selected');
        } else {
          returnSelectedCardIds.add(cardId);
          btn.classList.add('selected');
        }
      });
      updateReturnSelectAllText();
    }

    function renderReturnDateGrid() {
      const container = document.getElementById('returnDateGrid');
      if (!container) return;
      const dayNames = ['‡∏≠‡∏≤', '‡∏à', '‡∏≠', '‡∏û', '‡∏û‡∏§', '‡∏®', '‡∏™'];
      const today = new Date();
      container.innerHTML = '';

      for (let i = 0; i < 7; i++) {
        const d = new Date(today);
        d.setDate(today.getDate() + i);
        const dayName = dayNames[d.getDay()];
        const dateNum = d.getDate();
        const month = d.getMonth() + 1;
        const fullStr = dateNum + '/' + month + '/' + d.getFullYear();

        const div = document.createElement('div');
        div.className = 'pickup-date-item';
        div.dataset.date = fullStr;
        div.innerHTML = `<div class="pd-day">${dayName}</div><div class="pd-num">${i === 0 ? dateNum + '/' + month : dateNum}</div>`;
        div.onclick = function() {
          document.querySelectorAll('.pickup-date-item').forEach(el => el.classList.remove('selected'));
          this.classList.add('selected');
          returnPickupDate = fullStr;
        };
        container.appendChild(div);
      }
    }

    function returnSelectTime(el, timeStr) {
      document.querySelectorAll('.pickup-time-item').forEach(i => i.classList.remove('selected'));
      el.classList.add('selected');
      el.querySelector('input').checked = true;
      returnPickupTime = timeStr;
    }

    async function submitReturnForm() {
      // Validate cards (from returnSelectedCardIds Set)
      const selectedCardIds = [...returnSelectedCardIds];
      if (selectedCardIds.length === 0) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ï‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÉ‡∏ö', 'warning'); return; }
      const allCardsList = allCards || [];
      const selectedCards = selectedCardIds.map(id => {
        const c = allCardsList.find(card => card.card_id === id);
        return c ? `${c.card_type} ${c.last4} ${c.full_name || ''}` : id;
      });

      const recipientName = document.getElementById('returnRecipientName').value.trim();
      const phone = document.getElementById('returnPhone').value.trim();
      if (!recipientName) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö', 'warning'); return; }
      if (!phone) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå', 'warning'); return; }

      // Validate pickup for option 4
      if (returnDeliveryOption === 4) {
        if (!returnPickupDate) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏£‡∏±‡∏ö', 'warning'); return; }
        if (!returnPickupTime) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏±‡∏ö', 'warning'); return; }
      }

      // Get address
      let address = '', subDistrict = '', district = '', province = '', postalCode = '';
      const needAddr = (returnDeliveryOption === 1 || returnDeliveryOption === 2);
      if (needAddr) {
        if (returnAddrChoice === 'last' && returnLastAddress) {
          address = returnLastAddress.address;
          subDistrict = returnLastAddress.sub_district;
          district = returnLastAddress.district;
          province = returnLastAddress.province;
          postalCode = returnLastAddress.postal_code;
        } else {
          address = document.getElementById('returnAddress').value.trim();
          subDistrict = document.getElementById('returnSubDistrict').value.trim();
          district = document.getElementById('returnDistrict').value.trim();
          province = document.getElementById('returnProvince').value.trim();
          postalCode = document.getElementById('returnPostalCode').value.trim();
          if (!address || !subDistrict || !district || !province || !postalCode) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'warning'); return;
          }
        }
      }

      const btn = document.getElementById('returnSubmitBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

      try {
        const deliveryMethod = document.querySelector('input[name="returnDelivery"]:checked').value;
        const body = {
          action: 'submitReturnRequest',
          custId: customerInfo.cust_id,
          lineUserId: lineProfile.userId,
          displayName: lineProfile.displayName,
          selectedCards, selectedCardIds,
          deliveryMethod,
          recipientName, phone,
          address, subDistrict, district, province, postalCode,
          pickupDate: returnDeliveryOption === 4 ? returnPickupDate : null,
          pickupTime: returnDeliveryOption === 4 ? returnPickupTime : null
        };

        const res = await fetch(CONFIG.APPS_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(body)
        });
        const result = await res.json();

        if (result.success) {
          document.getElementById('returnFormSection').classList.add('hidden');
          document.getElementById('returnSuccessSection').classList.remove('hidden');
          // Remove returned cards from allCards
          allCards = allCards.filter(c => !selectedCardIds.includes(c.card_id));
          updateCardCount();
        } else {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (result.error || result.message), 'error');
          btn.disabled = false;
          btn.textContent = '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏Ñ‡∏∑‡∏ô';
        }
      } catch (e) {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message, 'error');
        btn.disabled = false;
        btn.textContent = '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏Ñ‡∏∑‡∏ô';
      }
    }

    // ============ TAB 4: ADMIN PANEL ============
    let adminRequests = [];
    let adminFilter = 'all';
    let adminCurrentSubTab = 'requests';
    let adminUserCardsData = [];
    let adminUserCardsAllData = [];
    let adminSelectedCardType = null;
    let adminAllUsers = null; // cache for all users

    function switchAdminSubTab(subtab, btn) {
      adminCurrentSubTab = subtab;
      document.querySelectorAll('.admin-subtab-btn').forEach(b => b.classList.remove('active'));
      if (btn) btn.classList.add('active');
      document.querySelectorAll('.admin-subtab-content').forEach(el => el.classList.add('hidden'));

      if (subtab === 'requests') {
        document.getElementById('adminSubRequests').classList.remove('hidden');
      } else if (subtab === 'users') {
        document.getElementById('adminSubUsers').classList.remove('hidden');
        loadAllAdminUsers();
      } else if (subtab === 'images') {
        document.getElementById('adminSubImages').classList.remove('hidden');
        loadAdminCardTypes();
      }
    }

    async function loadAdminData() {
      if (!lineProfile || lineProfile.userId !== CONFIG.ADMIN_UID) return;

      try {
        // Load card_requests
        const { data: cardReqs } = await sb
          .from('card_requests')
          .select('*')
          .order('requested_at', { ascending: false });

        // Load return_requests (recent)
        const { data: returnReqs } = await sb
          .from('return_requests')
          .select('*')
          .order('requested_at', { ascending: false })
          .limit(50);

        adminRequests = [
          ...((cardReqs || []).map(r => ({ ...r, _type: 'card' }))),
          ...((returnReqs || []).map(r => ({ ...r, _type: 'return' })))
        ].sort((a, b) => (b.requested_at || '').localeCompare(a.requested_at || ''));

        renderAdminRequests();
      } catch (e) {
        console.error('loadAdminData error:', e);
      }
    }

    function filterAdminRequests(filter, btn) {
      adminFilter = filter;
      document.querySelectorAll('.admin-filter-btn').forEach(b => b.classList.remove('active'));
      if (btn) btn.classList.add('active');
      renderAdminRequests();
    }

    function renderAdminRequests() {
      const filtered = adminFilter === 'all'
        ? adminRequests
        : adminRequests.filter(r => r.status === adminFilter);

      const pendingCount = adminRequests.filter(r => r.status === 'pending').length;
      document.getElementById('adminPendingCount').textContent = pendingCount;

      const container = document.getElementById('adminReqList');
      if (filtered.length === 0) {
        container.innerHTML = '<div class="tab-placeholder">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠</div>';
        return;
      }

      container.innerHTML = filtered.map(req => {
        const isCard = req._type === 'card';
        const typeClass = isCard ? 'card-req' : 'return-req';
        const isPending = req.status === 'pending';

        // ‚≠ê ‡∏†‡∏≤‡∏©‡∏≤‡∏Ñ‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ + ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
        let typeText = '';
        let detail = '';
        if (isCard) {
          if (req.request_type === 'add_card') {
            typeText = '‡∏Ç‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ï‡∏£';
            try {
              const nv = JSON.parse(req.new_value || '{}');
              detail = `üí≥ ${nv.cardType || '-'} ****${nv.last4 || '-'}<br>üë§ ${nv.fullName || '-'} | üè¶ ${nv.bank || '-'}`;
            } catch(e) { detail = `üí≥ ${req.new_value || '-'}`; }
          } else if (req.request_type === 'change_status') {
            typeText = '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞';
            try {
              const cv = JSON.parse(req.current_value || '{}');
              const nv = JSON.parse(req.new_value || '{}');
              const fromText = cv.available ? '‡∏ö‡∏±‡∏ï‡∏£‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô' : '‡∏ö‡∏±‡∏ï‡∏£‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß';
              const toText = nv.status === '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏' ? '‡∏ö‡∏±‡∏ï‡∏£‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏' : (nv.available ? '‡∏ö‡∏±‡∏ï‡∏£‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô' : '‡∏ö‡∏±‡∏ï‡∏£‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß');
              detail = `üí≥ ${req.card_id || '-'}<br>üìå ${fromText} ‚Üí ${toText}`;
            } catch(e) { detail = `üí≥ ${req.card_id || '-'}`; }
          } else if (req.request_type === 'request_return') {
            typeText = '‡∏Ç‡∏≠‡∏ô‡∏≥‡∏ö‡∏±‡∏ï‡∏£‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ù‡∏≤‡∏Å';
            detail = `üí≥ ${req.card_id || '-'}`;
          } else if (req.request_type === 'request_available') {
            typeText = '‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏Ñ‡∏∑‡∏ô';
            detail = `üí≥ ${req.card_id || '-'}`;
          } else {
            typeText = req.request_type || '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞';
            detail = `üí≥ ${req.card_id || '-'}`;
          }
        } else {
          const cardCount = (req.cards || '').split('\n').filter(Boolean).length;
          typeText = `‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏Ñ‡∏∑‡∏ô ${cardCount} ‡πÉ‡∏ö`;
          detail = `üí≥ ${(req.cards || '').replace(/\n/g, ', ')}<br>üöö ${req.delivery_method || '-'}`;
        }

        const statusBadge = req.status === 'approved'
          ? '<span style="color:#34d399;font-size:0.6rem;">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</span>'
          : req.status === 'rejected'
          ? '<span style="color:#f87171;font-size:0.6rem;">‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</span>'
          : '';

        const reqType = isCard ? 'card_request' : 'return_request';
        const actionsHtml = isPending
          ? `<div class="admin-req-actions">
              <button class="admin-btn-reject" onclick="adminRejectRequest('${req.request_id}', '${reqType}')">‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
              <button class="admin-btn-approve" onclick="adminApproveRequest('${req.request_id}', '${reqType}')">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
            </div>`
          : statusBadge;

        return `<div class="admin-req-item">
          <div class="admin-req-header">
            <span class="admin-req-cust">${req.cust_id || '-'}</span>
            <span class="admin-req-type ${typeClass}">${typeText}</span>
          </div>
          <div class="admin-req-detail">${detail}</div>
          ${actionsHtml}
        </div>`;
      }).join('');
    }

    async function adminApproveRequest(requestId, requestType) {
      if (!confirm('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ô‡∏µ‡πâ?')) return;
      try {
        showProcessing('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥...');
        const res = await fetch(CONFIG.APPS_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({
            action: 'approveRequest',
            requestType: requestType,
            requestId: requestId,
            adminUserId: lineProfile.userId,
            note: ''
          })
        });
        const result = await res.json();
        hideProcessing();
        if (result.success) {
          // Update local state
          const req = adminRequests.find(r => r.request_id === requestId);
          if (req) req.status = 'approved';
          renderAdminRequests();
          showToast('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
          // ‚≠ê Update Supabase for persistence
          const table = requestType === 'card_request' ? 'card_requests' : 'return_requests';
          sb.from(table).update({ status: 'approved' }).eq('request_id', requestId).then(() => {});
        } else {
          showToast('Error: ' + (result.error || 'Unknown'), 'error');
        }
      } catch (e) {
        hideProcessing();
        showToast('Error: ' + e.message, 'error');
      }
    }

    async function adminRejectRequest(requestId, requestType) {
      const note = prompt('‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö):') || '';
      try {
        showProcessing('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...');
        const res = await fetch(CONFIG.APPS_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({
            action: 'rejectRequest',
            requestType: requestType,
            requestId: requestId,
            adminUserId: lineProfile.userId,
            note: note
          })
        });
        const result = await res.json();
        hideProcessing();
        if (result.success) {
          const req = adminRequests.find(r => r.request_id === requestId);
          if (req) req.status = 'rejected';
          renderAdminRequests();
          showToast('‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
          // ‚≠ê Update Supabase for persistence
          const table = requestType === 'card_request' ? 'card_requests' : 'return_requests';
          sb.from(table).update({ status: 'rejected', note: note }).eq('request_id', requestId).then(() => {});
        } else {
          showToast('Error: ' + (result.error || 'Unknown'), 'error');
        }
      } catch (e) {
        hideProcessing();
        showToast('Error: ' + e.message, 'error');
      }
    }

    async function loadAllAdminUsers() {
      if (adminAllUsers) {
        renderAdminUserList(adminAllUsers.users, adminAllUsers.bankSummary);
        return;
      }

      const container = document.getElementById('adminUserList');
      container.innerHTML = '<div class="tab-placeholder">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ...</div>';

      try {
        const [usersRes, cardsRes] = await Promise.all([
          sb.from('users').select('*'),
          sb.from('cards').select('cust_id, bank, available').range(0, 9999)
        ]);

        const users = usersRes.data || [];
        // ‚≠ê ‡∏Å‡∏£‡∏≠‡∏á CITI ‡∏≠‡∏≠‡∏Å + ‡∏Å‡∏£‡∏≠‡∏á‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ bank
        const allCardsData = (cardsRes.data || []).filter(c => c.bank && c.bank !== 'CITI');

        // Build bank summary per user
        const userBankSummary = {};
        allCardsData.forEach(c => {
          if (!userBankSummary[c.cust_id]) userBankSummary[c.cust_id] = {};
          if (!userBankSummary[c.cust_id][c.bank]) userBankSummary[c.cust_id][c.bank] = { avail: 0, total: 0 };
          userBankSummary[c.cust_id][c.bank].total++;
          if (c.available === true || c.available === 'true' || c.available === 'TRUE') {
            userBankSummary[c.cust_id][c.bank].avail++;
          }
        });

        adminAllUsers = { users, bankSummary: userBankSummary };
        renderAdminUserList(users, userBankSummary);
      } catch (e) {
        container.innerHTML = '<div class="tab-placeholder">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</div>';
      }
    }

    function renderAdminUserList(users, bankSummary) {
      const container = document.getElementById('adminUserList');
      if (users.length === 0) {
        container.innerHTML = '<div class="tab-placeholder">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</div>';
        return;
      }

      // Sort by cust_id ascending (numeric-aware)
      const sorted = [...users].sort((a, b) => {
        const aId = (a.cust_id || '').replace(/\D/g, '');
        const bId = (b.cust_id || '').replace(/\D/g, '');
        return (parseInt(aId) || 0) - (parseInt(bId) || 0);
      });

      const items = sorted.map(u => {
        const banks = bankSummary[u.cust_id] || {};
        const availCount = Object.values(banks).reduce((s, v) => s + v.avail, 0);
        const totalCount = Object.values(banks).reduce((s, v) => s + v.total, 0);

        // ‚≠ê ‡πÉ‡∏ä‡πâ profile_url (Col C) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
        const hasProfileUrl = u.profile_url && u.profile_url.startsWith('http');
        const userName = u.full_name || u.name_on_card || u.cust_id || '-';
        const initial = userName.charAt(0).toUpperCase();
        const profileImg = hasProfileUrl
          ? `<img src="${u.profile_url}" onerror="this.parentElement.innerHTML='${initial}'">`
          : initial;

        // Bank tags
        const bankTags = Object.entries(banks).map(([b, v]) => {
          const cls = v.avail > 0 ? 'has-cards' : 'no-cards';
          return `<span class="bank-tag ${cls}">${b} ${v.avail}/${v.total}</span>`;
        }).join('');

        return `<div class="admin-user-item" style="position:relative;" onclick="openAdminUserCards('${(u.cust_id || '').replace(/'/g, "\\'")}', '${userName.replace(/'/g, "\\'")}')">
          <div class="admin-user-avatar">${profileImg}</div>
          <div class="admin-user-detail">
            <div class="admin-user-name">${u.cust_id || '-'}</div>
            <div class="admin-user-sub">${userName}</div>
            <div class="admin-user-bank-row">${bankTags || '-'}</div>
          </div>
          <div class="admin-user-avail-badge">${availCount}/${totalCount}</div>
        </div>`;
      }).join('');

      container.innerHTML = `<div class="admin-user-grid">${items}</div>`;
    }

    async function searchAdminUsers() {
      const query = document.getElementById('adminUserSearch').value.trim().toLowerCase();

      // If empty query, show all users
      if (!query) {
        if (adminAllUsers) {
          renderAdminUserList(adminAllUsers.users, adminAllUsers.bankSummary);
        }
        return;
      }

      // Filter from cache if available
      if (adminAllUsers) {
        const filtered = adminAllUsers.users.filter(u =>
          (u.cust_id || '').toLowerCase().includes(query) ||
          (u.full_name || '').toLowerCase().includes(query) ||
          (u.display_name || '').toLowerCase().includes(query) ||
          (u.phone || '').includes(query)
        );
        renderAdminUserList(filtered, adminAllUsers.bankSummary);
        return;
      }

      // Fallback: load then filter
      await loadAllAdminUsers();
      if (adminAllUsers) {
        const filtered = adminAllUsers.users.filter(u =>
          (u.cust_id || '').toLowerCase().includes(query) ||
          (u.full_name || '').toLowerCase().includes(query) ||
          (u.display_name || '').toLowerCase().includes(query) ||
          (u.phone || '').includes(query)
        );
        renderAdminUserList(filtered, adminAllUsers.bankSummary);
      }
    }

    // ‚≠ê Admin: Open user cards popup
    async function openAdminUserCards(custId, userName) {
      document.getElementById('adminUserCardsTitle').textContent = `üí≥ ${custId} | ${userName}`;
      document.getElementById('adminUserShowAll').checked = false;
      document.getElementById('adminUserCardGrid').innerHTML = '<div class="tab-placeholder">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';
      document.getElementById('adminUserCardsModal').classList.remove('hidden');

      try {
        const { data } = await sb
          .from('cards')
          .select('*')
          .eq('cust_id', custId);

        adminUserCardsAllData = data || [];
        renderAdminUserCards();
      } catch (e) {
        document.getElementById('adminUserCardGrid').innerHTML = '<div class="tab-placeholder">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</div>';
      }
    }

    function renderAdminUserCards() {
      const showAll = document.getElementById('adminUserShowAll').checked;
      const cards = showAll
        ? adminUserCardsAllData
        : adminUserCardsAllData.filter(c => c.available === true || c.available === 'true' || c.available === 'TRUE');

      if (cards.length === 0) {
        document.getElementById('adminUserCardGrid').innerHTML = '<div class="tab-placeholder">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ï‡∏£</div>';
        return;
      }

      document.getElementById('adminUserCardGrid').innerHTML = cards.map(card => {
        const isAvail = card.available === true || card.available === 'true' || card.available === 'TRUE';
        const hasImage = card.image_url && card.image_url.startsWith('http');
        const imgHtml = hasImage ? `<img src="${card.image_url}" class="card-bg-img" onerror="this.style.display='none'">` : '';
        const noImageClass = hasImage ? '' : 'no-image';
        const unavailBadge = !isAvail ? '<span class="unavail-badge">üö®‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà</span>' : '';
        const unavailClass = !isAvail ? 'unavailable' : '';
        const borderColor = isAvail ? 'border-color: #00d084;' : 'border-color: #ef4444;';

        return `<div class="card-btn ${noImageClass} ${unavailClass}" style="${borderColor}"
              onclick="adminToggleCardAvailable('${card.card_id}', ${isAvail})">
          ${imgHtml}
          ${unavailBadge}
          <div class="card-overlay">
            <div class="card-name">${truncate(card.card_type, 12)}</div>
            <div class="card-last4">${card.last4}</div>
            <div class="card-owner">${truncate(card.full_name, 12)}</div>
          </div>
        </div>`;
      }).join('');
    }

    // ‚≠ê Admin: Toggle card available directly
    async function adminToggleCardAvailable(cardId, currentAvailable) {
      const newAvailable = !currentAvailable;
      const actionText = newAvailable ? '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏ô‡∏µ‡πâ?' : '‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏ô‡∏µ‡πâ?';
      if (!confirm(actionText)) return;

      try {
        // 1. Update GAS (Google Sheets)
        const res = await fetch(CONFIG.APPS_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({
            action: 'adminUpdateCard',
            adminUserId: lineProfile.userId,
            cardId: cardId,
            updates: { available: newAvailable }
          })
        });
        const result = await res.json();

        if (result.success) {
          // 2. Update Supabase directly for immediate effect
          await sb.from('cards').update({ available: newAvailable }).eq('card_id', cardId);

          // 3. Update local state
          const card = adminUserCardsAllData.find(c => c.card_id === cardId);
          if (card) card.available = newAvailable;
          renderAdminUserCards();
        } else {
          showToast('Error: ' + (result.error || 'Unknown'), 'error');
        }
      } catch (e) {
        showToast('Error: ' + e.message, 'error');
      }
    }

    // ‚≠ê Admin: Card image management
    async function loadAdminCardTypes() {
      const grid = document.getElementById('adminCardTypeGrid');
      grid.innerHTML = '<div class="tab-placeholder">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';

      try {
        const { data } = await sb.from('card_types').select('*');
        const types = data || [];

        // Sort: no image first
        types.sort((a, b) => {
          const aHas = a.image_url && a.image_url.startsWith('http') ? 1 : 0;
          const bHas = b.image_url && b.image_url.startsWith('http') ? 1 : 0;
          return aHas - bHas;
        });

        grid.innerHTML = types.map(t => {
          const hasImage = t.image_url && t.image_url.startsWith('http');
          const imgHtml = hasImage ? `<img src="${t.image_url}" class="card-bg-img" onerror="this.style.display='none'">` : '';
          const noImageClass = hasImage ? '' : 'no-image';
          const noImageBadge = !hasImage ? '<span class="no-image-badge">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ</span>' : '';

          return `<div class="card-btn ${noImageClass}" onclick="adminUploadCardImage('${(t.card_name || '').replace(/'/g, "\\'")}')">
            ${imgHtml}
            ${noImageBadge}
            <div class="card-overlay">
              <div class="card-name">${truncate(t.card_name, 12)}</div>
              <div class="card-last4">${t.bank || '-'}</div>
            </div>
          </div>`;
        }).join('') || '<div class="tab-placeholder">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£</div>';
      } catch (e) {
        grid.innerHTML = '<div class="tab-placeholder">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</div>';
      }
    }

    function adminUploadCardImage(cardName) {
      adminSelectedCardType = cardName;
      const input = document.getElementById('adminImageUpload');
      input.value = '';
      input.click();
    }

    // File input change handler (set up in init)
    async function handleCardImageUpload(file) {
      if (!file || !adminSelectedCardType) return;

      const cardName = adminSelectedCardType;
      const fileName = `${cardName.replace(/[^a-zA-Z0-9]/g, '_')}_${Date.now()}.${file.name.split('.').pop()}`;

      try {
        // 1. Upload to Supabase Storage
        const { data: uploadData, error: uploadError } = await sb.storage
          .from('card-images')
          .upload(fileName, file, { upsert: true });

        if (uploadError) {
          showToast('‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + uploadError.message, 'error');
          return;
        }

        // 2. Get public URL
        const { data: urlData } = sb.storage.from('card-images').getPublicUrl(fileName);
        const imageUrl = urlData.publicUrl;

        // 3. Update Supabase card_types immediately
        await sb.from('card_types').update({ image_url: imageUrl }).eq('card_name', cardName);

        // 3.5 ‚≠ê Also update ALL cards with this card_type (so images show immediately)
        await sb.from('cards').update({ image_url: imageUrl }).eq('card_type', cardName);

        // 4. Update GAS (Google Sheets) for persistence through sync
        fetch(CONFIG.APPS_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({
            action: 'adminUpdateCardTypeImage',
            adminUserId: lineProfile.userId,
            cardName: cardName,
            imageUrl: imageUrl
          })
        });

        showToast(`‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ ${cardName} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
        loadAdminCardTypes(); // Refresh grid
      } catch (e) {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message, 'error');
      }
    }

    // ============ INIT ============
    async function init() {
      const startTime = performance.now();
      
      try {
        // Check config
        if (CONFIG.LIFF_ID === 'YOUR_LIFF_ID_HERE') {
          showError('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LIFF_ID');
          return;
        }
        if (CONFIG.SUPABASE_URL === 'https://YOUR_PROJECT_ID.supabase.co') {
          showError('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ SUPABASE_URL');
          return;
        }
        
        // Init Supabase
        sb = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        
        setLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE...');
        await liff.init({ liffId: CONFIG.LIFF_ID });
        
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        
        // Get LINE profile
        lineProfile = await liff.getProfile();
        
        // ‚ö° Query ‡∏à‡∏≤‡∏Å Supabase (‡πÄ‡∏£‡πá‡∏ß‡∏°‡∏≤‡∏Å!)
        setLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
        
        // Query user
        const { data: userData, error: userError } = await sb
          .from('users')
          .select('*')
          .eq('line_user_id', lineProfile.userId)
          .single();
        
        if (userError || !userData) {
          showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Admin');
          return;
        }
        
        customerInfo = userData;
        
        // Query cards (‡∏î‡∏∂‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Äî ‡πÅ‡∏¢‡∏Å available/unavailable ‡πÉ‡∏ô JS)
        const { data: cardsData, error: cardsError } = await sb
          .from('cards')
          .select('*')
          .eq('cust_id', customerInfo.cust_id);

        if (cardsError) {
          console.error('Cards error:', cardsError);
        }

        // ‚≠ê ‡πÅ‡∏¢‡∏Å‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà vs ‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà + ‡∏Å‡∏£‡∏≠‡∏á ALLOWED_BANKS
        allCards = (cardsData || []).filter(card =>
          CONFIG.ALLOWED_BANKS.includes(card.bank) && card.available
        );
        allUnavailableCards = (cardsData || []).filter(card =>
          CONFIG.ALLOWED_BANKS.includes(card.bank) && !card.available
        );
        
        // ‚≠ê ‡∏î‡∏∂‡∏á cardTypes ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ï‡∏£
        const { data: typesData } = await sb
          .from('card_types')
          .select('*')
          .in('bank', CONFIG.ALLOWED_BANKS);
        cardTypes = typesData || [];
        
        // ‚≠ê ‡∏î‡∏∂‡∏á Recent Data (‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡∏∞‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î) ‡πÅ‡∏ö‡∏ö Background
        loadRecentData(customerInfo.cust_id);
        
        // Render UI
        renderProfile();
        setDefaultDate();

        // ‚≠ê Show tab bar + admin tab
        document.getElementById('tabBar').classList.remove('hidden');
        if (lineProfile.userId === CONFIG.ADMIN_UID) {
          document.getElementById('adminTab').style.display = '';
        }
        
        // Check if need bank selection
        if (allCards.length > CONFIG.CARD_THRESHOLD) {
          renderBankSelection();
        } else {
          renderCards(getDisplayCards(allCards));
        }
        
        hideLoading();

        // Setup card image upload handler
        document.getElementById('adminImageUpload').addEventListener('change', (e) => {
          if (e.target.files && e.target.files[0]) {
            handleCardImageUpload(e.target.files[0]);
          }
        });

        // Log performance
        const endTime = performance.now();
        console.log(`‚ö° Load time: ${Math.round(endTime - startTime)}ms`);
        
      } catch (error) {
        console.error('Init error:', error);
        showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
      }
    }
    
    // ============ RECENT DATA (‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡∏∞‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î) ============
    /**
     * ‚≠ê ‡∏î‡∏∂‡∏á‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡∏∞‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Supabase (Background)
     */
    async function loadRecentData(custId) {
      try {
        const { data, error } = await sb
          .from('extra')
          .select('amount, shop_name')
          .eq('cust_id', custId)
          .order('timestamp', { ascending: false })
          .limit(20);
        
        if (error) {
          console.error('Recent data error:', error);
          return;
        }
        
        if (!data || data.length === 0) {
          console.log('No recent data found');
          return;
        }
        
        // ‡∏î‡∏∂‡∏á 3 ‡∏¢‡∏≠‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥
        const seenAmounts = new Set();
        const amounts = [];
        for (const row of data) {
          const amount = Number(row.amount);
          if (amount > 0 && !seenAmounts.has(amount) && amounts.length < 3) {
            amounts.push(amount);
            seenAmounts.add(amount);
          }
        }
        
        // ‡∏î‡∏∂‡∏á 3 ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥
        const seenShops = new Set();
        const shops = [];
        for (const row of data) {
          const shop = String(row.shop_name || '').trim();
          if (shop && !seenShops.has(shop.toLowerCase()) && shops.length < 3) {
            shops.push(shop);
            seenShops.add(shop.toLowerCase());
          }
        }
        
        // Update state
        if (amounts.length > 0) recentAmounts = amounts;
        if (shops.length > 0) recentShops = shops;
        
        // Render UI
        renderQuickAmounts();
        renderShopSuggestions();
        
        console.log('‚úÖ Recent data loaded:', { amounts, shops });
        
      } catch (error) {
        console.error('loadRecentData error:', error);
      }
    }
    
    /**
     * ‚≠ê Render Quick Amount buttons
     */
    function renderQuickAmounts() {
      const container = document.getElementById('quickBtns');
      if (!container) return;
      
      container.innerHTML = recentAmounts.map(amount =>
        `<button class="quick-btn" onclick="applyQuickAmount(${amount})">‡∏ø${amount.toLocaleString()}</button>`
      ).join('');
    }
    
    /**
     * ‚≠ê Render Shop Suggestions
     */
    function renderShopSuggestions() {
      const container = document.getElementById('shopSuggestions');
      if (!container) return;
      
      if (recentShops.length === 0) {
        container.innerHTML = '';
        return;
      }
      
      container.innerHTML = recentShops.map(shop =>
        `<button class="shop-btn" onclick="selectShop(this, '${shop.replace(/'/g, "\\'")}')">${shop}</button>`
      ).join('');
    }
    
    // ============ RENDER ============
    function renderProfile() {
      document.getElementById('profileImg').src = lineProfile.pictureUrl || '';
      document.getElementById('profileRow1').textContent = `${customerInfo.cust_id} | ${lineProfile.displayName}`;
      document.getElementById('profileRow2').textContent = customerInfo.full_name || customerInfo.name_on_card || '-';
      // Phone
      const phone = customerInfo.phone || '';
      document.getElementById('profileRow3Phone').textContent = phone ? `üì± ${phone}` : '';
      // Bank account with SCB logo
      const bankName = customerInfo.bank_name || '';
      const bankAccount = String(customerInfo.bank_account || '').replace(/^'/, '');
      const bankEl = document.getElementById('profileBankValue');
      if (bankAccount) {
        const isSCB = !bankName || bankName.toUpperCase() === 'SCB' || bankName.includes('‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå');
        const bankDisplay = isSCB
          ? '<div class="scb-logo-mini"><span>SCB</span><span class="scb-leaf">üçÉ</span></div>'
          : `<div style="font-size:0.65rem;color:#4ecdc4;">${bankName}</div>`;
        bankEl.innerHTML = `${bankDisplay}<div style="font-size:0.8rem;font-weight:700;color:#fff;margin-top:2px;">${bankAccount}</div>`;
      } else {
        bankEl.innerHTML = '<div style="font-size:0.65rem;color:rgba(255,255,255,0.4);">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div>';
      }
      document.getElementById('profileSection').classList.remove('hidden');
      updateCardCount();
    }

    function openProfileEditModal() {
      document.getElementById('profilePhoneInput').value = customerInfo.phone || '';
      document.getElementById('bankAccountInput').value = String(customerInfo.bank_account || '').replace(/^'/, '');
      document.getElementById('profileEditModal').classList.remove('hidden');
    }

    function closeProfileEditModal() {
      document.getElementById('profileEditModal').classList.add('hidden');
    }

    async function saveProfileEdit() {
      const phone = document.getElementById('profilePhoneInput').value.trim();
      const bankAccount = document.getElementById('bankAccountInput').value.trim();

      try {
        showProcessing('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
        const body = {
          action: 'updateBankAccount',
          lineUserId: lineProfile.userId,
          custId: customerInfo.cust_id,
          bankName: 'SCB',
          bankAccount: bankAccount,
          phone: phone
        };

        const res = await fetch(CONFIG.APPS_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(body)
        });
        const result = await res.json();
        hideProcessing();

        if (result.success) {
          // Update Supabase directly too
          const updates = { bank_name: 'SCB', bank_account: bankAccount };
          if (phone) updates.phone = phone;
          await sb.from('users').update(updates).eq('cust_id', customerInfo.cust_id);

          // Update local state
          customerInfo.bank_name = 'SCB';
          customerInfo.bank_account = bankAccount;
          if (phone) customerInfo.phone = phone;
          renderProfile();
          closeProfileEditModal();
          showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
        } else {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (result.error || 'Unknown'), 'error');
        }
      } catch (e) {
        hideProcessing();
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message, 'error');
      }
    }

    function updateCardCount() {
      const avail = allCards.length;
      const total = allCards.length + allUnavailableCards.length;
      document.getElementById('cardCount').textContent = `üí≥ ‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà ${avail} / ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${total}`;
      const toggleLabel = document.getElementById('unavailToggleLabel');
      if (toggleLabel) toggleLabel.style.display = allUnavailableCards.length > 0 ? 'flex' : 'none';
    }

    function renderBankSelection() {
      const availBanks = new Set(allCards.map(c => c.bank).filter(Boolean));
      document.getElementById('bankGrid').innerHTML = CONFIG.ALLOWED_BANKS.map(bank => {
        const hasAvail = availBanks.has(bank);
        const grayClass = hasAvail ? '' : 'bank-btn-gray';
        return `<button class="bank-btn ${grayClass}" data-bank="${bank}" onclick="toggleBank('${bank}')">${bank}</button>`;
      }).join('');
      document.getElementById('bankSection').classList.remove('hidden');

      // ‡πÅ‡∏™‡∏î‡∏á Card Section ‡∏î‡πâ‡∏ß‡∏¢ (‡∏ß‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô)
      document.getElementById('cardSection').classList.remove('hidden');
      document.getElementById('cardGrid').innerHTML = '<div style="grid-column:1/-1;text-align:center;color:rgba(255,255,255,0.5);font-size:0.8rem;padding:20px;">üëÜ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</div>';
    }
    
    function toggleBank(bank) {
      const btn = document.querySelector(`.bank-btn[data-bank="${bank}"]`);
      const idx = selectedBanks.indexOf(bank);
      
      if (idx > -1) {
        selectedBanks.splice(idx, 1);
        btn.classList.remove('selected');
      } else {
        selectedBanks.push(bank);
        btn.classList.add('selected');
      }
      
      // ‚≠ê Render cards ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å/‡∏¢‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      updateFilteredCards();
    }
    
    // ‚≠ê ‡∏£‡∏ß‡∏°‡∏ö‡∏±‡∏ï‡∏£ available + unavailable (‡∏ñ‡πâ‡∏≤ toggle ‡πÄ‡∏õ‡∏¥‡∏î)
    function getDisplayCards(availableCards) {
      if (!showUnavailable) return availableCards;
      const banks = new Set(availableCards.map(c => c.bank));
      const extraCards = allUnavailableCards.filter(c =>
        availableCards.length === 0 || banks.has(c.bank)
      );
      return [...availableCards, ...extraCards];
    }

    // ‚≠ê Toggle ‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏±‡∏ï‡∏£ unavailable
    function toggleShowUnavailable() {
      showUnavailable = document.getElementById('showUnavailToggle').checked;
      if (allCards.length > CONFIG.CARD_THRESHOLD) {
        updateFilteredCards();
      } else {
        renderCards(getDisplayCards(allCards));
      }
    }

    // ‚≠ê ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ö‡∏±‡∏ï‡∏£‡∏ï‡∏≤‡∏° bank ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö unavailable)
    function updateFilteredCards() {
      if (selectedBanks.length === 0) {
        document.getElementById('cardGrid').innerHTML = '<div style="grid-column:1/-1;text-align:center;color:rgba(255,255,255,0.5);font-size:0.8rem;padding:20px;">üëÜ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</div>';
        return;
      }

      const filtered = allCards.filter(c => selectedBanks.includes(c.bank));
      const unavailFiltered = showUnavailable
        ? allUnavailableCards.filter(c => selectedBanks.includes(c.bank))
        : [];
      renderCards([...filtered, ...unavailFiltered]);
    }
    
    function renderCards(cards) {
      window.displayedCards = cards;
      
      // ‚≠ê Debug: ‡∏î‡∏π‡∏ß‡πà‡∏≤ image_url ‡∏°‡∏≤‡πÑ‡∏´‡∏°
      console.log('üé¥ Cards data:', cards.slice(0, 3).map(c => ({ 
        card_type: c.card_type, 
        image_url: c.image_url 
      })));
      
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      let html = cards.map(card => {
        const hasImage = card.image_url && card.image_url.startsWith('http');
        const imgHtml = hasImage 
          ? `<img src="${card.image_url}" class="card-bg-img" onerror="this.style.display='none'">`
          : '';
        const noImageClass = hasImage ? '' : 'no-image';
        const isSelected = selectedCards.some(c => c.card_id === card.card_id);
        const isNew = card.isNew;
        const isExisting = card.isExisting; // ‚≠ê ‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (available = false)
        const isUnavailable = card.available === false && !isNew && !isExisting;

        // ‚≠ê Badge ‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
        let badgeHtml = '';
        let deleteBtn = '';
        if (isNew) {
          badgeHtml = `<span class="new-badge">üÜï</span>`;
          deleteBtn = `<button class="delete-btn" onclick="event.stopPropagation(); deleteNewCard('${card.card_id}')">‚úï</button>`;
        } else if (isExisting) {
          badgeHtml = `<span class="new-badge" style="background:#f59e0b;">üìå</span>`;
        }

        // ‚≠ê Badge ‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà
        const unavailBadge = isUnavailable ? '<span class="unavail-badge">üö®‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà</span>' : '';
        const unavailClass = isUnavailable ? 'unavailable' : '';

        return `<div class="card-btn ${noImageClass} ${unavailClass} ${isSelected ? 'selected' : ''}"
              data-card-id="${card.card_id}"
              onclick="toggleCard('${card.card_id}')">
          ${imgHtml}
          ${unavailBadge}
          ${badgeHtml}
          ${deleteBtn}
          <div class="card-overlay">
            <div class="card-name">${truncate(card.card_type, 12)}</div>
            <div class="card-last4">${card.last4}</div>
            <div class="card-owner">${truncate(card.full_name, 12)}</div>
          </div>
          <div class="check-overlay"></div>
        </div>`;
      }).join('');
      
      // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ï‡∏£" ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢
      const remainder = cards.length % 3;
      let spanClass = '';
      if (remainder === 0) spanClass = 'span-3';      // ‡∏¢‡∏≤‡∏ß‡πÄ‡∏ï‡πá‡∏° 3 ‡∏ä‡πà‡∏≠‡∏á
      else if (remainder === 1) spanClass = 'span-2'; // ‡∏¢‡∏≤‡∏ß 2 ‡∏ä‡πà‡∏≠‡∏á
      // remainder === 2 ‚Üí ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á span (1 ‡∏ä‡πà‡∏≠‡∏á)
      
      html += `<div class="add-card-btn ${spanClass}" onclick="openAddCardModal()">
        <span>‚ûï</span>
        <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ï‡∏£</span>
      </div>`;
      
      document.getElementById('cardGrid').innerHTML = html;
      document.getElementById('cardSection').classList.remove('hidden');
    }
    
    function truncate(str, len) {
      if (!str) return '';
      return str.length > len ? str.substring(0, len) + '..' : str;
    }
    
    function toggleCard(cardId) {
      const card = window.displayedCards.find(c => c.card_id === cardId);
      if (!card) return;
      
      const idx = selectedCards.findIndex(c => c.card_id === cardId);
      
      if (idx > -1) {
        selectedCards.splice(idx, 1);
      } else {
        selectedCards.push({ ...card, amount: '' });
      }
      
      // Update UI
      document.querySelectorAll('.card-btn').forEach(btn => {
        const id = btn.dataset.cardId;
        btn.classList.toggle('selected', selectedCards.some(c => c.card_id === id));
      });
      
      updateAmountSection();
    }
    
    function updateAmountSection() {
      const amountSection = document.getElementById('amountSection');
      const extraSection = document.getElementById('extraSection');
      const submitBtn = document.getElementById('submitBtn');
      const toggleLabel = document.getElementById('toggleLabel');
      
      if (selectedCards.length === 0) {
        amountSection.classList.add('hidden');
        extraSection.classList.add('hidden');
        submitBtn.classList.add('hidden');
        return;
      }
      
      amountSection.classList.remove('hidden');
      extraSection.classList.remove('hidden');
      submitBtn.classList.remove('hidden');
      
      // Hide toggle if only 1 card
      if (selectedCards.length <= 1) {
        toggleLabel.classList.add('hidden');
        document.getElementById('sameToggle').checked = false;
      } else {
        toggleLabel.classList.remove('hidden');
      }
      
      toggleSameAmount();
    }
    
    function toggleSameAmount() {
      const isChecked = document.getElementById('sameToggle').checked;
      const sameView = document.getElementById('sameAmountView');
      const separateView = document.getElementById('separateAmountView');
      
      if (isChecked && selectedCards.length > 1) {
        sameView.classList.remove('hidden');
        separateView.classList.add('hidden');
        renderSelectedCardsDisplay();
      } else {
        sameView.classList.add('hidden');
        separateView.classList.remove('hidden');
        renderAmountGrid();
      }
    }
    
    function renderSelectedCardsDisplay() {
      document.getElementById('selectedCardsDisplay').innerHTML = selectedCards.map(card =>
        `<div class="selected-card-tag">
          <div class="name">${truncate(card.card_type, 8)} ${card.last4}</div>
          <div class="owner">${truncate(card.full_name, 12)}</div>
        </div>`
      ).join('');
    }
    
    function renderAmountGrid() {
      document.getElementById('amountGrid').innerHTML = selectedCards.map((card, i) =>
        `<div class="amount-card">
          <div class="card-header">
            <div class="card-info">
              <div class="name">${truncate(card.card_type, 8)} ${card.last4}</div>
              <div class="owner">${truncate(card.full_name, 12)}</div>
            </div>
            <button class="remove-btn" onclick="removeCard(${i})">√ó</button>
          </div>
          <div class="amount-row">
            <input type="tel" class="amount-input" placeholder="0" inputmode="decimal" 
                   data-index="${i}" value="${card.amount}" 
                   oninput="formatAmount(this); updateCardAmount(${i}, this.value)">
            <span class="currency">‡∏ö‡∏≤‡∏ó</span>
          </div>
        </div>`
      ).join('');
    }
    
    function removeCard(index) {
      const card = selectedCards[index];
      selectedCards.splice(index, 1);
      
      const btn = document.querySelector(`.card-btn[data-card-id="${card.card_id}"]`);
      if (btn) btn.classList.remove('selected');
      
      updateAmountSection();
    }
    
    function updateCardAmount(index, value) {
      selectedCards[index].amount = parseNumber(value);
    }
    
    function applyQuickAmount(amount) {
      const isChecked = document.getElementById('sameToggle').checked;
      
      if (isChecked && selectedCards.length > 1) {
        document.getElementById('globalAmount').value = amount.toLocaleString();
      } else {
        document.querySelectorAll('.amount-card .amount-input').forEach((input, i) => {
          input.value = amount.toLocaleString();
          selectedCards[i].amount = amount;
        });
      }
    }
    
    function selectShop(btn, name) {
      document.querySelectorAll('.shop-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      document.getElementById('shopInput').value = name;
    }
    
    function setDefaultDate() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('dateInput').value = today;
    }
    
    function selectDate(btn, type) {
      document.querySelectorAll('.date-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      
      const dateInput = document.getElementById('dateInput');
      const today = new Date();
      
      if (type === 'today') {
        dateInput.value = today.toISOString().split('T')[0];
        dateInput.classList.add('hidden');
      } else if (type === 'yesterday') {
        today.setDate(today.getDate() - 1);
        dateInput.value = today.toISOString().split('T')[0];
        dateInput.classList.add('hidden');
      } else {
        dateInput.classList.remove('hidden');
        dateInput.focus();
      }
    }
    
    // ============ SUBMIT (‡πÑ‡∏õ Apps Script ‚Üí Sheets) ============
    async function submitForm() {
      // Validate
      const isChecked = document.getElementById('sameToggle').checked && selectedCards.length > 1;
      
      if (isChecked) {
        const globalAmount = parseNumber(document.getElementById('globalAmount').value);
        if (!globalAmount || globalAmount <= 0) {
          showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô', 'warning');
          return;
        }
        selectedCards.forEach(card => card.amount = globalAmount);
      } else {
        const emptyCards = selectedCards.filter(c => !c.amount || c.amount <= 0);
        if (emptyCards.length > 0) {
          showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ö‡∏±‡∏ï‡∏£', 'warning');
          return;
        }
      }
      
      const dateInput = document.getElementById('dateInput').value;
      const date = formatDateThai(dateInput);
      const shopName = document.getElementById('shopInput').value.trim();
      
      const total = selectedCards.reduce((sum, c) => sum + Number(c.amount), 0);
      if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?\n\n‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${selectedCards.length} ‡∏ö‡∏±‡∏ï‡∏£\n‡∏£‡∏ß‡∏° ‡∏ø${formatDisplayAmount(total)}`)) return;
      
      setLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
      
      try {
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏õ Apps Script (‡πÑ‡∏õ Sheets ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        const response = await fetch(CONFIG.APPS_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({
            action: 'save',
            custId: customerInfo.cust_id,
            entries: selectedCards.map(c => ({
              cardId: c.card_id,
              cardType: c.card_type,
              last4: c.last4,
              fullName: c.full_name,
              typeCode: c.type_code,
              amount: Number(c.amount)
            })),
            shopName: shopName,
            date: date,
            customerInfo: {
              lineUserId: lineProfile.userId,
              displayName: lineProfile.displayName,
              fullName: customerInfo.full_name,
              phone: customerInfo.phone
            }
          })
        });
        
        const result = await response.json();
        hideLoading();
        
        if (result.success) {
          showSuccess(result.data);
        } else {
          showToast(result.message || result.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', result.success ? 'success' : 'error');
        }
        
      } catch (error) {
        hideLoading();
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
      }
    }
    
    function showSuccess(data) {
      document.getElementById('mainContent').classList.add('hidden');
      
      let html = '';
      data.entries.forEach(entry => {
        html += `<div class="item"><span>${entry.cardType} ${entry.last4}</span><span>‡∏ø${formatDisplayAmount(entry.amount)}</span></div>`;
      });
      html += `<div class="item total"><span>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span><span>‡∏ø${formatDisplayAmount(data.totalAmount)}</span></div>`;
      
      document.getElementById('successSummary').innerHTML = html;
      document.getElementById('successScreen').classList.remove('hidden');
    }
    
    function resetForm() {
      selectedCards = [];
      selectedBanks = [];
      showUnavailable = false;

      document.getElementById('successScreen').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');

      document.querySelectorAll('.card-btn').forEach(btn => btn.classList.remove('selected'));
      document.querySelectorAll('.bank-btn').forEach(btn => btn.classList.remove('selected'));
      document.getElementById('globalAmount').value = '';
      document.getElementById('shopInput').value = '';
      document.querySelectorAll('.shop-btn').forEach(b => b.classList.remove('selected'));
      selectDate(document.querySelector('.date-btn[data-type="today"]'), 'today');
      document.getElementById('sameToggle').checked = true;
      document.getElementById('showUnavailToggle').checked = false;

      // ‚≠ê ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï card grid (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ bank selection)
      if (allCards.length > CONFIG.CARD_THRESHOLD) {
        updateFilteredCards();
      }
      
      updateAmountSection();
    }
    
    function closeLiff() {
      console.log('üî¥ closeLiff called');
      
      // ‚≠ê ‡∏ß‡∏¥‡∏ò‡∏µ 1: ‡πÉ‡∏ä‡πâ liff.closeWindow()
      if (typeof liff !== 'undefined' && liff.isInClient()) {
        console.log('üî¥ Using liff.closeWindow()');
        liff.closeWindow();
      }
      
      // ‚≠ê ‡∏ß‡∏¥‡∏ò‡∏µ 2: ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î ‡∏•‡∏≠‡∏á redirect ‡∏´‡∏•‡∏±‡∏á 500ms
      setTimeout(() => {
        console.log('üî¥ Fallback: redirecting...');
        // ‡∏•‡∏≠‡∏á line:// scheme
        window.location.href = 'line://nv/chat';
      }, 500);
      
      // ‚≠ê ‡∏ß‡∏¥‡∏ò‡∏µ 3: ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î ‡∏•‡∏≠‡∏á https scheme ‡∏´‡∏•‡∏±‡∏á 1500ms
      setTimeout(() => {
        window.location.href = 'https://line.me/R/nv/chat';
      }, 1500);
    }
    
    // ============ ADD CARD MODAL ============
    let modalSelectedType = null;
    
    function openAddCardModal() {
      modalSelectedType = null;
      document.getElementById('modalLast4').value = '';
      document.getElementById('modalName').value = customerInfo.name_on_card || customerInfo.full_name || '';
      
      // ‚≠ê ‡∏´‡∏≤ banks ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô dropdown
      let banksToShow = [];
      
      if (selectedBanks.length > 0) {
        // ‡∏°‡∏µ selectedBanks ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£
        banksToShow = selectedBanks;
      } else if (allCards.length > 0) {
        // ‡πÑ‡∏°‡πà‡∏°‡∏µ selectedBanks ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ï‡∏£ ‚Üí ‡∏î‡∏∂‡∏á bank ‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ï‡∏£
        banksToShow = [...new Set(allCards.map(c => c.bank).filter(Boolean))];
      } else {
        // ‚≠ê ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏•‡∏¢ ‚Üí ‡πÉ‡∏ä‡πâ ALLOWED_BANKS ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        banksToShow = CONFIG.ALLOWED_BANKS;
      }
      
      // ‡πÅ‡∏™‡∏î‡∏á dropdown ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 bank ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
      if (banksToShow.length > 1 || allCards.length === 0) {
        document.getElementById('modalBankRow').classList.remove('hidden');
        const select = document.getElementById('modalBankSelect');
        select.innerHTML = banksToShow.map(b => `<option value="${b}">${b}</option>`).join('');
        renderModalCardTypes(banksToShow[0]);
      } else if (banksToShow.length === 1) {
        document.getElementById('modalBankRow').classList.add('hidden');
        renderModalCardTypes(banksToShow[0]);
      }
      
      // Render name suggestions
      renderNameSuggestions();
      
      validateModalForm();
      document.getElementById('addCardModal').classList.remove('hidden');
    }
    
    function closeAddCardModal() {
      document.getElementById('addCardModal').classList.add('hidden');
      window._addCardMode = null;
    }
    
    function onModalBankChange() {
      const bank = document.getElementById('modalBankSelect').value;
      modalSelectedType = null;
      renderModalCardTypes(bank);
      validateModalForm();
    }
    
    function renderModalCardTypes(bank) {
      const types = cardTypes.filter(t => t.bank === bank);
      
      document.getElementById('modalCardGrid').innerHTML = types.map(t => {
        const hasImage = t.image_url && t.image_url.startsWith('http');
        const imgStyle = hasImage ? `background-image: url('${t.image_url}')` : '';
        const noImageClass = hasImage ? '' : 'no-image';
        const isSelected = modalSelectedType === t.card_name;
        const isDisabled = modalSelectedType && !isSelected;
        
        return `<div class="modal-card-btn ${noImageClass} ${isSelected ? 'selected' : ''} ${isDisabled ? 'disabled' : ''}"
              style="${imgStyle}"
              onclick="selectModalCardType('${t.card_name.replace(/'/g, "\\'")}')">
          <div class="card-overlay">
            <div class="card-name">${t.card_name}</div>
          </div>
          <span class="check-mark">‚úì</span>
        </div>`;
      }).join('');
    }
    
    function selectModalCardType(cardName) {
      if (modalSelectedType === cardName) {
        modalSelectedType = null; // Deselect
      } else {
        modalSelectedType = cardName;
      }
      
      // Re-render with updated selection
      const bank = document.getElementById('modalBankSelect')?.value || 
                   (selectedBanks.length === 1 ? selectedBanks[0] : 
                   [...new Set(allCards.map(c => c.bank))][0]);
      renderModalCardTypes(bank);
      validateModalForm();
    }
    
    function renderNameSuggestions() {
      // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ
      const names = [...new Set(allCards.map(c => c.full_name).filter(Boolean))].slice(0, 3);
      
      document.getElementById('modalNameSuggest').innerHTML = names.map(name => {
        // ‚≠ê ‡∏ï‡∏±‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô 15 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£
        const displayName = name.length > 15 ? name.substring(0, 15) + '..' : name;
        return `<button class="modal-suggest-btn" onclick="selectNameSuggestion('${name.replace(/'/g, "\\'")}')" title="${name}">${displayName}</button>`;
      }).join('');
    }
    
    function selectNameSuggestion(name) {
      document.getElementById('modalName').value = name;
      validateModalForm();
    }
    
    function validateModalForm() {
      const last4 = document.getElementById('modalLast4').value.trim();
      const name = document.getElementById('modalName').value.trim();
      const isValid = modalSelectedType && last4.length === 4 && name.length > 0;
      document.getElementById('modalConfirmBtn').disabled = !isValid;
    }
    
    async function confirmAddCard() {
      // ‚≠ê ‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡∏à‡∏≤‡∏Å Tab ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‚Üí ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á
      if (window._addCardMode === 'request') {
        await confirmAddCardRequest();
        return;
      }

      const last4 = document.getElementById('modalLast4').value.trim();
      const name = document.getElementById('modalName').value.trim();

      if (!modalSelectedType || last4.length !== 4 || !name) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'warning');
        return;
      }
      
      // ‚≠ê 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏ô allCards ‡∏Å‡πà‡∏≠‡∏ô (‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà available = true)
      const duplicateInUI = allCards.find(c => 
        c.card_type === modalSelectedType && c.last4 === last4
      );
      
      if (duplicateInUI) {
        if (confirm(`‡∏ö‡∏±‡∏ï‡∏£ ${modalSelectedType} ${last4} ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ï‡∏£‡∏ô‡∏µ‡πâ‡πÅ‡∏ó‡∏ô‡πÑ‡∏´‡∏°?`)) {
          if (!selectedCards.some(c => c.card_id === duplicateInUI.card_id)) {
            selectedCards.push({ ...duplicateInUI, amount: '' });
          }
          closeAddCardModal();
          refreshCardGrid();
          updateAmountSection();
        }
        return;
      }
      
      // ‚≠ê 2. Query Supabase ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ö‡∏±‡∏ï‡∏£‡∏ã‡πâ‡∏≥ (‡∏£‡∏ß‡∏° available = false)
      try {
        const { data: existingCard, error } = await sb
          .from('cards')
          .select('*')
          .eq('cust_id', customerInfo.cust_id)
          .eq('card_type', modalSelectedType)
          .eq('last4', last4)
          .maybeSingle();
        
        if (existingCard) {
          // ‚≠ê ‡πÄ‡∏à‡∏≠‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‚Üí ‡πÉ‡∏ä‡πâ card_id ‡πÄ‡∏î‡∏¥‡∏° ‡πÑ‡∏°‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
          console.log('üîç ‡∏û‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö:', existingCard);
          
          const card = {
            ...existingCard,
            full_name: name,  // ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà
            isExisting: true  // flag ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
          };
          
          // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ displayedCards (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ)
          if (!window.displayedCards.some(c => c.card_id === card.card_id)) {
            window.displayedCards.push(card);
          }
          
          // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ selectedCards
          if (!selectedCards.some(c => c.card_id === card.card_id)) {
            selectedCards.push({ ...card, amount: '' });
          }
          
          closeAddCardModal();
          refreshCardGrid();
          updateAmountSection();
          return;
        }
      } catch (e) {
        console.error('Error checking existing card:', e);
      }
      
      // ‚≠ê 3. ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏î‡∏¥‡∏° ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà
      const typeInfo = cardTypes.find(t => t.card_name === modalSelectedType) || {};
      const newCard = {
        card_id: 'NEW_' + Date.now(),
        card_type: modalSelectedType,
        last4: last4,
        full_name: name,
        bank: typeInfo.bank || '',
        type_code: typeInfo.type_code || '',
        image_url: typeInfo.image_url || '',
        isNew: true
      };
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ displayedCards ‡πÅ‡∏•‡∏∞ selectedCards
      window.displayedCards.push(newCard);
      selectedCards.push({ ...newCard, amount: '' });
      
      closeAddCardModal();
      refreshCardGrid();
      updateAmountSection();
    }
    
    function deleteNewCard(cardId) {
      // ‡∏•‡∏ö‡∏à‡∏≤‡∏Å displayedCards
      const idx = window.displayedCards.findIndex(c => c.card_id === cardId);
      if (idx > -1) window.displayedCards.splice(idx, 1);
      
      // ‡∏•‡∏ö‡∏à‡∏≤‡∏Å selectedCards
      const selIdx = selectedCards.findIndex(c => c.card_id === cardId);
      if (selIdx > -1) selectedCards.splice(selIdx, 1);
      
      refreshCardGrid();
      updateAmountSection();
    }
    
    function refreshCardGrid() {
      renderCards(window.displayedCards);
      // Re-apply selection state
      document.querySelectorAll('.card-btn').forEach(btn => {
        const id = btn.dataset.cardId;
        if (id) {
          btn.classList.toggle('selected', selectedCards.some(c => c.card_id === id));
        }
      });
    }
    
    // ============ HELPERS ============
    function formatAmount(input) {
      // ‚≠ê ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°
      let value = input.value.replace(/[^0-9.]/g, '');
      
      // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô . ‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏±‡∏ß
      const parts = value.split('.');
      if (parts.length > 2) {
        value = parts[0] + '.' + parts.slice(1).join('');
      }
      
      // Format ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°
      if (value) {
        let [intPart, decPart] = value.split('.');
        const formattedInt = intPart ? parseInt(intPart).toLocaleString() : '0';
        
        if (decPart !== undefined) {
          // ‚≠ê ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° 2 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
          decPart = decPart.substring(0, 2);
          value = formattedInt + '.' + decPart;
        } else {
          value = formattedInt;
        }
      }
      
      input.value = value;
    }
    
    function parseNumber(str) {
      if (!str) return 0;
      // ‚≠ê ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°
      return parseFloat(String(str).replace(/[^0-9.]/g, '')) || 0;
    }
    
    // ‚≠ê Format ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°‡πÅ‡∏™‡∏î‡∏á 2 ‡∏à‡∏∏‡∏î, ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á
    function formatDisplayAmount(num) {
      if (!num && num !== 0) return '0';
      const n = parseFloat(num);
      if (Number.isInteger(n)) {
        return n.toLocaleString(); // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°
      } else {
        return n.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }
    }
    
    function formatDateThai(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear() + 543;
      return `${day}/${month}/${year}`;
    }
    
    // ‚≠ê Toast Popup (‡πÅ‡∏ó‡∏ô browser alert)
    function showToast(message, type = 'success', duration = 2500) {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      const bgColor = type === 'success' ? 'rgba(16,185,129,0.95)'
                    : type === 'error' ? 'rgba(239,68,68,0.95)'
                    : type === 'warning' ? 'rgba(245,158,11,0.95)'
                    : 'rgba(78,205,196,0.95)';
      toast.style.cssText = `background:${bgColor};color:#fff;padding:14px 24px;border-radius:12px;font-size:0.85rem;line-height:1.5;text-align:center;pointer-events:auto;box-shadow:0 8px 32px rgba(0,0,0,0.3);max-width:300px;animation:toastIn 0.3s ease;white-space:pre-line;`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => {
        toast.style.animation = 'toastOut 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    function showProcessing(text = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...') {
      document.getElementById('processingText').textContent = text;
      document.getElementById('processingOverlay').classList.remove('hidden');
    }

    function hideProcessing() {
      document.getElementById('processingOverlay').classList.add('hidden');
    }

    function setLoading(text) {
      document.getElementById('loadingText').textContent = text;
      document.getElementById('loadingOverlay').classList.remove('hidden');
    }
    
    function hideLoading() {
      document.getElementById('loadingOverlay').classList.add('hidden');
    }
    
    function showError(message) {
      hideLoading();
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('mainContent').classList.add('hidden');
      document.getElementById('errorScreen').classList.remove('hidden');
    }
    
    // ============ START ============
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
