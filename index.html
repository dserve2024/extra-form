<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>D-SERVE ‡πÅ‡∏à‡πâ‡∏á‡∏¢‡∏≠‡∏î‡∏ô‡∏≠‡∏Å‡∏£‡∏≠‡∏ö</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Prompt', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 12px;
      padding-bottom: 20px;
    }
    
    .container { max-width: 400px; margin: 0 auto; }
    
    /* Header */
    .header {
      text-align: center;
      padding: 6px 0 10px;
      color: #fff;
    }
    .header h1 { font-size: 1rem; font-weight: 600; }
    
    /* Profile */
    .profile-box {
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 10px 12px;
      margin-bottom: 10px;
      border: 1px solid rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .profile-img {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid rgba(255,255,255,0.3);
      flex-shrink: 0;
    }
    
    .profile-info { flex: 1; min-width: 0; }
    
    .profile-row1 {
      font-size: 0.85rem;
      color: #fff;
      font-weight: 600;
    }
    
    .profile-row2 {
      font-size: 0.7rem;
      color: rgba(255,255,255,0.8);
      margin-top: 2px;
    }
    
    /* Section */
    .section-box {
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 8px;
      margin-bottom: 8px;
    }
    
    .section-title {
      font-size: 0.65rem;
      color: rgba(255,255,255,0.7);
      margin-bottom: 6px;
    }
    
    /* Bank Grid - 4 per row */
    .bank-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 5px;
    }
    
    .bank-btn {
      padding: 8px 4px;
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 6px;
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-size: 0.7rem;
      font-weight: 600;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .bank-btn:hover { background: rgba(255,255,255,0.2); }
    .bank-btn.selected { background: rgba(0,208,132,0.3); border-color: #00d084; }
    
    /* Card Grid - 3 per row ‚≠ê COMPACT */
    .card-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }
    
    .card-btn {
      position: relative;
      aspect-ratio: 1.5; /* ‚≠ê ‡πÅ‡∏ö‡∏ô‡∏•‡∏á‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ */
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      background-color: rgba(255,255,255,0.1);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      cursor: pointer;
      transition: all 0.2s;
      overflow: hidden;
    }
    
    .card-btn:hover { 
      border-color: rgba(255,255,255,0.5);
      transform: scale(1.02);
    }
    
    .card-btn.selected { 
      border-color: #00d084; 
      box-shadow: 0 0 0 1px rgba(0,208,132,0.5);
    }
    
    /* Overlay - ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡∏≤‡∏á‡∏£‡∏π‡∏õ ‚≠ê COMPACT */
    .card-btn .card-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      background: rgba(0,0,0,0.45);
      padding: 2px;
    }
    
    .card-btn .card-name {
      font-size: 0.55rem;
      color: #fff;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 95%;
      text-shadow: 0 1px 2px rgba(0,0,0,0.9);
    }
    
    .card-btn .card-last4 {
      font-size: 0.8rem;
      color: #fff;
      font-weight: 700;
      letter-spacing: 1px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.9);
      margin-top: 1px;
    }
    
    /* ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ */
    .card-btn.no-image {
      background: linear-gradient(135deg, #3a3a5c 0%, #2a2a4c 100%);
    }
    
    .card-btn.no-image .card-overlay {
      background: transparent;
    }
    
    /* ‚≠ê ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ö‡∏±‡∏ï‡∏£ */
    .card-btn .card-bg-img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 6px;
    }
    
    /* ‚≠ê Checkmark overlay ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */
    .card-btn .check-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 208, 132, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 0.2s;
      border-radius: 6px;
      z-index: 10;
    }
    
    .card-btn .check-overlay::after {
      content: '‚úì';
      font-size: 1.8rem;
      color: #fff;
      font-weight: bold;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .card-btn.selected .check-overlay {
      opacity: 1;
    }
    
    /* ‚≠ê ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ï‡∏£ - COMPACT */
    .add-card-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      border: 2px dashed rgba(255,255,255,0.4);
      border-radius: 8px;
      background: rgba(255,255,255,0.05);
      color: rgba(255,255,255,0.8);
      font-size: 0.65rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 50px;
    }
    .add-card-btn:hover {
      background: rgba(0,208,132,0.2);
      border-color: #00d084;
      color: #fff;
    }
    .add-card-btn.span-2 { grid-column: span 2; }
    .add-card-btn.span-3 { grid-column: span 3; }
    
    /* ‚≠ê Badge ‡πÉ‡∏´‡∏°‡πà ‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö - COMPACT */
    .card-btn .new-badge {
      position: absolute;
      top: 2px;
      left: 2px;
      background: #00d084;
      color: #fff;
      font-size: 0.45rem;
      font-weight: 700;
      padding: 1px 3px;
      border-radius: 3px;
      z-index: 15;
    }
    .card-btn .delete-btn {
      position: absolute;
      top: 1px;
      right: 1px;
      width: 16px;
      height: 16px;
      background: rgba(255,0,0,0.8);
      color: #fff;
      border: none;
      border-radius: 50%;
      font-size: 0.6rem;
      cursor: pointer;
      z-index: 15;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .card-btn .delete-btn:hover { background: #ff0000; }
    
    /* ‚≠ê Modal ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ï‡∏£ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 16px;
    }
    .modal-overlay.hidden { display: none; }
    
    .modal-box {
      background: linear-gradient(135deg, #4a4a6a 0%, #3a3a5c 100%);
      border-radius: 16px;
      width: 100%;
      max-width: 360px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.4);
    }
    
    .modal-header {
      padding: 12px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-size: 0.9rem;
      font-weight: 600;
      color: #fff;
      text-align: center;
    }
    
    .modal-body { padding: 12px; }
    
    .modal-label {
      font-size: 0.7rem;
      color: rgba(255,255,255,0.7);
      margin-bottom: 6px;
    }
    
    .modal-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    
    /* ‚≠ê ‡∏ö‡∏ô‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å ‡πÉ‡∏´‡πâ input ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà */
    @media (max-width: 360px) {
      .modal-row {
        flex-direction: column;
        align-items: stretch;
      }
      .modal-row .modal-label { margin-bottom: 4px; }
      .modal-input-sm { width: 100%; }
    }
    
    .modal-select {
      flex: 1;
      padding: 8px 10px;
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-size: 0.8rem;
      font-family: 'Prompt', sans-serif;
    }
    .modal-select option { background: #3a3a5c; color: #fff; }
    
    .modal-input {
      flex: 1;
      padding: 8px 10px;
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-size: 0.85rem;
      font-family: 'Prompt', sans-serif;
    }
    .modal-input::placeholder { color: rgba(255,255,255,0.4); }
    .modal-input:focus { outline: none; border-color: #00d084; }
    
    .modal-input-sm { width: 80px; flex: none; text-align: center; letter-spacing: 2px; }
    
    /* Modal Card Type Grid */
    .modal-card-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      margin-bottom: 10px;
      max-height: 180px;
      overflow-y: auto;
    }
    
    .modal-card-btn {
      position: relative;
      aspect-ratio: 1.586;
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      background-size: cover;
      background-position: center;
      cursor: pointer;
      overflow: hidden;
      transition: all 0.2s;
    }
    .modal-card-btn.no-image {
      background: linear-gradient(135deg, #3a3a5c 0%, #2a2a4c 100%);
    }
    .modal-card-btn:hover { border-color: rgba(255,255,255,0.5); }
    .modal-card-btn.selected { border-color: #00d084; box-shadow: 0 0 0 2px rgba(0,208,132,0.5); }
    .modal-card-btn.disabled { opacity: 0.3; pointer-events: none; }
    
    .modal-card-btn .card-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 4px;
    }
    .modal-card-btn .card-name {
      font-size: 0.55rem;
      color: #fff;
      font-weight: 600;
      text-align: center;
      text-shadow: 0 1px 2px rgba(0,0,0,0.8);
    }
    .modal-card-btn .check-mark {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.5rem;
      color: #00d084;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
      display: none;
    }
    .modal-card-btn.selected .check-mark { display: block; }
    .modal-card-btn.selected .card-overlay { background: rgba(0,208,132,0.5); }
    
    /* Modal Suggest Buttons */
    .modal-suggest {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .modal-suggest-btn {
      padding: 4px 8px;
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 6px;
      background: rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.8);
      font-size: 0.6rem;
      cursor: pointer;
      transition: all 0.2s;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex: 0 1 auto;
    }
    .modal-suggest-btn:hover { background: rgba(0,208,132,0.3); border-color: #00d084; }
    
    /* ‚≠ê ‡∏ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡∏ß ‡πÉ‡∏´‡πâ‡∏¢‡πà‡∏≠ */
    @media (max-width: 400px) {
      .modal-suggest-btn {
        max-width: 45%;
      }
    }
    
    /* Modal Footer */
    .modal-footer {
      display: flex;
      gap: 10px;
      padding: 12px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    .modal-btn {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Prompt', sans-serif;
    }
    .modal-btn-cancel {
      background: rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.8);
    }
    .modal-btn-confirm {
      background: #00d084;
      color: #fff;
    }
    .modal-btn-confirm:disabled {
      background: rgba(255,255,255,0.2);
      color: rgba(255,255,255,0.4);
      cursor: not-allowed;
    }
    
    /* Amount Section */
    .amount-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .toggle-same {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.7rem;
      color: rgba(255,255,255,0.9);
      cursor: pointer;
    }
    
    .toggle-same input {
      width: 16px;
      height: 16px;
      accent-color: #00d084;
    }
    
    /* Quick Amount - Bigger */
    .quick-btns {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    
    .quick-btn {
      flex: 1;
      padding: 12px 8px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 10px;
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .quick-btn:hover { background: rgba(0,208,132,0.3); border-color: #00d084; }
    
    /* Global Amount (Toggle ON) */
    .global-amount-box {
      background: rgba(0,208,132,0.2);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 10px;
    }
    
    .global-amount-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .global-amount-row label {
      font-size: 0.8rem;
      color: #fff;
      white-space: nowrap;
    }
    
    .amount-input {
      flex: 1;
      padding: 12px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 8px;
      background: rgba(255,255,255,0.15);
      color: #fff;
      font-size: 1.1rem;
      text-align: right;
      font-family: 'Prompt', sans-serif;
    }
    
    .amount-input:focus { outline: none; border-color: #00d084; }
    .amount-input::placeholder { color: rgba(255,255,255,0.4); }
    
    .currency { color: rgba(255,255,255,0.8); font-size: 0.9rem; }
    
    /* Selected Cards Display (Toggle ON) */
    .selected-cards-display {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
    }
    
    .selected-card-tag {
      background: rgba(0,208,132,0.2);
      border: 1px solid rgba(0,208,132,0.4);
      border-radius: 8px;
      padding: 8px;
      text-align: center;
    }
    
    .selected-card-tag .name {
      font-size: 0.75rem;
      color: #fff;
      font-weight: 600;
    }
    
    .selected-card-tag .owner {
      font-size: 0.65rem;
      color: rgba(255,255,255,0.7);
    }
    
    /* Amount Grid (Toggle OFF) - 2 per row */
    .amount-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
    }
    
    .amount-grid.has-odd-last > .amount-card:last-child:nth-child(odd) {
      grid-column: 1 / -1;
    }
    
    .amount-card {
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      padding: 8px;
      min-width: 0;
    }
    
    .amount-card .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 6px;
    }
    
    .amount-card .card-info {
      min-width: 0;
      flex: 1;
    }
    
    .amount-card .card-info .name {
      font-size: 0.75rem;
      color: #fff;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .amount-card .card-info .owner {
      font-size: 0.6rem;
      color: rgba(255,255,255,0.6);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .remove-btn {
      background: rgba(255,100,100,0.3);
      border: none;
      color: #ff6b6b;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 0.8rem;
      line-height: 1;
      flex-shrink: 0;
      margin-left: 4px;
    }
    
    .amount-card .amount-row {
      position: relative;
    }
    
    .amount-card .amount-input {
      width: 100%;
      padding: 10px 35px 10px 10px;
      font-size: 0.95rem;
      text-align: right;
    }
    
    .amount-card .currency {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.75rem;
      color: rgba(255,255,255,0.6);
      pointer-events: none;
    }
    
    /* Date */
    .date-row {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
    }
    
    .date-btn {
      flex: 1;
      padding: 10px;
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      background: transparent;
      color: #fff;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .date-btn.selected { background: rgba(0,208,132,0.3); border-color: #00d084; }
    
    /* Shop */
    .shop-suggestions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    
    .shop-btn {
      padding: 8px 14px;
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 16px;
      background: transparent;
      color: #fff;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .shop-btn:hover, .shop-btn.selected { background: rgba(0,208,132,0.3); border-color: #00d084; }
    
    .shop-input {
      width: 100%;
      padding: 10px;
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-size: 0.85rem;
      font-family: 'Prompt', sans-serif;
    }
    
    .shop-input::placeholder { color: rgba(255,255,255,0.4); }
    .shop-input:focus { outline: none; border-color: #00d084; }
    
    /* Submit */
    .submit-btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 12px;
      background: linear-gradient(135deg, #00d084, #00b894);
      color: #fff;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Prompt', sans-serif;
      transition: all 0.2s;
    }
    
    .submit-btn:hover { transform: translateY(-1px); }
    .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .load-cards-btn {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(135deg, #00d084, #00b894);
      color: #fff;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Prompt', sans-serif;
    }
    
    /* Loading */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .loading-overlay.hidden { display: none; }
    
    .loading-content { text-align: center; color: #fff; }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255,255,255,0.3);
      border-top-color: #00d084;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 12px;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Error */
    .error-box {
      background: rgba(255,100,100,0.2);
      border: 1px solid rgba(255,100,100,0.4);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    
    .error-box .icon { font-size: 2rem; margin-bottom: 10px; }
    .error-box .title { font-size: 1rem; color: #fff; font-weight: 600; margin-bottom: 5px; }
    .error-box .message { font-size: 0.8rem; color: rgba(255,255,255,0.8); }
    
    /* Success */
    .success-box {
      background: rgba(0,208,132,0.2);
      border: 1px solid rgba(0,208,132,0.4);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    
    .success-box .icon { font-size: 2.5rem; margin-bottom: 10px; }
    .success-box .title { font-size: 1.1rem; color: #fff; font-weight: 600; margin-bottom: 10px; }
    
    .success-summary {
      text-align: left;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      padding: 12px;
      margin: 10px 0;
    }
    
    .success-summary .item {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      font-size: 0.8rem;
      color: rgba(255,255,255,0.9);
    }
    
    .success-summary .total {
      border-top: 1px solid rgba(255,255,255,0.2);
      margin-top: 8px;
      padding-top: 8px;
      font-weight: 600;
    }
    
    .btn-group {
      display: flex;
      gap: 8px;
      margin-top: 15px;
    }
    
    .btn-secondary {
      flex: 1;
      padding: 12px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 10px;
      background: transparent;
      color: #fff;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Prompt', sans-serif;
    }
    
    /* Speed indicator */
    .speed-badge {
      display: inline-block;
      padding: 2px 8px;
      background: rgba(0,208,132,0.3);
      border-radius: 10px;
      font-size: 0.6rem;
      color: #00d084;
      margin-left: 8px;
    }
    
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>üí≥ D-SERVE ‡πÅ‡∏à‡πâ‡∏á‡∏¢‡∏≠‡∏î‡∏ô‡∏≠‡∏Å‡∏£‡∏≠‡∏ö <span class="speed-badge">‚ö° Supabase</span></h1>
    </div>
    
    <!-- Error Screen -->
    <div id="errorScreen" class="section-box hidden">
      <div class="error-box">
        <div class="icon">‚ùå</div>
        <div class="title">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</div>
        <div class="message" id="errorMessage">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</div>
      </div>
    </div>
    
    <!-- Success Screen -->
    <div id="successScreen" class="section-box hidden">
      <div class="success-box">
        <div class="icon">‚úÖ</div>
        <div class="title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>
        <div class="success-summary" id="successSummary"></div>
        <div class="btn-group">
          <button class="btn-secondary" onclick="resetForm()">üîÑ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</button>
          <button class="btn-secondary" onclick="closeLiff()">‚úï ‡∏õ‡∏¥‡∏î</button>
        </div>
      </div>
    </div>
    
    <!-- Main Content -->
    <div id="mainContent">
      <!-- Profile -->
      <div id="profileSection" class="profile-box hidden">
        <img id="profileImg" class="profile-img" src="" onerror="this.src='https://via.placeholder.com/44/666/fff?text=üë§'">
        <div class="profile-info">
          <div class="profile-row1" id="profileRow1">-</div>
          <div class="profile-row2" id="profileRow2">-</div>
        </div>
      </div>
      
      <!-- Bank Selection (>8 cards) -->
      <div id="bankSection" class="section-box hidden">
        <div class="section-title">üè¶ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ (‡∏Å‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£)</div>
        <div class="bank-grid" id="bankGrid"></div>
      </div>
      
      <!-- Card Selection -->
      <div id="cardSection" class="section-box hidden">
        <div class="section-title">üí≥ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ï‡∏£</div>
        <div class="card-grid" id="cardGrid"></div>
      </div>
      
      <!-- Amount Entry -->
      <div id="amountSection" class="section-box hidden">
        <div class="amount-header">
          <div class="section-title" style="margin:0;">üí∞ ‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î</div>
          <label class="toggle-same" id="toggleLabel">
            <input type="checkbox" id="sameToggle" checked onchange="toggleSameAmount()">
            <span>‡∏¢‡∏≠‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô</span>
          </label>
        </div>
        
        <!-- Quick Amount -->
        <div class="quick-btns" id="quickBtns">
          <button class="quick-btn" onclick="applyQuickAmount(5000)">‡∏ø5,000</button>
          <button class="quick-btn" onclick="applyQuickAmount(10000)">‡∏ø10,000</button>
          <button class="quick-btn" onclick="applyQuickAmount(15000)">‡∏ø15,000</button>
        </div>
        
        <!-- Toggle ON: Single input + card tags -->
        <div id="sameAmountView">
          <div class="global-amount-box">
            <div class="global-amount-row">
              <label>‡∏¢‡∏≠‡∏î‡∏ó‡∏∏‡∏Å‡πÉ‡∏ö:</label>
              <input type="tel" id="globalAmount" class="amount-input" placeholder="0" inputmode="decimal" oninput="formatAmount(this)">
              <span class="currency">‡∏ö‡∏≤‡∏ó</span>
            </div>
          </div>
          <div class="selected-cards-display" id="selectedCardsDisplay"></div>
        </div>
        
        <!-- Toggle OFF: Individual inputs -->
        <div id="separateAmountView" class="hidden">
          <div class="amount-grid has-odd-last" id="amountGrid"></div>
        </div>
      </div>
      
      <!-- Date & Shop -->
      <div id="extraSection" class="section-box hidden">
        <div class="section-title">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏î</div>
        <div class="date-row">
          <button class="date-btn selected" data-type="today" onclick="selectDate(this,'today')">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
          <button class="date-btn" data-type="yesterday" onclick="selectDate(this,'yesterday')">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô</button>
          <button class="date-btn" data-type="custom" onclick="selectDate(this,'custom')">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏á</button>
        </div>
        <input type="date" id="dateInput" class="shop-input hidden" style="margin-bottom:10px;">
        
        <div class="section-title">üè™ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</div>
        <div class="shop-suggestions" id="shopSuggestions"></div>
        <input type="text" id="shopInput" class="shop-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤...">
      </div>
      
      <!-- Submit -->
      <button id="submitBtn" class="submit-btn hidden" onclick="submitForm()">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>
  </div>
  
  <!-- Loading -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div id="loadingText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </div>
  </div>
  
  <!-- ‚≠ê Modal ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ï‡∏£ -->
  <div id="addCardModal" class="modal-overlay hidden">
    <div class="modal-box">
      <div class="modal-header">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà</div>
      <div class="modal-body">
        <!-- Bank Selector (‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢ bank) -->
        <div id="modalBankRow" class="modal-row hidden">
          <span class="modal-label" style="margin:0;white-space:nowrap;">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£:</span>
          <select id="modalBankSelect" class="modal-select" onchange="onModalBankChange()"></select>
        </div>
        
        <!-- Card Types Grid -->
        <div class="modal-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£:</div>
        <div id="modalCardGrid" class="modal-card-grid"></div>
        
        <!-- Last4 + Name Row -->
        <div class="modal-row">
          <span class="modal-label" style="margin:0;white-space:nowrap;">4 ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢:</span>
          <input type="tel" id="modalLast4" class="modal-input modal-input-sm" maxlength="4" placeholder="0000" oninput="validateModalForm()">
          <span class="modal-label" style="margin:0;white-space:nowrap;">‡∏ä‡∏∑‡πà‡∏≠:</span>
          <input type="text" id="modalName" class="modal-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏ô‡∏ö‡∏±‡∏ï‡∏£" oninput="validateModalForm()">
        </div>
        
        <!-- Name Suggestions -->
        <div id="modalNameSuggest" class="modal-suggest"></div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-cancel" onclick="closeAddCardModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button id="modalConfirmBtn" class="modal-btn modal-btn-confirm" onclick="confirmAddCard()" disabled>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ï‡∏£</button>
      </div>
    </div>
  </div>

  <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ‚ö†Ô∏è CONFIG - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ!
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const CONFIG = {
      // LINE LIFF
      LIFF_ID: '2008957662-eSzXKJNi',
      
      // Supabase (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• - ‡πÄ‡∏£‡πá‡∏ß!)
      SUPABASE_URL: 'https://momguihyvsjuexpficdf.supabase.co',
      SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1vbWd1aWh5dnNqdWV4cGZpY2RmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxODQ0ODUsImV4cCI6MjA4NDc2MDQ4NX0.nkdyabWT39acE9ib_BEsTXcKsDpal_myX9PbLvHUnlk',
      
      // Apps Script (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å - ‡πÑ‡∏õ Sheets ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
      APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbyghkPL3lSsZpm_DKZz78f2MseanH8HUQ92CfaVb6r3MvCs1TgUcXhdm9sX-JiI7t_Z/exec',
      
      // Threshold
      CARD_THRESHOLD: 8,
      
      // ‚≠ê Allowed Banks (‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏Ñ‡πà‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
      ALLOWED_BANKS: ['KCC', 'KFV', 'LOTUS', 'THE1', 'KBANK', 'SCB', 'TTB', 'UOB']
    };
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    // Supabase Client
    let sb;
    
    // State
    let lineProfile = null;
    let customerInfo = null;
    let allCards = [];
    let selectedBanks = [];
    let selectedCards = [];
    let recentAmounts = [5000, 10000, 15000]; // ‚≠ê Default values
    let recentShops = []; // ‚≠ê ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    let cardTypes = []; // ‚≠ê ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ï‡∏£)
    
    // ============ INIT ============
    async function init() {
      const startTime = performance.now();
      
      try {
        // Check config
        if (CONFIG.LIFF_ID === 'YOUR_LIFF_ID_HERE') {
          showError('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LIFF_ID');
          return;
        }
        if (CONFIG.SUPABASE_URL === 'https://YOUR_PROJECT_ID.supabase.co') {
          showError('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ SUPABASE_URL');
          return;
        }
        
        // Init Supabase
        sb = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        
        setLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE...');
        await liff.init({ liffId: CONFIG.LIFF_ID });
        
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        
        // Get LINE profile
        lineProfile = await liff.getProfile();
        
        // ‚ö° Query ‡∏à‡∏≤‡∏Å Supabase (‡πÄ‡∏£‡πá‡∏ß‡∏°‡∏≤‡∏Å!)
        setLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
        
        // Query user
        const { data: userData, error: userError } = await sb
          .from('users')
          .select('*')
          .eq('line_user_id', lineProfile.userId)
          .single();
        
        if (userError || !userData) {
          showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Admin');
          return;
        }
        
        customerInfo = userData;
        
        // Query cards
        const { data: cardsData, error: cardsError } = await sb
          .from('cards')
          .select('*')
          .eq('cust_id', customerInfo.cust_id)
          .eq('available', true);
        
        if (cardsError) {
          console.error('Cards error:', cardsError);
        }
        
        // ‚≠ê ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ banks ‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï
        allCards = (cardsData || []).filter(card => 
          CONFIG.ALLOWED_BANKS.includes(card.bank)
        );
        
        // ‚≠ê ‡∏î‡∏∂‡∏á cardTypes ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ï‡∏£
        const { data: typesData } = await sb
          .from('card_types')
          .select('*')
          .in('bank', CONFIG.ALLOWED_BANKS);
        cardTypes = typesData || [];
        
        // ‚≠ê ‡∏î‡∏∂‡∏á Recent Data (‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡∏∞‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î) ‡πÅ‡∏ö‡∏ö Background
        loadRecentData(customerInfo.cust_id);
        
        // Render UI
        renderProfile();
        setDefaultDate();
        
        // Check if need bank selection
        if (allCards.length > CONFIG.CARD_THRESHOLD) {
          renderBankSelection();
        } else {
          renderCards(allCards);
        }
        
        hideLoading();
        
        // Log performance
        const endTime = performance.now();
        console.log(`‚ö° Load time: ${Math.round(endTime - startTime)}ms`);
        
      } catch (error) {
        console.error('Init error:', error);
        showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
      }
    }
    
    // ============ RECENT DATA (‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡∏∞‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î) ============
    /**
     * ‚≠ê ‡∏î‡∏∂‡∏á‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡∏∞‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Supabase (Background)
     */
    async function loadRecentData(custId) {
      try {
        const { data, error } = await sb
          .from('extra')
          .select('amount, shop_name')
          .eq('cust_id', custId)
          .order('timestamp', { ascending: false })
          .limit(20);
        
        if (error) {
          console.error('Recent data error:', error);
          return;
        }
        
        if (!data || data.length === 0) {
          console.log('No recent data found');
          return;
        }
        
        // ‡∏î‡∏∂‡∏á 3 ‡∏¢‡∏≠‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥
        const seenAmounts = new Set();
        const amounts = [];
        for (const row of data) {
          const amount = Number(row.amount);
          if (amount > 0 && !seenAmounts.has(amount) && amounts.length < 3) {
            amounts.push(amount);
            seenAmounts.add(amount);
          }
        }
        
        // ‡∏î‡∏∂‡∏á 3 ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥
        const seenShops = new Set();
        const shops = [];
        for (const row of data) {
          const shop = String(row.shop_name || '').trim();
          if (shop && !seenShops.has(shop.toLowerCase()) && shops.length < 3) {
            shops.push(shop);
            seenShops.add(shop.toLowerCase());
          }
        }
        
        // Update state
        if (amounts.length > 0) recentAmounts = amounts;
        if (shops.length > 0) recentShops = shops;
        
        // Render UI
        renderQuickAmounts();
        renderShopSuggestions();
        
        console.log('‚úÖ Recent data loaded:', { amounts, shops });
        
      } catch (error) {
        console.error('loadRecentData error:', error);
      }
    }
    
    /**
     * ‚≠ê Render Quick Amount buttons
     */
    function renderQuickAmounts() {
      const container = document.getElementById('quickBtns');
      if (!container) return;
      
      container.innerHTML = recentAmounts.map(amount =>
        `<button class="quick-btn" onclick="applyQuickAmount(${amount})">‡∏ø${amount.toLocaleString()}</button>`
      ).join('');
    }
    
    /**
     * ‚≠ê Render Shop Suggestions
     */
    function renderShopSuggestions() {
      const container = document.getElementById('shopSuggestions');
      if (!container) return;
      
      if (recentShops.length === 0) {
        container.innerHTML = '';
        return;
      }
      
      container.innerHTML = recentShops.map(shop =>
        `<button class="shop-btn" onclick="selectShop(this, '${shop.replace(/'/g, "\\'")}')">${shop}</button>`
      ).join('');
    }
    
    // ============ RENDER ============
    function renderProfile() {
      document.getElementById('profileImg').src = lineProfile.pictureUrl || '';
      document.getElementById('profileRow1').textContent = `${customerInfo.cust_id} | ${lineProfile.displayName}`;
      document.getElementById('profileRow2').textContent = customerInfo.full_name || customerInfo.name_on_card || '-';
      document.getElementById('profileSection').classList.remove('hidden');
    }
    
    function renderBankSelection() {
      const banks = [...new Set(allCards.map(c => c.bank).filter(Boolean))];
      document.getElementById('bankGrid').innerHTML = banks.map(bank =>
        `<button class="bank-btn" data-bank="${bank}" onclick="toggleBank('${bank}')">${bank}</button>`
      ).join('');
      document.getElementById('bankSection').classList.remove('hidden');
      
      // ‚≠ê ‡πÅ‡∏™‡∏î‡∏á Card Section ‡∏î‡πâ‡∏ß‡∏¢ (‡∏ß‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô)
      document.getElementById('cardSection').classList.remove('hidden');
      document.getElementById('cardGrid').innerHTML = '<div style="grid-column:1/-1;text-align:center;color:rgba(255,255,255,0.5);font-size:0.8rem;padding:20px;">üëÜ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</div>';
    }
    
    function toggleBank(bank) {
      const btn = document.querySelector(`.bank-btn[data-bank="${bank}"]`);
      const idx = selectedBanks.indexOf(bank);
      
      if (idx > -1) {
        selectedBanks.splice(idx, 1);
        btn.classList.remove('selected');
      } else {
        selectedBanks.push(bank);
        btn.classList.add('selected');
      }
      
      // ‚≠ê Render cards ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å/‡∏¢‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      updateFilteredCards();
    }
    
    // ‚≠ê ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ö‡∏±‡∏ï‡∏£‡∏ï‡∏≤‡∏° bank ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    function updateFilteredCards() {
      if (selectedBanks.length === 0) {
        document.getElementById('cardGrid').innerHTML = '<div style="grid-column:1/-1;text-align:center;color:rgba(255,255,255,0.5);font-size:0.8rem;padding:20px;">üëÜ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</div>';
        return;
      }
      
      const filtered = allCards.filter(c => selectedBanks.includes(c.bank));
      renderCards(filtered);
    }
    
    // ‚≠ê ‡∏•‡∏ö loadFilteredCards() ‡∏≠‡∏≠‡∏Å (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß)
    
    function renderCards(cards) {
      window.displayedCards = cards;
      
      // ‚≠ê Debug: ‡∏î‡∏π‡∏ß‡πà‡∏≤ image_url ‡∏°‡∏≤‡πÑ‡∏´‡∏°
      console.log('üé¥ Cards data:', cards.slice(0, 3).map(c => ({ 
        card_type: c.card_type, 
        image_url: c.image_url 
      })));
      
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      let html = cards.map(card => {
        const hasImage = card.image_url && card.image_url.startsWith('http');
        const imgHtml = hasImage 
          ? `<img src="${card.image_url}" class="card-bg-img" onerror="this.style.display='none'">`
          : '';
        const noImageClass = hasImage ? '' : 'no-image';
        const isSelected = selectedCards.some(c => c.card_id === card.card_id);
        const isNew = card.isNew;
        const isExisting = card.isExisting; // ‚≠ê ‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (available = false)
        
        // ‚≠ê Badge ‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
        let badgeHtml = '';
        let deleteBtn = '';
        if (isNew) {
          badgeHtml = `<span class="new-badge">üÜï</span>`;
          deleteBtn = `<button class="delete-btn" onclick="event.stopPropagation(); deleteNewCard('${card.card_id}')">‚úï</button>`;
        } else if (isExisting) {
          badgeHtml = `<span class="new-badge" style="background:#f59e0b;">üìå</span>`;
        }
        
        return `<div class="card-btn ${noImageClass} ${isSelected ? 'selected' : ''}" 
              data-card-id="${card.card_id}"
              onclick="toggleCard('${card.card_id}')">
          ${imgHtml}
          ${badgeHtml}
          ${deleteBtn}
          <div class="card-overlay">
            <div class="card-name">${truncate(card.card_type, 12)}</div>
            <div class="card-last4">${card.last4}</div>
          </div>
          <div class="check-overlay"></div>
        </div>`;
      }).join('');
      
      // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ï‡∏£" ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢
      const remainder = cards.length % 3;
      let spanClass = '';
      if (remainder === 0) spanClass = 'span-3';      // ‡∏¢‡∏≤‡∏ß‡πÄ‡∏ï‡πá‡∏° 3 ‡∏ä‡πà‡∏≠‡∏á
      else if (remainder === 1) spanClass = 'span-2'; // ‡∏¢‡∏≤‡∏ß 2 ‡∏ä‡πà‡∏≠‡∏á
      // remainder === 2 ‚Üí ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á span (1 ‡∏ä‡πà‡∏≠‡∏á)
      
      html += `<div class="add-card-btn ${spanClass}" onclick="openAddCardModal()">
        <span>‚ûï</span>
        <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ï‡∏£</span>
      </div>`;
      
      document.getElementById('cardGrid').innerHTML = html;
      document.getElementById('cardSection').classList.remove('hidden');
    }
    
    function truncate(str, len) {
      if (!str) return '';
      return str.length > len ? str.substring(0, len) + '..' : str;
    }
    
    function toggleCard(cardId) {
      const card = window.displayedCards.find(c => c.card_id === cardId);
      if (!card) return;
      
      const idx = selectedCards.findIndex(c => c.card_id === cardId);
      
      if (idx > -1) {
        selectedCards.splice(idx, 1);
      } else {
        selectedCards.push({ ...card, amount: '' });
      }
      
      // Update UI
      document.querySelectorAll('.card-btn').forEach(btn => {
        const id = btn.dataset.cardId;
        btn.classList.toggle('selected', selectedCards.some(c => c.card_id === id));
      });
      
      updateAmountSection();
    }
    
    function updateAmountSection() {
      const amountSection = document.getElementById('amountSection');
      const extraSection = document.getElementById('extraSection');
      const submitBtn = document.getElementById('submitBtn');
      const toggleLabel = document.getElementById('toggleLabel');
      
      if (selectedCards.length === 0) {
        amountSection.classList.add('hidden');
        extraSection.classList.add('hidden');
        submitBtn.classList.add('hidden');
        return;
      }
      
      amountSection.classList.remove('hidden');
      extraSection.classList.remove('hidden');
      submitBtn.classList.remove('hidden');
      
      // Hide toggle if only 1 card
      if (selectedCards.length <= 1) {
        toggleLabel.classList.add('hidden');
        document.getElementById('sameToggle').checked = false;
      } else {
        toggleLabel.classList.remove('hidden');
      }
      
      toggleSameAmount();
    }
    
    function toggleSameAmount() {
      const isChecked = document.getElementById('sameToggle').checked;
      const sameView = document.getElementById('sameAmountView');
      const separateView = document.getElementById('separateAmountView');
      
      if (isChecked && selectedCards.length > 1) {
        sameView.classList.remove('hidden');
        separateView.classList.add('hidden');
        renderSelectedCardsDisplay();
      } else {
        sameView.classList.add('hidden');
        separateView.classList.remove('hidden');
        renderAmountGrid();
      }
    }
    
    function renderSelectedCardsDisplay() {
      document.getElementById('selectedCardsDisplay').innerHTML = selectedCards.map(card =>
        `<div class="selected-card-tag">
          <div class="name">${truncate(card.card_type, 8)} ${card.last4}</div>
          <div class="owner">${truncate(card.full_name, 12)}</div>
        </div>`
      ).join('');
    }
    
    function renderAmountGrid() {
      document.getElementById('amountGrid').innerHTML = selectedCards.map((card, i) =>
        `<div class="amount-card">
          <div class="card-header">
            <div class="card-info">
              <div class="name">${truncate(card.card_type, 8)} ${card.last4}</div>
              <div class="owner">${truncate(card.full_name, 12)}</div>
            </div>
            <button class="remove-btn" onclick="removeCard(${i})">√ó</button>
          </div>
          <div class="amount-row">
            <input type="tel" class="amount-input" placeholder="0" inputmode="decimal" 
                   data-index="${i}" value="${card.amount}" 
                   oninput="formatAmount(this); updateCardAmount(${i}, this.value)">
            <span class="currency">‡∏ö‡∏≤‡∏ó</span>
          </div>
        </div>`
      ).join('');
    }
    
    function removeCard(index) {
      const card = selectedCards[index];
      selectedCards.splice(index, 1);
      
      const btn = document.querySelector(`.card-btn[data-card-id="${card.card_id}"]`);
      if (btn) btn.classList.remove('selected');
      
      updateAmountSection();
    }
    
    function updateCardAmount(index, value) {
      selectedCards[index].amount = parseNumber(value);
    }
    
    function applyQuickAmount(amount) {
      const isChecked = document.getElementById('sameToggle').checked;
      
      if (isChecked && selectedCards.length > 1) {
        document.getElementById('globalAmount').value = amount.toLocaleString();
      } else {
        document.querySelectorAll('.amount-card .amount-input').forEach((input, i) => {
          input.value = amount.toLocaleString();
          selectedCards[i].amount = amount;
        });
      }
    }
    
    function selectShop(btn, name) {
      document.querySelectorAll('.shop-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      document.getElementById('shopInput').value = name;
    }
    
    function setDefaultDate() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('dateInput').value = today;
    }
    
    function selectDate(btn, type) {
      document.querySelectorAll('.date-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      
      const dateInput = document.getElementById('dateInput');
      const today = new Date();
      
      if (type === 'today') {
        dateInput.value = today.toISOString().split('T')[0];
        dateInput.classList.add('hidden');
      } else if (type === 'yesterday') {
        today.setDate(today.getDate() - 1);
        dateInput.value = today.toISOString().split('T')[0];
        dateInput.classList.add('hidden');
      } else {
        dateInput.classList.remove('hidden');
        dateInput.focus();
      }
    }
    
    // ============ SUBMIT (‡πÑ‡∏õ Apps Script ‚Üí Sheets) ============
    async function submitForm() {
      // Validate
      const isChecked = document.getElementById('sameToggle').checked && selectedCards.length > 1;
      
      if (isChecked) {
        const globalAmount = parseNumber(document.getElementById('globalAmount').value);
        if (!globalAmount || globalAmount <= 0) {
          alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô');
          return;
        }
        selectedCards.forEach(card => card.amount = globalAmount);
      } else {
        const emptyCards = selectedCards.filter(c => !c.amount || c.amount <= 0);
        if (emptyCards.length > 0) {
          alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ö‡∏±‡∏ï‡∏£');
          return;
        }
      }
      
      const dateInput = document.getElementById('dateInput').value;
      const date = formatDateThai(dateInput);
      const shopName = document.getElementById('shopInput').value.trim();
      
      const total = selectedCards.reduce((sum, c) => sum + Number(c.amount), 0);
      if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?\n\n‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${selectedCards.length} ‡∏ö‡∏±‡∏ï‡∏£\n‡∏£‡∏ß‡∏° ‡∏ø${formatDisplayAmount(total)}`)) return;
      
      setLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
      
      try {
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏õ Apps Script (‡πÑ‡∏õ Sheets ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        const response = await fetch(CONFIG.APPS_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({
            action: 'save',
            custId: customerInfo.cust_id,
            entries: selectedCards.map(c => ({
              cardId: c.card_id,
              cardType: c.card_type,
              last4: c.last4,
              fullName: c.full_name,
              typeCode: c.type_code,
              amount: Number(c.amount)
            })),
            shopName: shopName,
            date: date,
            customerInfo: {
              lineUserId: lineProfile.userId,
              displayName: lineProfile.displayName,
              fullName: customerInfo.full_name,
              phone: customerInfo.phone
            }
          })
        });
        
        const result = await response.json();
        hideLoading();
        
        if (result.success) {
          showSuccess(result.data);
        } else {
          alert(result.message || result.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
        }
        
      } catch (error) {
        hideLoading();
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
      }
    }
    
    function showSuccess(data) {
      document.getElementById('mainContent').classList.add('hidden');
      
      let html = '';
      data.entries.forEach(entry => {
        html += `<div class="item"><span>${entry.cardType} ${entry.last4}</span><span>‡∏ø${formatDisplayAmount(entry.amount)}</span></div>`;
      });
      html += `<div class="item total"><span>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span><span>‡∏ø${formatDisplayAmount(data.totalAmount)}</span></div>`;
      
      document.getElementById('successSummary').innerHTML = html;
      document.getElementById('successScreen').classList.remove('hidden');
    }
    
    function resetForm() {
      selectedCards = [];
      selectedBanks = [];
      
      document.getElementById('successScreen').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
      
      document.querySelectorAll('.card-btn').forEach(btn => btn.classList.remove('selected'));
      document.querySelectorAll('.bank-btn').forEach(btn => btn.classList.remove('selected'));
      document.getElementById('globalAmount').value = '';
      document.getElementById('shopInput').value = '';
      document.querySelectorAll('.shop-btn').forEach(b => b.classList.remove('selected'));
      selectDate(document.querySelector('.date-btn[data-type="today"]'), 'today');
      document.getElementById('sameToggle').checked = true;
      
      // ‚≠ê ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï card grid (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ bank selection)
      if (allCards.length > CONFIG.CARD_THRESHOLD) {
        updateFilteredCards();
      }
      
      updateAmountSection();
    }
    
    function closeLiff() {
      console.log('üî¥ closeLiff called');
      
      // ‚≠ê ‡∏ß‡∏¥‡∏ò‡∏µ 1: ‡πÉ‡∏ä‡πâ liff.closeWindow()
      if (typeof liff !== 'undefined' && liff.isInClient()) {
        console.log('üî¥ Using liff.closeWindow()');
        liff.closeWindow();
      }
      
      // ‚≠ê ‡∏ß‡∏¥‡∏ò‡∏µ 2: ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î ‡∏•‡∏≠‡∏á redirect ‡∏´‡∏•‡∏±‡∏á 500ms
      setTimeout(() => {
        console.log('üî¥ Fallback: redirecting...');
        // ‡∏•‡∏≠‡∏á line:// scheme
        window.location.href = 'line://nv/chat';
      }, 500);
      
      // ‚≠ê ‡∏ß‡∏¥‡∏ò‡∏µ 3: ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î ‡∏•‡∏≠‡∏á https scheme ‡∏´‡∏•‡∏±‡∏á 1500ms
      setTimeout(() => {
        window.location.href = 'https://line.me/R/nv/chat';
      }, 1500);
    }
    
    // ============ ADD CARD MODAL ============
    let modalSelectedType = null;
    
    function openAddCardModal() {
      modalSelectedType = null;
      document.getElementById('modalLast4').value = '';
      document.getElementById('modalName').value = customerInfo.name_on_card || customerInfo.full_name || '';
      
      // ‚≠ê ‡∏´‡∏≤ banks ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô dropdown
      let banksToShow = [];
      
      if (selectedBanks.length > 0) {
        // ‡∏°‡∏µ selectedBanks ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£
        banksToShow = selectedBanks;
      } else if (allCards.length > 0) {
        // ‡πÑ‡∏°‡πà‡∏°‡∏µ selectedBanks ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ï‡∏£ ‚Üí ‡∏î‡∏∂‡∏á bank ‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ï‡∏£
        banksToShow = [...new Set(allCards.map(c => c.bank).filter(Boolean))];
      } else {
        // ‚≠ê ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏•‡∏¢ ‚Üí ‡πÉ‡∏ä‡πâ ALLOWED_BANKS ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        banksToShow = CONFIG.ALLOWED_BANKS;
      }
      
      // ‡πÅ‡∏™‡∏î‡∏á dropdown ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 bank ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
      if (banksToShow.length > 1 || allCards.length === 0) {
        document.getElementById('modalBankRow').classList.remove('hidden');
        const select = document.getElementById('modalBankSelect');
        select.innerHTML = banksToShow.map(b => `<option value="${b}">${b}</option>`).join('');
        renderModalCardTypes(banksToShow[0]);
      } else if (banksToShow.length === 1) {
        document.getElementById('modalBankRow').classList.add('hidden');
        renderModalCardTypes(banksToShow[0]);
      }
      
      // Render name suggestions
      renderNameSuggestions();
      
      validateModalForm();
      document.getElementById('addCardModal').classList.remove('hidden');
    }
    
    function closeAddCardModal() {
      document.getElementById('addCardModal').classList.add('hidden');
    }
    
    function onModalBankChange() {
      const bank = document.getElementById('modalBankSelect').value;
      modalSelectedType = null;
      renderModalCardTypes(bank);
      validateModalForm();
    }
    
    function renderModalCardTypes(bank) {
      const types = cardTypes.filter(t => t.bank === bank);
      
      document.getElementById('modalCardGrid').innerHTML = types.map(t => {
        const hasImage = t.image_url && t.image_url.startsWith('http');
        const imgStyle = hasImage ? `background-image: url('${t.image_url}')` : '';
        const noImageClass = hasImage ? '' : 'no-image';
        const isSelected = modalSelectedType === t.card_name;
        const isDisabled = modalSelectedType && !isSelected;
        
        return `<div class="modal-card-btn ${noImageClass} ${isSelected ? 'selected' : ''} ${isDisabled ? 'disabled' : ''}"
              style="${imgStyle}"
              onclick="selectModalCardType('${t.card_name.replace(/'/g, "\\'")}')">
          <div class="card-overlay">
            <div class="card-name">${t.card_name}</div>
          </div>
          <span class="check-mark">‚úì</span>
        </div>`;
      }).join('');
    }
    
    function selectModalCardType(cardName) {
      if (modalSelectedType === cardName) {
        modalSelectedType = null; // Deselect
      } else {
        modalSelectedType = cardName;
      }
      
      // Re-render with updated selection
      const bank = document.getElementById('modalBankSelect')?.value || 
                   (selectedBanks.length === 1 ? selectedBanks[0] : 
                   [...new Set(allCards.map(c => c.bank))][0]);
      renderModalCardTypes(bank);
      validateModalForm();
    }
    
    function renderNameSuggestions() {
      // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ
      const names = [...new Set(allCards.map(c => c.full_name).filter(Boolean))].slice(0, 3);
      
      document.getElementById('modalNameSuggest').innerHTML = names.map(name => {
        // ‚≠ê ‡∏ï‡∏±‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô 15 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£
        const displayName = name.length > 15 ? name.substring(0, 15) + '..' : name;
        return `<button class="modal-suggest-btn" onclick="selectNameSuggestion('${name.replace(/'/g, "\\'")}')" title="${name}">${displayName}</button>`;
      }).join('');
    }
    
    function selectNameSuggestion(name) {
      document.getElementById('modalName').value = name;
      validateModalForm();
    }
    
    function validateModalForm() {
      const last4 = document.getElementById('modalLast4').value.trim();
      const name = document.getElementById('modalName').value.trim();
      const isValid = modalSelectedType && last4.length === 4 && name.length > 0;
      document.getElementById('modalConfirmBtn').disabled = !isValid;
    }
    
    async function confirmAddCard() {
      const last4 = document.getElementById('modalLast4').value.trim();
      const name = document.getElementById('modalName').value.trim();
      
      if (!modalSelectedType || last4.length !== 4 || !name) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
        return;
      }
      
      // ‚≠ê 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏ô allCards ‡∏Å‡πà‡∏≠‡∏ô (‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà available = true)
      const duplicateInUI = allCards.find(c => 
        c.card_type === modalSelectedType && c.last4 === last4
      );
      
      if (duplicateInUI) {
        if (confirm(`‡∏ö‡∏±‡∏ï‡∏£ ${modalSelectedType} ${last4} ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ï‡∏£‡∏ô‡∏µ‡πâ‡πÅ‡∏ó‡∏ô‡πÑ‡∏´‡∏°?`)) {
          if (!selectedCards.some(c => c.card_id === duplicateInUI.card_id)) {
            selectedCards.push({ ...duplicateInUI, amount: '' });
          }
          closeAddCardModal();
          refreshCardGrid();
          updateAmountSection();
        }
        return;
      }
      
      // ‚≠ê 2. Query Supabase ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ö‡∏±‡∏ï‡∏£‡∏ã‡πâ‡∏≥ (‡∏£‡∏ß‡∏° available = false)
      try {
        const { data: existingCard, error } = await sb
          .from('cards')
          .select('*')
          .eq('cust_id', customerInfo.cust_id)
          .eq('card_type', modalSelectedType)
          .eq('last4', last4)
          .maybeSingle();
        
        if (existingCard) {
          // ‚≠ê ‡πÄ‡∏à‡∏≠‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‚Üí ‡πÉ‡∏ä‡πâ card_id ‡πÄ‡∏î‡∏¥‡∏° ‡πÑ‡∏°‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
          console.log('üîç ‡∏û‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö:', existingCard);
          
          const card = {
            ...existingCard,
            full_name: name,  // ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà
            isExisting: true  // flag ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
          };
          
          // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ displayedCards (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ)
          if (!window.displayedCards.some(c => c.card_id === card.card_id)) {
            window.displayedCards.push(card);
          }
          
          // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ selectedCards
          if (!selectedCards.some(c => c.card_id === card.card_id)) {
            selectedCards.push({ ...card, amount: '' });
          }
          
          closeAddCardModal();
          refreshCardGrid();
          updateAmountSection();
          return;
        }
      } catch (e) {
        console.error('Error checking existing card:', e);
      }
      
      // ‚≠ê 3. ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏î‡∏¥‡∏° ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà
      const typeInfo = cardTypes.find(t => t.card_name === modalSelectedType) || {};
      const newCard = {
        card_id: 'NEW_' + Date.now(),
        card_type: modalSelectedType,
        last4: last4,
        full_name: name,
        bank: typeInfo.bank || '',
        type_code: typeInfo.type_code || '',
        image_url: typeInfo.image_url || '',
        isNew: true
      };
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ displayedCards ‡πÅ‡∏•‡∏∞ selectedCards
      window.displayedCards.push(newCard);
      selectedCards.push({ ...newCard, amount: '' });
      
      closeAddCardModal();
      refreshCardGrid();
      updateAmountSection();
    }
    
    function deleteNewCard(cardId) {
      // ‡∏•‡∏ö‡∏à‡∏≤‡∏Å displayedCards
      const idx = window.displayedCards.findIndex(c => c.card_id === cardId);
      if (idx > -1) window.displayedCards.splice(idx, 1);
      
      // ‡∏•‡∏ö‡∏à‡∏≤‡∏Å selectedCards
      const selIdx = selectedCards.findIndex(c => c.card_id === cardId);
      if (selIdx > -1) selectedCards.splice(selIdx, 1);
      
      refreshCardGrid();
      updateAmountSection();
    }
    
    function refreshCardGrid() {
      renderCards(window.displayedCards);
      // Re-apply selection state
      document.querySelectorAll('.card-btn').forEach(btn => {
        const id = btn.dataset.cardId;
        if (id) {
          btn.classList.toggle('selected', selectedCards.some(c => c.card_id === id));
        }
      });
    }
    
    // ============ HELPERS ============
    function formatAmount(input) {
      // ‚≠ê ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°
      let value = input.value.replace(/[^0-9.]/g, '');
      
      // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô . ‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏±‡∏ß
      const parts = value.split('.');
      if (parts.length > 2) {
        value = parts[0] + '.' + parts.slice(1).join('');
      }
      
      // Format ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°
      if (value) {
        let [intPart, decPart] = value.split('.');
        const formattedInt = intPart ? parseInt(intPart).toLocaleString() : '0';
        
        if (decPart !== undefined) {
          // ‚≠ê ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° 2 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
          decPart = decPart.substring(0, 2);
          value = formattedInt + '.' + decPart;
        } else {
          value = formattedInt;
        }
      }
      
      input.value = value;
    }
    
    function parseNumber(str) {
      if (!str) return 0;
      // ‚≠ê ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°
      return parseFloat(String(str).replace(/[^0-9.]/g, '')) || 0;
    }
    
    // ‚≠ê Format ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°‡πÅ‡∏™‡∏î‡∏á 2 ‡∏à‡∏∏‡∏î, ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á
    function formatDisplayAmount(num) {
      if (!num && num !== 0) return '0';
      const n = parseFloat(num);
      if (Number.isInteger(n)) {
        return n.toLocaleString(); // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°
      } else {
        return n.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }
    }
    
    function formatDateThai(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      return d.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }
    
    function setLoading(text) {
      document.getElementById('loadingText').textContent = text;
      document.getElementById('loadingOverlay').classList.remove('hidden');
    }
    
    function hideLoading() {
      document.getElementById('loadingOverlay').classList.add('hidden');
    }
    
    function showError(message) {
      hideLoading();
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('mainContent').classList.add('hidden');
      document.getElementById('errorScreen').classList.remove('hidden');
    }
    
    // ============ START ============
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>