<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>D-SERVE ‡πÅ‡∏à‡πâ‡∏á‡∏¢‡∏≠‡∏î‡∏ô‡∏≠‡∏Å‡∏£‡∏≠‡∏ö</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Prompt', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 12px;
      padding-bottom: 20px;
    }
    
    .container { max-width: 400px; margin: 0 auto; }
    
    /* Header */
    .header {
      text-align: center;
      padding: 6px 0 10px;
      color: #fff;
    }
    .header h1 { font-size: 1rem; font-weight: 600; }
    
    /* Profile */
    .profile-box {
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 10px 12px;
      margin-bottom: 10px;
      border: 1px solid rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .profile-img {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid rgba(255,255,255,0.3);
      flex-shrink: 0;
    }
    
    .profile-info { flex: 1; min-width: 0; }
    
    .profile-row1 {
      font-size: 0.85rem;
      color: #fff;
      font-weight: 600;
    }
    
    .profile-row2 {
      font-size: 0.7rem;
      color: rgba(255,255,255,0.8);
      margin-top: 2px;
    }
    
    /* Section */
    .section-box {
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 10px;
      margin-bottom: 10px;
    }
    
    .section-title {
      font-size: 0.7rem;
      color: rgba(255,255,255,0.7);
      margin-bottom: 8px;
    }
    
    /* Bank Grid - 4 per row */
    .bank-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
    }
    
    .bank-btn {
      padding: 10px 4px;
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-size: 0.7rem;
      font-weight: 600;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .bank-btn:hover { background: rgba(255,255,255,0.2); }
    .bank-btn.selected { background: rgba(0,208,132,0.3); border-color: #00d084; }
    
    /* Card Grid - 3 per row ‚≠ê */
    .card-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    
    .card-btn {
      position: relative;
      aspect-ratio: 1.586; /* ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï */
      border: 3px solid rgba(255,255,255,0.2);
      border-radius: 12px;
      background-color: rgba(255,255,255,0.1);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      cursor: pointer;
      transition: all 0.2s;
      overflow: hidden;
    }
    
    .card-btn:hover { 
      border-color: rgba(255,255,255,0.5);
      transform: scale(1.02);
    }
    
    .card-btn.selected { 
      border-color: #00d084; 
      box-shadow: 0 0 0 2px rgba(0,208,132,0.5);
    }
    
    /* Overlay - ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡∏≤‡∏á‡∏£‡∏π‡∏õ ‚≠ê */
    .card-btn .card-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      background: rgba(0,0,0,0.45);
      padding: 4px;
    }
    
    .card-btn .card-name {
      font-size: 0.65rem;
      color: #fff;
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 95%;
      text-shadow: 0 1px 3px rgba(0,0,0,0.9);
    }
    
    .card-btn .card-last4 {
      font-size: 0.95rem;
      color: #fff;
      font-weight: 700;
      letter-spacing: 2px;
      text-shadow: 0 1px 3px rgba(0,0,0,0.9);
      margin-top: 2px;
    }
    
    /* ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ */
    .card-btn.no-image {
      background: linear-gradient(135deg, #3a3a5c 0%, #2a2a4c 100%);
    }
    
    .card-btn.no-image .card-overlay {
      background: transparent;
    }
    
    /* ‚≠ê ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ö‡∏±‡∏ï‡∏£ */
    .card-btn .card-bg-img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 9px;
    }
    
    /* Amount Section */
    .amount-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .toggle-same {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.7rem;
      color: rgba(255,255,255,0.9);
      cursor: pointer;
    }
    
    .toggle-same input {
      width: 16px;
      height: 16px;
      accent-color: #00d084;
    }
    
    /* Quick Amount - Bigger */
    .quick-btns {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    
    .quick-btn {
      flex: 1;
      padding: 12px 8px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 10px;
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .quick-btn:hover { background: rgba(0,208,132,0.3); border-color: #00d084; }
    
    /* Global Amount (Toggle ON) */
    .global-amount-box {
      background: rgba(0,208,132,0.2);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 10px;
    }
    
    .global-amount-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .global-amount-row label {
      font-size: 0.8rem;
      color: #fff;
      white-space: nowrap;
    }
    
    .amount-input {
      flex: 1;
      padding: 12px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 8px;
      background: rgba(255,255,255,0.15);
      color: #fff;
      font-size: 1.1rem;
      text-align: right;
      font-family: 'Prompt', sans-serif;
    }
    
    .amount-input:focus { outline: none; border-color: #00d084; }
    .amount-input::placeholder { color: rgba(255,255,255,0.4); }
    
    .currency { color: rgba(255,255,255,0.8); font-size: 0.9rem; }
    
    /* Selected Cards Display (Toggle ON) */
    .selected-cards-display {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
    }
    
    .selected-card-tag {
      background: rgba(0,208,132,0.2);
      border: 1px solid rgba(0,208,132,0.4);
      border-radius: 8px;
      padding: 8px;
      text-align: center;
    }
    
    .selected-card-tag .name {
      font-size: 0.75rem;
      color: #fff;
      font-weight: 600;
    }
    
    .selected-card-tag .owner {
      font-size: 0.65rem;
      color: rgba(255,255,255,0.7);
    }
    
    /* Amount Grid (Toggle OFF) - 2 per row */
    .amount-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
    }
    
    .amount-grid.has-odd-last > .amount-card:last-child:nth-child(odd) {
      grid-column: 1 / -1;
    }
    
    .amount-card {
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      padding: 8px;
      min-width: 0;
    }
    
    .amount-card .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 6px;
    }
    
    .amount-card .card-info {
      min-width: 0;
      flex: 1;
    }
    
    .amount-card .card-info .name {
      font-size: 0.75rem;
      color: #fff;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .amount-card .card-info .owner {
      font-size: 0.6rem;
      color: rgba(255,255,255,0.6);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .remove-btn {
      background: rgba(255,100,100,0.3);
      border: none;
      color: #ff6b6b;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 0.8rem;
      line-height: 1;
      flex-shrink: 0;
      margin-left: 4px;
    }
    
    .amount-card .amount-row {
      position: relative;
    }
    
    .amount-card .amount-input {
      width: 100%;
      padding: 10px 35px 10px 10px;
      font-size: 0.95rem;
      text-align: right;
    }
    
    .amount-card .currency {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.75rem;
      color: rgba(255,255,255,0.6);
      pointer-events: none;
    }
    
    /* Date */
    .date-row {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
    }
    
    .date-btn {
      flex: 1;
      padding: 10px;
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      background: transparent;
      color: #fff;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .date-btn.selected { background: rgba(0,208,132,0.3); border-color: #00d084; }
    
    /* Shop */
    .shop-suggestions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    
    .shop-btn {
      padding: 8px 14px;
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 16px;
      background: transparent;
      color: #fff;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .shop-btn:hover, .shop-btn.selected { background: rgba(0,208,132,0.3); border-color: #00d084; }
    
    .shop-input {
      width: 100%;
      padding: 10px;
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-size: 0.85rem;
      font-family: 'Prompt', sans-serif;
    }
    
    .shop-input::placeholder { color: rgba(255,255,255,0.4); }
    .shop-input:focus { outline: none; border-color: #00d084; }
    
    /* Submit */
    .submit-btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 12px;
      background: linear-gradient(135deg, #00d084, #00b894);
      color: #fff;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Prompt', sans-serif;
      transition: all 0.2s;
    }
    
    .submit-btn:hover { transform: translateY(-1px); }
    .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .load-cards-btn {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(135deg, #00d084, #00b894);
      color: #fff;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Prompt', sans-serif;
    }
    
    /* Loading */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .loading-overlay.hidden { display: none; }
    
    .loading-content { text-align: center; color: #fff; }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255,255,255,0.3);
      border-top-color: #00d084;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 12px;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Error */
    .error-box {
      background: rgba(255,100,100,0.2);
      border: 1px solid rgba(255,100,100,0.4);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    
    .error-box .icon { font-size: 2rem; margin-bottom: 10px; }
    .error-box .title { font-size: 1rem; color: #fff; font-weight: 600; margin-bottom: 5px; }
    .error-box .message { font-size: 0.8rem; color: rgba(255,255,255,0.8); }
    
    /* Success */
    .success-box {
      background: rgba(0,208,132,0.2);
      border: 1px solid rgba(0,208,132,0.4);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    
    .success-box .icon { font-size: 2.5rem; margin-bottom: 10px; }
    .success-box .title { font-size: 1.1rem; color: #fff; font-weight: 600; margin-bottom: 10px; }
    
    .success-summary {
      text-align: left;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      padding: 12px;
      margin: 10px 0;
    }
    
    .success-summary .item {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      font-size: 0.8rem;
      color: rgba(255,255,255,0.9);
    }
    
    .success-summary .total {
      border-top: 1px solid rgba(255,255,255,0.2);
      margin-top: 8px;
      padding-top: 8px;
      font-weight: 600;
    }
    
    .btn-group {
      display: flex;
      gap: 8px;
      margin-top: 15px;
    }
    
    .btn-secondary {
      flex: 1;
      padding: 12px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 10px;
      background: transparent;
      color: #fff;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Prompt', sans-serif;
    }
    
    /* Speed indicator */
    .speed-badge {
      display: inline-block;
      padding: 2px 8px;
      background: rgba(0,208,132,0.3);
      border-radius: 10px;
      font-size: 0.6rem;
      color: #00d084;
      margin-left: 8px;
    }
    
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>üí≥ D-SERVE ‡πÅ‡∏à‡πâ‡∏á‡∏¢‡∏≠‡∏î‡∏ô‡∏≠‡∏Å‡∏£‡∏≠‡∏ö <span class="speed-badge">‚ö° Supabase</span></h1>
    </div>
    
    <!-- Error Screen -->
    <div id="errorScreen" class="section-box hidden">
      <div class="error-box">
        <div class="icon">‚ùå</div>
        <div class="title">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</div>
        <div class="message" id="errorMessage">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</div>
      </div>
    </div>
    
    <!-- Success Screen -->
    <div id="successScreen" class="section-box hidden">
      <div class="success-box">
        <div class="icon">‚úÖ</div>
        <div class="title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>
        <div class="success-summary" id="successSummary"></div>
        <div class="btn-group">
          <button class="btn-secondary" onclick="resetForm()">üîÑ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</button>
          <button class="btn-secondary" onclick="closeLiff()">‚úï ‡∏õ‡∏¥‡∏î</button>
        </div>
      </div>
    </div>
    
    <!-- Main Content -->
    <div id="mainContent">
      <!-- Profile -->
      <div id="profileSection" class="profile-box hidden">
        <img id="profileImg" class="profile-img" src="" onerror="this.src='https://via.placeholder.com/44/666/fff?text=üë§'">
        <div class="profile-info">
          <div class="profile-row1" id="profileRow1">-</div>
          <div class="profile-row2" id="profileRow2">-</div>
        </div>
      </div>
      
      <!-- Bank Selection (>8 cards) -->
      <div id="bankSection" class="section-box hidden">
        <div class="section-title">üè¶ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ (‡∏Å‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£)</div>
        <div class="bank-grid" id="bankGrid"></div>
      </div>
      
      <!-- Card Selection -->
      <div id="cardSection" class="section-box hidden">
        <div class="section-title">üí≥ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ï‡∏£</div>
        <div class="card-grid" id="cardGrid"></div>
      </div>
      
      <!-- Amount Entry -->
      <div id="amountSection" class="section-box hidden">
        <div class="amount-header">
          <div class="section-title" style="margin:0;">üí∞ ‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î</div>
          <label class="toggle-same" id="toggleLabel">
            <input type="checkbox" id="sameToggle" checked onchange="toggleSameAmount()">
            <span>‡∏¢‡∏≠‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô</span>
          </label>
        </div>
        
        <!-- Quick Amount -->
        <div class="quick-btns" id="quickBtns">
          <button class="quick-btn" onclick="applyQuickAmount(5000)">‡∏ø5,000</button>
          <button class="quick-btn" onclick="applyQuickAmount(10000)">‡∏ø10,000</button>
          <button class="quick-btn" onclick="applyQuickAmount(15000)">‡∏ø15,000</button>
        </div>
        
        <!-- Toggle ON: Single input + card tags -->
        <div id="sameAmountView">
          <div class="global-amount-box">
            <div class="global-amount-row">
              <label>‡∏¢‡∏≠‡∏î‡∏ó‡∏∏‡∏Å‡πÉ‡∏ö:</label>
              <input type="tel" id="globalAmount" class="amount-input" placeholder="0" inputmode="decimal" oninput="formatAmount(this)">
              <span class="currency">‡∏ö‡∏≤‡∏ó</span>
            </div>
          </div>
          <div class="selected-cards-display" id="selectedCardsDisplay"></div>
        </div>
        
        <!-- Toggle OFF: Individual inputs -->
        <div id="separateAmountView" class="hidden">
          <div class="amount-grid has-odd-last" id="amountGrid"></div>
        </div>
      </div>
      
      <!-- Date & Shop -->
      <div id="extraSection" class="section-box hidden">
        <div class="section-title">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏î</div>
        <div class="date-row">
          <button class="date-btn selected" data-type="today" onclick="selectDate(this,'today')">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
          <button class="date-btn" data-type="yesterday" onclick="selectDate(this,'yesterday')">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô</button>
          <button class="date-btn" data-type="custom" onclick="selectDate(this,'custom')">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏á</button>
        </div>
        <input type="date" id="dateInput" class="shop-input hidden" style="margin-bottom:10px;">
        
        <div class="section-title">üè™ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</div>
        <div class="shop-suggestions" id="shopSuggestions"></div>
        <input type="text" id="shopInput" class="shop-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤...">
      </div>
      
      <!-- Submit -->
      <button id="submitBtn" class="submit-btn hidden" onclick="submitForm()">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>
  </div>
  
  <!-- Loading -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div id="loadingText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </div>
  </div>

  <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ‚ö†Ô∏è CONFIG - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ!
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const CONFIG = {
      // LINE LIFF
      LIFF_ID: '2008957662-eSzXKJNi',
      
      // Supabase (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• - ‡πÄ‡∏£‡πá‡∏ß!)
      SUPABASE_URL: 'https://momguihyvsjuexpficdf.supabase.co',
      SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1vbWd1aWh5dnNqdWV4cGZpY2RmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxODQ0ODUsImV4cCI6MjA4NDc2MDQ4NX0.nkdyabWT39acE9ib_BEsTXcKsDpal_myX9PbLvHUnlk',
      
      // Apps Script (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å - ‡πÑ‡∏õ Sheets ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
      APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbyghkPL3lSsZpm_DKZz78f2MseanH8HUQ92CfaVb6r3MvCs1TgUcXhdm9sX-JiI7t_Z/exec',
      
      // Threshold
      CARD_THRESHOLD: 8,
      
      // ‚≠ê Allowed Banks (‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏Ñ‡πà‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
      ALLOWED_BANKS: ['KCC', 'KFV', 'LOTUS', 'THE1', 'KBANK', 'SCB', 'TTB', 'UOB']
    };
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    // Supabase Client
    let sb;
    
    // State
    let lineProfile = null;
    let customerInfo = null;
    let allCards = [];
    let selectedBanks = [];
    let selectedCards = [];
    let recentAmounts = [5000, 10000, 15000]; // ‚≠ê Default values
    let recentShops = []; // ‚≠ê ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    
    // ============ INIT ============
    async function init() {
      const startTime = performance.now();
      
      try {
        // Check config
        if (CONFIG.LIFF_ID === 'YOUR_LIFF_ID_HERE') {
          showError('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LIFF_ID');
          return;
        }
        if (CONFIG.SUPABASE_URL === 'https://YOUR_PROJECT_ID.supabase.co') {
          showError('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ SUPABASE_URL');
          return;
        }
        
        // Init Supabase
        sb = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        
        setLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE...');
        await liff.init({ liffId: CONFIG.LIFF_ID });
        
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        
        // Get LINE profile
        lineProfile = await liff.getProfile();
        
        // ‚ö° Query ‡∏à‡∏≤‡∏Å Supabase (‡πÄ‡∏£‡πá‡∏ß‡∏°‡∏≤‡∏Å!)
        setLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
        
        // Query user
        const { data: userData, error: userError } = await sb
          .from('users')
          .select('*')
          .eq('line_user_id', lineProfile.userId)
          .single();
        
        if (userError || !userData) {
          showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Admin');
          return;
        }
        
        customerInfo = userData;
        
        // Query cards
        const { data: cardsData, error: cardsError } = await sb
          .from('cards')
          .select('*')
          .eq('cust_id', customerInfo.cust_id)
          .eq('available', true);
        
        if (cardsError) {
          console.error('Cards error:', cardsError);
        }
        
        // ‚≠ê ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ banks ‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï
        allCards = (cardsData || []).filter(card => 
          CONFIG.ALLOWED_BANKS.includes(card.bank)
        );
        
        // ‚≠ê ‡∏î‡∏∂‡∏á Recent Data (‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡∏∞‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î) ‡πÅ‡∏ö‡∏ö Background
        loadRecentData(customerInfo.cust_id);
        
        // Render UI
        renderProfile();
        setDefaultDate();
        
        // Check if need bank selection
        if (allCards.length > CONFIG.CARD_THRESHOLD) {
          renderBankSelection();
        } else {
          renderCards(allCards);
        }
        
        hideLoading();
        
        // Log performance
        const endTime = performance.now();
        console.log(`‚ö° Load time: ${Math.round(endTime - startTime)}ms`);
        
      } catch (error) {
        console.error('Init error:', error);
        showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
      }
    }
    
    // ============ RECENT DATA (‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡∏∞‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î) ============
    /**
     * ‚≠ê ‡∏î‡∏∂‡∏á‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡∏∞‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Supabase (Background)
     */
    async function loadRecentData(custId) {
      try {
        const { data, error } = await sb
          .from('extra')
          .select('amount, shop_name')
          .eq('cust_id', custId)
          .order('timestamp', { ascending: false })
          .limit(20);
        
        if (error) {
          console.error('Recent data error:', error);
          return;
        }
        
        if (!data || data.length === 0) {
          console.log('No recent data found');
          return;
        }
        
        // ‡∏î‡∏∂‡∏á 3 ‡∏¢‡∏≠‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥
        const seenAmounts = new Set();
        const amounts = [];
        for (const row of data) {
          const amount = Number(row.amount);
          if (amount > 0 && !seenAmounts.has(amount) && amounts.length < 3) {
            amounts.push(amount);
            seenAmounts.add(amount);
          }
        }
        
        // ‡∏î‡∏∂‡∏á 3 ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥
        const seenShops = new Set();
        const shops = [];
        for (const row of data) {
          const shop = String(row.shop_name || '').trim();
          if (shop && !seenShops.has(shop.toLowerCase()) && shops.length < 3) {
            shops.push(shop);
            seenShops.add(shop.toLowerCase());
          }
        }
        
        // Update state
        if (amounts.length > 0) recentAmounts = amounts;
        if (shops.length > 0) recentShops = shops;
        
        // Render UI
        renderQuickAmounts();
        renderShopSuggestions();
        
        console.log('‚úÖ Recent data loaded:', { amounts, shops });
        
      } catch (error) {
        console.error('loadRecentData error:', error);
      }
    }
    
    /**
     * ‚≠ê Render Quick Amount buttons
     */
    function renderQuickAmounts() {
      const container = document.getElementById('quickBtns');
      if (!container) return;
      
      container.innerHTML = recentAmounts.map(amount =>
        `<button class="quick-btn" onclick="applyQuickAmount(${amount})">‡∏ø${amount.toLocaleString()}</button>`
      ).join('');
    }
    
    /**
     * ‚≠ê Render Shop Suggestions
     */
    function renderShopSuggestions() {
      const container = document.getElementById('shopSuggestions');
      if (!container) return;
      
      if (recentShops.length === 0) {
        container.innerHTML = '';
        return;
      }
      
      container.innerHTML = recentShops.map(shop =>
        `<button class="shop-btn" onclick="selectShop(this, '${shop.replace(/'/g, "\\'")}')">${shop}</button>`
      ).join('');
    }
    
    // ============ RENDER ============
    function renderProfile() {
      document.getElementById('profileImg').src = lineProfile.pictureUrl || '';
      document.getElementById('profileRow1').textContent = `${customerInfo.cust_id} | ${lineProfile.displayName}`;
      document.getElementById('profileRow2').textContent = customerInfo.full_name || customerInfo.name_on_card || '-';
      document.getElementById('profileSection').classList.remove('hidden');
    }
    
    function renderBankSelection() {
      const banks = [...new Set(allCards.map(c => c.bank).filter(Boolean))];
      document.getElementById('bankGrid').innerHTML = banks.map(bank =>
        `<button class="bank-btn" data-bank="${bank}" onclick="toggleBank('${bank}')">${bank}</button>`
      ).join('');
      document.getElementById('bankSection').classList.remove('hidden');
      
      // ‚≠ê ‡πÅ‡∏™‡∏î‡∏á Card Section ‡∏î‡πâ‡∏ß‡∏¢ (‡∏ß‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô)
      document.getElementById('cardSection').classList.remove('hidden');
      document.getElementById('cardGrid').innerHTML = '<div style="grid-column:1/-1;text-align:center;color:rgba(255,255,255,0.5);font-size:0.8rem;padding:20px;">üëÜ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</div>';
    }
    
    function toggleBank(bank) {
      const btn = document.querySelector(`.bank-btn[data-bank="${bank}"]`);
      const idx = selectedBanks.indexOf(bank);
      
      if (idx > -1) {
        selectedBanks.splice(idx, 1);
        btn.classList.remove('selected');
      } else {
        selectedBanks.push(bank);
        btn.classList.add('selected');
      }
      
      // ‚≠ê Render cards ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å/‡∏¢‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      updateFilteredCards();
    }
    
    // ‚≠ê ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ö‡∏±‡∏ï‡∏£‡∏ï‡∏≤‡∏° bank ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    function updateFilteredCards() {
      if (selectedBanks.length === 0) {
        document.getElementById('cardGrid').innerHTML = '<div style="grid-column:1/-1;text-align:center;color:rgba(255,255,255,0.5);font-size:0.8rem;padding:20px;">üëÜ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</div>';
        return;
      }
      
      const filtered = allCards.filter(c => selectedBanks.includes(c.bank));
      renderCards(filtered);
    }
    
    // ‚≠ê ‡∏•‡∏ö loadFilteredCards() ‡∏≠‡∏≠‡∏Å (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß)
    
    function renderCards(cards) {
      window.displayedCards = cards;
      
      // ‚≠ê Debug: ‡∏î‡∏π‡∏ß‡πà‡∏≤ image_url ‡∏°‡∏≤‡πÑ‡∏´‡∏°
      console.log('üé¥ Cards data:', cards.slice(0, 3).map(c => ({ 
        card_type: c.card_type, 
        image_url: c.image_url 
      })));
      
      document.getElementById('cardGrid').innerHTML = cards.map(card => {
        const hasImage = card.image_url && card.image_url.startsWith('http');
        
        // ‚≠ê ‡πÉ‡∏ä‡πâ <img> tag ‡πÅ‡∏ó‡∏ô background-image (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ CORS)
        const imgHtml = hasImage 
          ? `<img src="${card.image_url}" class="card-bg-img" onerror="this.style.display='none'">`
          : '';
        const noImageClass = hasImage ? '' : 'no-image';
        
        return `<div class="card-btn ${noImageClass} ${selectedCards.some(c => c.card_id === card.card_id) ? 'selected' : ''}" 
              data-card-id="${card.card_id}"
              onclick="toggleCard('${card.card_id}')">
          ${imgHtml}
          <div class="card-overlay">
            <div class="card-name">${truncate(card.card_type, 12)}</div>
            <div class="card-last4">${card.last4}</div>
          </div>
        </div>`;
      }).join('');
      
      document.getElementById('cardSection').classList.remove('hidden');
    }
    
    function truncate(str, len) {
      if (!str) return '';
      return str.length > len ? str.substring(0, len) + '..' : str;
    }
    
    function toggleCard(cardId) {
      const card = window.displayedCards.find(c => c.card_id === cardId);
      if (!card) return;
      
      const idx = selectedCards.findIndex(c => c.card_id === cardId);
      
      if (idx > -1) {
        selectedCards.splice(idx, 1);
      } else {
        selectedCards.push({ ...card, amount: '' });
      }
      
      // Update UI
      document.querySelectorAll('.card-btn').forEach(btn => {
        const id = btn.dataset.cardId;
        btn.classList.toggle('selected', selectedCards.some(c => c.card_id === id));
      });
      
      updateAmountSection();
    }
    
    function updateAmountSection() {
      const amountSection = document.getElementById('amountSection');
      const extraSection = document.getElementById('extraSection');
      const submitBtn = document.getElementById('submitBtn');
      const toggleLabel = document.getElementById('toggleLabel');
      
      if (selectedCards.length === 0) {
        amountSection.classList.add('hidden');
        extraSection.classList.add('hidden');
        submitBtn.classList.add('hidden');
        return;
      }
      
      amountSection.classList.remove('hidden');
      extraSection.classList.remove('hidden');
      submitBtn.classList.remove('hidden');
      
      // Hide toggle if only 1 card
      if (selectedCards.length <= 1) {
        toggleLabel.classList.add('hidden');
        document.getElementById('sameToggle').checked = false;
      } else {
        toggleLabel.classList.remove('hidden');
      }
      
      toggleSameAmount();
    }
    
    function toggleSameAmount() {
      const isChecked = document.getElementById('sameToggle').checked;
      const sameView = document.getElementById('sameAmountView');
      const separateView = document.getElementById('separateAmountView');
      
      if (isChecked && selectedCards.length > 1) {
        sameView.classList.remove('hidden');
        separateView.classList.add('hidden');
        renderSelectedCardsDisplay();
      } else {
        sameView.classList.add('hidden');
        separateView.classList.remove('hidden');
        renderAmountGrid();
      }
    }
    
    function renderSelectedCardsDisplay() {
      document.getElementById('selectedCardsDisplay').innerHTML = selectedCards.map(card =>
        `<div class="selected-card-tag">
          <div class="name">${truncate(card.card_type, 8)} ${card.last4}</div>
          <div class="owner">${truncate(card.full_name, 12)}</div>
        </div>`
      ).join('');
    }
    
    function renderAmountGrid() {
      document.getElementById('amountGrid').innerHTML = selectedCards.map((card, i) =>
        `<div class="amount-card">
          <div class="card-header">
            <div class="card-info">
              <div class="name">${truncate(card.card_type, 8)} ${card.last4}</div>
              <div class="owner">${truncate(card.full_name, 12)}</div>
            </div>
            <button class="remove-btn" onclick="removeCard(${i})">√ó</button>
          </div>
          <div class="amount-row">
            <input type="tel" class="amount-input" placeholder="0" inputmode="decimal" 
                   data-index="${i}" value="${card.amount}" 
                   oninput="formatAmount(this); updateCardAmount(${i}, this.value)">
            <span class="currency">‡∏ö‡∏≤‡∏ó</span>
          </div>
        </div>`
      ).join('');
    }
    
    function removeCard(index) {
      const card = selectedCards[index];
      selectedCards.splice(index, 1);
      
      const btn = document.querySelector(`.card-btn[data-card-id="${card.card_id}"]`);
      if (btn) btn.classList.remove('selected');
      
      updateAmountSection();
    }
    
    function updateCardAmount(index, value) {
      selectedCards[index].amount = parseNumber(value);
    }
    
    function applyQuickAmount(amount) {
      const isChecked = document.getElementById('sameToggle').checked;
      
      if (isChecked && selectedCards.length > 1) {
        document.getElementById('globalAmount').value = amount.toLocaleString();
      } else {
        document.querySelectorAll('.amount-card .amount-input').forEach((input, i) => {
          input.value = amount.toLocaleString();
          selectedCards[i].amount = amount;
        });
      }
    }
    
    function selectShop(btn, name) {
      document.querySelectorAll('.shop-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      document.getElementById('shopInput').value = name;
    }
    
    function setDefaultDate() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('dateInput').value = today;
    }
    
    function selectDate(btn, type) {
      document.querySelectorAll('.date-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      
      const dateInput = document.getElementById('dateInput');
      const today = new Date();
      
      if (type === 'today') {
        dateInput.value = today.toISOString().split('T')[0];
        dateInput.classList.add('hidden');
      } else if (type === 'yesterday') {
        today.setDate(today.getDate() - 1);
        dateInput.value = today.toISOString().split('T')[0];
        dateInput.classList.add('hidden');
      } else {
        dateInput.classList.remove('hidden');
        dateInput.focus();
      }
    }
    
    // ============ SUBMIT (‡πÑ‡∏õ Apps Script ‚Üí Sheets) ============
    async function submitForm() {
      // Validate
      const isChecked = document.getElementById('sameToggle').checked && selectedCards.length > 1;
      
      if (isChecked) {
        const globalAmount = parseNumber(document.getElementById('globalAmount').value);
        if (!globalAmount || globalAmount <= 0) {
          alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô');
          return;
        }
        selectedCards.forEach(card => card.amount = globalAmount);
      } else {
        const emptyCards = selectedCards.filter(c => !c.amount || c.amount <= 0);
        if (emptyCards.length > 0) {
          alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ö‡∏±‡∏ï‡∏£');
          return;
        }
      }
      
      const dateInput = document.getElementById('dateInput').value;
      const date = formatDateThai(dateInput);
      const shopName = document.getElementById('shopInput').value.trim();
      
      const total = selectedCards.reduce((sum, c) => sum + Number(c.amount), 0);
      if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?\n\n‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${selectedCards.length} ‡∏ö‡∏±‡∏ï‡∏£\n‡∏£‡∏ß‡∏° ‡∏ø${total.toLocaleString()}`)) return;
      
      setLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
      
      try {
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏õ Apps Script (‡πÑ‡∏õ Sheets ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        const response = await fetch(CONFIG.APPS_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({
            action: 'save',
            custId: customerInfo.cust_id,
            entries: selectedCards.map(c => ({
              cardId: c.card_id,
              cardType: c.card_type,
              last4: c.last4,
              fullName: c.full_name,
              typeCode: c.type_code,
              amount: Number(c.amount)
            })),
            shopName: shopName,
            date: date,
            customerInfo: {
              lineUserId: lineProfile.userId,
              displayName: lineProfile.displayName,
              fullName: customerInfo.full_name,
              phone: customerInfo.phone
            }
          })
        });
        
        const result = await response.json();
        hideLoading();
        
        if (result.success) {
          showSuccess(result.data);
        } else {
          alert(result.message || result.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
        }
        
      } catch (error) {
        hideLoading();
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
      }
    }
    
    function showSuccess(data) {
      document.getElementById('mainContent').classList.add('hidden');
      
      let html = '';
      data.entries.forEach(entry => {
        html += `<div class="item"><span>${entry.cardType} ${entry.last4}</span><span>‡∏ø${Number(entry.amount).toLocaleString()}</span></div>`;
      });
      html += `<div class="item total"><span>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span><span>‡∏ø${Number(data.totalAmount).toLocaleString()}</span></div>`;
      
      document.getElementById('successSummary').innerHTML = html;
      document.getElementById('successScreen').classList.remove('hidden');
    }
    
    function resetForm() {
      selectedCards = [];
      selectedBanks = [];
      
      document.getElementById('successScreen').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
      
      document.querySelectorAll('.card-btn').forEach(btn => btn.classList.remove('selected'));
      document.querySelectorAll('.bank-btn').forEach(btn => btn.classList.remove('selected'));
      document.getElementById('globalAmount').value = '';
      document.getElementById('shopInput').value = '';
      document.querySelectorAll('.shop-btn').forEach(b => b.classList.remove('selected'));
      selectDate(document.querySelector('.date-btn[data-type="today"]'), 'today');
      document.getElementById('sameToggle').checked = true;
      
      // ‚≠ê ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï card grid (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ bank selection)
      if (allCards.length > CONFIG.CARD_THRESHOLD) {
        updateFilteredCards();
      }
      
      updateAmountSection();
    }
    
    function closeLiff() {
      if (liff.isInClient()) {
        liff.closeWindow();
      } else {
        window.close();
      }
    }
    
    // ============ HELPERS ============
    function formatAmount(input) {
      let value = input.value.replace(/[^0-9]/g, '');
      if (value) value = parseInt(value).toLocaleString();
      input.value = value;
    }
    
    function parseNumber(str) {
      if (!str) return 0;
      return parseInt(String(str).replace(/[^0-9]/g, '')) || 0;
    }
    
    function formatDateThai(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      return d.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }
    
    function setLoading(text) {
      document.getElementById('loadingText').textContent = text;
      document.getElementById('loadingOverlay').classList.remove('hidden');
    }
    
    function hideLoading() {
      document.getElementById('loadingOverlay').classList.add('hidden');
    }
    
    function showError(message) {
      hideLoading();
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('mainContent').classList.add('hidden');
      document.getElementById('errorScreen').classList.remove('hidden');
    }
    
    // ============ START ============
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>